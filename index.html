<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>TeaTrade Exchange | Global Tea Market Terminal</title>
    <link rel="icon" type="image/png" href="images/favicon-nb.png">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-card: #151d2b;
            --border: #2d3a4f;
            --border-light: #374357;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-blue: #1a73e8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --ticker-bg: #0f1419;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--accent-blue);
        }

        .nav-links {
            display: flex;
            gap: 24px;
            margin-left: auto;
            margin-right: 32px;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--text-primary);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .market-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.closed {
            background: var(--accent-red);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Ticker Strip */
        .ticker-strip {
            background: var(--ticker-bg);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            height: 36px;
        }

        .ticker-track {
            display: flex;
            animation: scroll 25s linear infinite;
            height: 100%;
            align-items: center;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 24px;
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .ticker-symbol {
            color: var(--text-primary);
            font-weight: 600;
        }

        .ticker-price {
            color: var(--text-secondary);
        }

        .ticker-change.up {
            color: var(--accent-green);
        }

        .ticker-change.down {
            color: var(--accent-red);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1px;
            background: var(--border);
            min-height: calc(100vh - 85px);
        }

        .main-grid > * {
            min-height: 100%;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-section:last-child {
            flex: 1;
            margin-bottom: 0;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .watchlist-item:hover {
            border-color: var(--border-light);
            background: var(--bg-tertiary);
        }

        .watchlist-name {
            font-weight: 500;
            font-size: 13px;
        }

        .watchlist-grade {
            font-size: 11px;
            color: var(--text-muted);
        }

        .watchlist-price {
            text-align: right;
        }

        .watchlist-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
        }

        .watchlist-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .up { color: var(--accent-green); font-weight: 600; }
        .down { color: var(--accent-red); font-weight: 600; }

        /* IB Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
        }
        
        .chat-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .chat-online {
            font-size: 10px;
            color: var(--accent-green);
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-light) var(--bg-tertiary);
            padding-right: 4px;
            max-height: 280px;
            min-height: 150px;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        .chat-message {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .chat-message:last-child {
            border-bottom: none;
        }
        
        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .chat-sender {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-blue);
        }
        
        .chat-sender.system {
            color: var(--accent-orange);
        }
        
        .chat-time {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .chat-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .chat-input-container {
            margin-top: 8px;
            padding-right: 6px;
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0 10px;
            height: 28px;
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
            box-sizing: border-box;
            max-width: calc(100% - 80px);
        }
        
        .chat-input:focus {
            border-color: var(--accent-blue);
        }
        
        .chat-input::placeholder {
            color: var(--text-muted);
        }
        
        .chat-send {
            background: var(--accent-blue);
            border: none;
            border-radius: 4px;
            padding: 0 12px;
            height: 28px;
            cursor: pointer;
            color: white;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }
        
        .chat-send:hover {
            background: #1557b0;
        }
        
        .chat-blast {
            background: var(--accent-orange);
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            padding: 0;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        .chat-blast svg {
            width: 14px;
            height: 14px;
        }
        
        .chat-blast:hover {
            background: #d97706;
        }
        
        /* Private message styling */
        .chat-message.private {
            background: rgba(147, 51, 234, 0.1);
            border-left: 2px solid var(--accent-purple, #9333ea);
            padding-left: 8px;
            margin-left: -8px;
        }
        
        .chat-message.private .chat-sender {
            color: var(--accent-purple, #9333ea);
        }
        
        .chat-message.private .chat-text::before {
            content: 'ðŸ”’ ';
            font-size: 10px;
        }
        
        .chat-message.own {
            background: rgba(26, 115, 232, 0.1);
            border-left: 2px solid var(--accent-blue);
            padding-left: 8px;
            margin-left: -8px;
        }
        
        .chat-sender.dm-target {
            color: var(--accent-purple, #9333ea);
        }
        
        .chat-sender.dm-target::before {
            content: 'â†’ ';
        }

        /* Center Content */
        .center-content {
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        /* Chart Section */
        .chart-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .chart-title {
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .chart-title h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }

        .chart-badge {
            padding: 3px 8px;
            background: var(--accent-blue);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Timeframe Dropdown */
        .timeframe-dropdown {
            position: relative;
        }
        
        .timeframe-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .timeframe-btn:hover {
            border-color: var(--accent-blue);
        }
        
        .timeframe-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 0;
            min-width: 80px;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .timeframe-menu.visible {
            display: block;
        }
        
        .timeframe-item {
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .timeframe-item:hover {
            background: var(--bg-tertiary);
        }
        
        .timeframe-item.active {
            color: var(--accent-blue);
            background: rgba(26, 115, 232, 0.1);
        }

        .chart-stats {
            display: flex;
            gap: 32px;
            margin-top: 8px;
        }

        .chart-stat {
            text-align: left;
        }

        .chart-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
        }

        .chart-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }

        .chart-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-btn:hover, .chart-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .chart-type-toggle {
            display: flex;
            gap: 4px;
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .chart-type-btn {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chart-type-btn:hover, .chart-type-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .chart-type-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Studies Dropdown */
        .studies-dropdown {
            position: relative;
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .studies-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .studies-btn:hover {
            background: var(--bg-card);
            border-color: var(--border-light);
        }

        .studies-btn.has-active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .studies-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .studies-menu.visible {
            display: block;
        }

        .studies-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .studies-item:hover {
            background: var(--bg-tertiary);
        }

        .studies-item-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .studies-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        .studies-toggle {
            width: 36px;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .studies-toggle.active {
            background: var(--accent-blue);
        }

        .studies-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .studies-toggle.active::after {
            left: 18px;
        }

        /* Price Alert Bell */
        .price-alert-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .price-alert-btn:hover {
            color: var(--accent-orange);
            background: rgba(245, 158, 11, 0.1);
        }

        .price-alert-btn.has-alert {
            color: var(--accent-orange);
        }

        .price-alert-btn svg {
            width: 16px;
            height: 16px;
        }

        /* SL/TP Inputs */
        .sltp-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            overflow: hidden;
        }

        .sltp-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
            position: relative;
        }

        .sltp-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .sltp-label .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .sltp-label .dot.sl {
            background: var(--accent-red);
        }

        .sltp-label .dot.tp {
            background: var(--accent-green);
        }

        .sltp-input {
            padding: 6px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            width: 100%;
            box-sizing: border-box;
            -moz-appearance: textfield;
        }
        
        .sltp-input::-webkit-outer-spin-button,
        .sltp-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .sltp-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .sltp-input-wrapper input {
            padding-right: 28px;
        }
        
        .sltp-arrows {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .sltp-arrow {
            width: 18px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s;
            padding: 0;
        }
        
        .sltp-arrow:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        .sltp-arrow svg {
            width: 10px;
            height: 10px;
        }

        .sltp-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .sltp-input::placeholder {
            color: var(--text-muted);
        }

        .chart-container {
            height: 280px;
            background: var(--bg-card);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        /* RSI Sub-Chart */
        .rsi-chart-container {
            height: 80px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 8px;
            padding: 8px 0;
            position: relative;
        }
        
        .rsi-header {
            position: absolute;
            top: 8px;
            left: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 5;
        }
        
        .rsi-label {
            font-size: 10px;
            font-weight: 600;
            color: #ec4899;
            text-transform: uppercase;
        }
        
        .rsi-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .rsi-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        .rsi-crosshair {
            position: absolute;
            pointer-events: none;
            display: none;
        }
        
        .rsi-crosshair .crosshair-v {
            position: absolute;
            top: 0;
            width: 1px;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .rsi-crosshair .crosshair-h {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .rsi-tooltip {
            position: absolute;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 10;
            white-space: nowrap;
        }
        
        .rsi-tooltip.visible {
            opacity: 1;
        }
        
        /* Market Depth Heatmap */
        .market-depth-container {
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 8px;
            padding: 12px;
        }
        
        .market-depth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .market-depth-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .market-depth-ratio {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .market-depth-bar {
            height: 24px;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        .depth-bids {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.6));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 8px;
        }
        
        .depth-asks {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.6), rgba(239, 68, 68, 0.3));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }
        
        .depth-label {
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .market-depth-levels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 9px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Watchlist Tabs */
        .watchlist-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        
        .watchlist-tab {
            flex: 1;
            padding: 6px 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--bg-card);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .watchlist-tab:hover {
            color: var(--text-primary);
        }
        
        .watchlist-tab.active {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Macro Indicators */
        .macro-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .macro-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .macro-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .macro-icon.currency { background: rgba(59, 130, 246, 0.2); }
        .macro-icon.oil { background: rgba(245, 158, 11, 0.2); }
        .macro-icon.shipping { background: rgba(139, 92, 246, 0.2); }
        .macro-icon.weather { background: rgba(16, 185, 129, 0.2); }
        
        .macro-name {
            font-size: 12px;
            font-weight: 500;
        }
        
        .macro-subtext {
            font-size: 10px;
            color: var(--text-muted);
        }
        
        .macro-value {
            text-align: right;
        }
        
        .macro-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
        }
        
        .macro-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 2px;
            justify-content: flex-end;
        }
        
        .macro-impact {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .macro-impact.bullish { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .macro-impact.bearish { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .macro-impact.neutral { background: rgba(156, 163, 175, 0.2); color: var(--text-muted); }
        
        /* Trade Log */
        .portfolio-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        
        .portfolio-tab {
            padding: 6px 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--bg-card);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .portfolio-tab:hover {
            color: var(--text-primary);
        }
        
        .portfolio-tab.active {
            background: var(--accent-blue);
            color: white;
        }
        
        .trade-log-container {
            display: none;
            overflow-x: auto;
        }
        
        .trade-log-container.active {
            display: block;
        }
        
        .trade-log-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .trade-stat {
            background: var(--bg-card);
            padding: 8px 4px;
            border-radius: 6px;
            text-align: center;
        }
        
        .trade-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
        }
        
        .trade-stat-label {
            font-size: 8px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 2px;
        }
        
        .trade-log-table {
            width: 100%;
            font-size: 10px;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .trade-log-table th {
            text-align: left;
            padding: 6px 4px;
            font-size: 8px;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }
        
        .trade-log-table td {
            padding: 6px 4px;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .trade-log-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .trade-type-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .trade-type-badge.long { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .trade-type-badge.short { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        
        /* Command Line */
        .command-line-container {
            position: relative;
            flex: 1;
            max-width: 400px;
            margin: 0 24px;
        }
        
        .command-line {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px 8px 36px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            outline: none;
            transition: all 0.2s;
        }
        
        .command-line:focus {
            border-color: var(--accent-blue);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .command-line::placeholder {
            color: var(--text-muted);
        }
        
        .command-line-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 12px;
        }
        
        .command-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .command-suggestions.active {
            display: block;
        }
        
        .command-suggestion {
            padding: 8px 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.1s;
        }
        
        .command-suggestion:hover, .command-suggestion.selected {
            background: var(--bg-tertiary);
        }
        
        .command-suggestion-cmd {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-blue);
        }
        
        .command-suggestion-desc {
            color: var(--text-muted);
            font-size: 10px;
        }
        
        /* Maximize Functionality */
        .maximize-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .maximize-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        
        .panel-maximized {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            background: var(--bg-primary) !important;
            overflow: auto;
        }
        
        .panel-maximized .chart-container {
            height: calc(100vh - 200px) !important;
        }
        
        .maximize-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9998;
        }
        
        .maximize-overlay.active {
            display: block;
        }
        
        /* Flash Quote Board */
        .quote-board-section {
            padding: 0 16px;
            margin-bottom: 16px;
        }
        
        .quote-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .quote-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .quote-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
        }
        
        .quote-card.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .quote-card.flash-green {
            animation: flashQuoteGreen 0.5s ease;
        }
        
        .quote-card.flash-red {
            animation: flashQuoteRed 0.5s ease;
        }
        
        @keyframes flashQuoteGreen {
            0%, 100% { background: var(--bg-card); }
            50% { background: rgba(16, 185, 129, 0.3); }
        }
        
        @keyframes flashQuoteRed {
            0%, 100% { background: var(--bg-card); }
            50% { background: rgba(239, 68, 68, 0.3); }
        }
        
        .quote-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .quote-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .quote-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
        }
        
        .quote-volume {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Quick Quote Modal */
        .quick-quote-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .quick-quote-modal-overlay.active {
            display: flex;
        }
        
        .quick-quote-modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .quick-quote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }
        
        .quick-quote-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .quick-quote-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .quick-quote-name {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .quick-quote-price-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }
        
        .quick-quote-current-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
        }
        
        .quick-quote-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
        }
        
        .quick-quote-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 28px;
            cursor: pointer;
            padding: 0 8px;
            line-height: 1;
        }
        
        .quick-quote-close:hover {
            color: var(--text-primary);
        }
        
        .quick-quote-body {
            display: grid;
            grid-template-columns: 1fr 320px;
            flex: 1;
            overflow: hidden;
        }
        
        .quick-quote-chart-area {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }
        
        .quick-quote-chart {
            flex: 1;
            background: var(--bg-card);
            border-radius: 8px;
            position: relative;
            min-height: 280px;
        }
        
        .quick-quote-chart canvas {
            width: 100%;
            height: 100%;
        }
        
        .quick-quote-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .quick-stat {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .quick-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .quick-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        .quick-quote-trade-panel {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .quick-trade-type-toggle {
            display: flex;
            gap: 8px;
        }
        
        .quick-trade-type-btn {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-trade-type-btn.buy {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .quick-trade-type-btn.buy.active {
            background: var(--accent-green);
            color: white;
        }
        
        .quick-trade-type-btn.sell {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }
        
        .quick-trade-type-btn.sell.active {
            background: var(--accent-red);
            color: white;
        }
        
        .quick-trade-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .quick-trade-input-group label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .quick-trade-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        .quick-trade-input::-webkit-outer-spin-button,
        .quick-trade-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .quick-trade-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* Quick Quote Crosshair and Tooltip */
        .qq-crosshair {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .qq-crosshair-v, .qq-crosshair-h {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .qq-crosshair-v {
            width: 1px;
            top: 0;
            bottom: 0;
        }
        
        .qq-crosshair-h {
            height: 1px;
            left: 0;
            right: 0;
        }
        
        .qq-tooltip {
            display: none;
            position: absolute;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .qq-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 4px;
        }
        
        .qq-tooltip-row:last-child {
            margin-bottom: 0;
        }
        
        .qq-tooltip-label {
            color: var(--text-muted);
        }
        
        .qq-tooltip-value {
            font-weight: 500;
        }
        
        .qq-tooltip-value.up { color: var(--accent-green); }
        .qq-tooltip-value.down { color: var(--accent-red); }
        
        .quick-quote-chart {
            position: relative;
        }
        
        .quick-trade-summary {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
        }
        
        .quick-trade-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .quick-trade-summary-row:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-weight: 600;
        }
        
        .quick-trade-execute {
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-trade-execute.buy {
            background: var(--accent-green);
            color: white;
        }
        
        .quick-trade-execute.sell {
            background: var(--accent-red);
            color: white;
        }
        
        .quick-trade-execute:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        @media (max-width: 900px) {
            .quick-quote-body {
                grid-template-columns: 1fr;
            }
            .quick-quote-trade-panel {
                border-left: none;
                border-top: 1px solid var(--border);
            }
        }
        
        .studies-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 10;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .chart-tooltip.visible {
            opacity: 1;
        }

        .tooltip-date {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .tooltip-label {
            color: var(--text-muted);
        }

        .tooltip-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .tooltip-value.up { color: var(--accent-green); }
        .tooltip-value.down { color: var(--accent-red); }

        .chart-crosshair {
            position: absolute;
            pointer-events: none;
            display: none;
        }

        .crosshair-v {
            position: absolute;
            width: 1px;
            background: rgba(255,255,255,0.2);
            top: 0;
            bottom: 0;
        }

        .crosshair-h {
            position: absolute;
            height: 1px;
            background: rgba(255,255,255,0.2);
            left: 0;
            right: 0;
        }

        /* Auction Data Grid */
        .auction-section {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        
        .auction-section .table-container {
            flex: 1;
        }
        
        /* Order History Section */
        .order-history-section {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .order-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .order-history-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .order-count {
            background: var(--accent-blue);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .order-filter-buttons {
            display: flex;
            gap: 8px;
        }
        
        .order-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .order-table-wrapper {
            max-height: 320px;
            overflow-y: auto;
        }

        .order-table-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .order-table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .order-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .order-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .pairs-table-wrapper {
            max-height: 760px;
            overflow-y: auto;
        }

        .pairs-table-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .pairs-table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .pairs-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .pairs-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .auction-table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-light) var(--bg-tertiary);
        }

        .auction-table-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .auction-table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .auction-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .auction-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        .order-table th {
            text-align: left;
            padding: 8px 12px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 1;
        }

        .order-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s ease;
        }

        .order-table th.sortable:hover {
            color: var(--text-primary);
        }

        .order-table th.sortable::after {
            content: '';
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
        }

        .order-table th.sortable.asc::after {
            content: 'â–²';
            opacity: 1;
            color: var(--accent-blue);
        }

        .order-table th.sortable.desc::after {
            content: 'â–¼';
            opacity: 1;
            color: var(--accent-blue);
        }
        
        .order-table tfoot td {
            padding: 10px 12px;
            border-top: 2px solid var(--border);
            font-weight: 600;
            background: var(--bg-tertiary);
            position: sticky;
            bottom: 0;
            z-index: 1;
        }
        
        .order-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .order-table tr:hover {
            background: var(--bg-card);
        }
        
        .order-table tr:last-child td {
            border-bottom: none;
        }
        
        .order-table .order-price {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .order-table td.up {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        .order-table td.down {
            color: var(--accent-red);
            font-weight: 600;
        }
        
        .order-table .order-qty {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }
        
        .order-status {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .order-status.filled {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .order-status.pending {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-orange);
        }

        .order-status.closed {
            background: rgba(96, 165, 250, 0.15);
            color: var(--accent-blue);
        }

        .close-position-btn {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
            transition: all 0.2s ease;
        }

        .close-position-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        .close-position-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .order-status.filled {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .order-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-orange);
        }
        
        .order-status.partial {
            background: rgba(26, 115, 232, 0.15);
            color: var(--accent-blue);
        }

        .order-side {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .order-side.buy-side {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .order-side.sell-side {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Market Toggle (Singles/Pairs) */
        .market-toggle {
            display: flex;
            gap: 0;
            margin-right: 16px;
        }

        .toggle-btn {
            padding: 5px 14px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:first-child {
            border-radius: 4px 0 0 4px;
            border-right: none;
        }

        .toggle-btn:last-child {
            border-radius: 0 4px 4px 0;
        }

        .toggle-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        /* Pairs table styles */
        .pair-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 13px;
        }

        .pair-symbol .base {
            color: var(--accent-green);
        }

        .pair-symbol .quote {
            color: var(--accent-red);
        }

        .pair-ratio {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 14px;
            color: var(--accent-blue);
        }

        .trade-pair-btn {
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-pair-btn.long {
            background: var(--accent-green);
            color: white;
        }

        .trade-pair-btn.short {
            background: var(--accent-red);
            color: white;
            margin-left: 6px;
        }

        .trade-pair-btn:hover {
            opacity: 0.85;
            transform: translateY(-1px);
        }

        /* Pairs Modal */
        .pairs-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .pairs-modal-overlay.active {
            display: flex;
        }

        .pairs-modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            width: 420px;
            max-width: 95%;
        }

        .pairs-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pairs-modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .pairs-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .pairs-modal-pair {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .pairs-modal-pair .pair-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .pairs-modal-pair .ratio-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            color: var(--accent-blue);
        }

        .leverage-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .leverage-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .leverage-btn.active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .leverage-btn:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        .pairs-input-group {
            margin-bottom: 16px;
        }

        .pairs-input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .pairs-input-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
        }

        .pairs-summary {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }

        .pairs-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }

        .pairs-summary-row .label {
            color: var(--text-muted);
        }

        .pairs-summary-row .value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .pairs-summary-row.exposure .value {
            color: var(--accent-orange);
        }

        .pairs-modal-actions {
            display: flex;
            gap: 12px;
        }

        .pairs-modal-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pairs-modal-actions .cancel-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .pairs-modal-actions .confirm-btn {
            color: white;
            background: var(--accent-blue);
        }

        .pairs-modal-actions .confirm-btn.long {
            background: var(--accent-green);
        }

        .pairs-modal-actions .confirm-btn.short {
            background: var(--accent-red);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary);
        }

        .grade-badge {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 12px;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            display: inline-block;
        }

        .auction-center {
            color: var(--accent-blue);
            font-weight: 500;
        }

        .price-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
        }
        
        .price-cell span {
            flex: 1;
        }
        
        .price-cell .price-alert-btn {
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        
        .price-cell:hover .price-alert-btn {
            opacity: 1;
        }
        
        .price-cell .price-alert-btn.has-alert {
            opacity: 1;
            color: var(--accent-orange);
        }

        .price-cell.up {
            color: var(--accent-green);
        }

        .price-cell.down {
            color: var(--accent-red);
        }

        .price-cell.flash-up {
            animation: flashGreen 1s ease;
        }

        .price-cell.flash-down {
            animation: flashRed 1s ease;
        }

        @keyframes flashGreen {
            0% { background: rgba(0, 212, 170, 0.5); }
            100% { background: transparent; }
        }

        @keyframes flashRed {
            0% { background: rgba(255, 107, 107, 0.5); }
            100% { background: transparent; }
        }

        .volume-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .volume-fill {
            height: 100%;
            background: var(--accent-blue);
            border-radius: 2px;
        }

        /* Right Panel */
        .right-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            min-height: 100%;
            overflow: hidden;
            max-width: 320px;
        }

        .panel-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        
        .panel-section:last-child {
            flex: 1;
            border-bottom: none;
        }

        .panel-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--accent-green);
            font-size: 10px;
        }

        .live-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .news-feed {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-light) var(--bg-tertiary);
        }

        .news-feed::-webkit-scrollbar {
            width: 6px;
        }

        .news-feed::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .news-feed::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        .news-feed::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .news-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-time {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .news-headline {
            font-size: 13px;
            line-height: 1.4;
            margin-top: 4px;
        }

        .news-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 6px;
        }

        .news-tag { background: var(--accent-blue); color: white; }

        /* Order Book / Depth of Market */
        .order-book-section {
            position: relative;
            overflow: hidden;
        }

        .order-book-container {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            display: flex;
            flex-direction: column;
        }

        .ob-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 6px 10px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: background 0.15s;
            overflow: hidden;
        }
        
        .ob-row:hover { background: rgba(255,255,255,0.03); }
        
        .ob-row > span {
            position: relative;
            z-index: 2;
        }

        .ob-header {
            color: var(--text-muted);
            font-size: 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
            cursor: default;
        }

        .ob-header:hover { background: transparent; }

        .ob-price-up { color: var(--accent-green); font-weight: 500; }
        .ob-price-down { color: var(--accent-red); font-weight: 500; }
        
        .depth-bar {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 0;
            opacity: 0.3;
            pointer-events: none;
        }

        .ask-bar { 
            background-color: var(--accent-red);
        }
        .bid-bar { 
            background-color: var(--accent-green);
        }

        .ob-spread {
            text-align: center;
            padding: 10px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin: 4px 0;
            background: rgba(255,255,255,0.02);
        }

        .ob-spread-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .ob-spread-price { 
            font-size: 16px; 
            font-weight: 700; 
            color: var(--text-primary); 
            margin-top: 2px;
        }

        .ob-blur-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 55%;
            background: linear-gradient(to bottom, rgba(10,14,23,0) 0%, rgba(10,14,23,0.9) 35%, rgba(10,14,23,1) 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 20px;
            z-index: 10;
            pointer-events: none;
        }
        
        .ob-lock-content {
            text-align: center;
            pointer-events: auto;
        }

        .ob-lock-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            color: var(--text-muted);
        }

        .ob-lock-icon svg {
            width: 14px;
            height: 14px;
        }
        
        .ob-lock-content h4 { 
            color: var(--text-primary); 
            margin: 0 0 4px; 
            font-size: 12px;
            font-weight: 600;
        }

        .ob-lock-content p { 
            color: var(--text-muted); 
            font-size: 11px; 
            margin: 0 0 12px;
            max-width: 200px;
        }
        
        .ob-btn-access {
            background: var(--accent-blue);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .ob-btn-access:hover { background: #1557b0; }

        /* Top Movers */
        .movers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .mover-card {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 12px;
        }

        .mover-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .mover-name {
            font-weight: 600;
            font-size: 13px;
        }

        .mover-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Auction Calendar */
        .calendar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .calendar-date {
            width: 48px;
            text-align: center;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
        }

        .calendar-day {
            font-size: 18px;
            font-weight: 700;
        }

        .calendar-month {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .calendar-info {
            flex: 1;
        }

        .calendar-name {
            font-weight: 500;
            font-size: 13px;
        }

        .calendar-center {
            font-size: 11px;
            color: var(--text-muted);
        }

        .calendar-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .calendar-status.live {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .calendar-status.upcoming {
            background: rgba(26, 115, 232, 0.2);
            color: var(--accent-blue);
        }

        /* Market Summary Cards */
        .market-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--border);
            border-bottom: 1px solid var(--border);
        }

        .market-card {
            background: var(--bg-secondary);
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .market-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .market-card:active {
            transform: translateY(0);
        }

        .market-card.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .market-card-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .market-card-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            margin-top: 4px;
        }

        .market-card-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-top: 4px;
        }

        /* Spark line placeholder */


        /* Bottom Stats Bar */
        .bottom-bar {
            background: var(--ticker-bg);
            border-top: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .bottom-stat {
            display: flex;
            gap: 24px;
        }

        .bottom-stat span {
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .sidebar, .right-panel {
                display: none;
            }
            /* Show sidebar when mobile menu is active */
            .sidebar.mobile-open {
                display: flex;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 9999;
                box-shadow: 4px 0 20px rgba(0,0,0,0.5);
                animation: slideInLeft 0.25s ease;
            }
            .market-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .quote-board {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        /* Mobile Menu Hamburger Button */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            margin-right: 8px;
        }
        
        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }
        
        @media (max-width: 1200px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
            }
        }
        
        /* Mobile overlay when sidebar is open */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9998;
        }
        
        .mobile-overlay.active {
            display: block;
        }
        
        /* Mobile close button for sidebar */
        .mobile-sidebar-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            margin: -16px -16px 16px -16px;
        }
        
        @media (max-width: 1200px) {
            .sidebar.mobile-open .mobile-sidebar-header {
                display: flex;
            }
        }
        
        .mobile-close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            /* Prevent any overflow */
            html, body {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }
            
            /* Hide ticker strip and bottom bar on mobile */
            .ticker-strip {
                display: none;
            }
            
            .bottom-bar {
                display: none;
            }
            
            /* Market Cards - horizontal scroll */
            .market-cards {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 10px;
                padding: 10px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .market-cards::-webkit-scrollbar {
                display: none;
            }
            .market-card {
                flex: 0 0 auto;
                min-width: 140px;
                padding: 12px;
            }
            .market-card-label {
                font-size: 9px;
            }
            .market-card-value {
                font-size: 1.1rem;
            }
            .market-card-change {
                font-size: 10px;
            }
            
            /* Quote board - horizontal scroll */
            .quote-board {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 8px;
                padding: 10px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .quote-board::-webkit-scrollbar {
                display: none;
            }
            .quote-card {
                flex: 0 0 auto;
                min-width: 90px;
                padding: 10px;
            }
            .quote-symbol {
                font-size: 11px;
            }
            .quote-price {
                font-size: 13px;
            }
            .quote-change {
                font-size: 10px;
            }

            /* Top Bar */
            .top-bar {
                padding: 0 10px;
                height: 44px;
            }
            .logo-text {
                display: none;
            }
            .nav-links {
                display: none;
            }
            .command-line-container {
                display: none;
            }
            .user-section .market-status span:not(.status-dot) {
                display: none;
            }
            .user-section .market-status {
                gap: 0;
                padding: 0 6px;
            }
            .user-balance {
                flex-direction: row;
                gap: 4px;
                padding: 4px 8px;
                background: var(--bg-tertiary);
                border-radius: 4px;
            }
            .user-balance-label {
                display: none;
            }
            .user-balance-amount {
                font-size: 12px;
            }
            .user-menu {
                gap: 6px;
            }

            /* Main content - full width */
            .center-content {
                padding: 0;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            /* Chart section */
            .chart-section {
                padding: 12px;
                margin: 0;
                border-radius: 0;
            }
            .chart-header {
                flex-direction: column;
                gap: 10px;
            }
            .chart-title h2 {
                font-size: 1rem;
            }
            .chart-badge {
                font-size: 9px;
                padding: 2px 6px;
            }
            .chart-stats {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
            }
            .chart-stat-value {
                font-size: 0.9rem !important;
            }
            .chart-stat-label {
                font-size: 8px;
            }
            .chart-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                width: 100%;
            }
            .chart-btn {
                padding: 5px 8px;
                font-size: 10px;
            }
            .chart-container {
                height: 200px;
            }
            
            /* Market depth */
            .market-depth {
                padding: 10px;
            }

            /* Auction Section */
            .auction-section {
                padding: 10px;
                overflow-x: hidden;
            }
            .section-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            .section-title {
                font-size: 11px;
            }
            .section-filters {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
            }
            .filter-btn, .toggle-btn {
                padding: 4px 8px;
                font-size: 10px;
            }
            
            /* Auction table - horizontal scroll wrapper */
            .auction-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-height: none;
            }
            .data-table {
                min-width: 600px;
            }
            .data-table th, .data-table td {
                padding: 8px 6px;
                font-size: 11px;
                white-space: nowrap;
            }
            .grade-badge {
                padding: 2px 4px;
                font-size: 9px;
            }
            
            /* Order history */
            .order-history-section {
                padding: 10px;
            }
            .order-table-wrapper {
                overflow-x: auto;
            }
            .order-table {
                min-width: 500px;
            }
            
            /* Login button mobile */
            .login-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
        }

        @media (max-width: 400px) {
            .market-card {
                min-width: 120px;
            }
            .quote-card {
                min-width: 80px;
            }
            .chart-container {
                height: 180px;
            }
            .chart-stats {
                gap: 8px;
            }
            .chart-stat-value {
                font-size: 0.85rem !important;
            }
            .login-btn {
                padding: 5px 10px;
                font-size: 10px;
            }
        }

        /* Early Access Modal */
        .early-access-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .early-access-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .early-access-content {
            position: relative;
            background: #fff;
            border-radius: 16px;
            max-width: 520px;
            width: 90%;
            padding: 40px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.4);
            text-align: center;
        }
        .early-access-badge {
            display: inline-block;
            background: var(--accent-blue);
            color: #fff;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }
        .early-access-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #202124;
            margin: 0 0 12px 0;
            line-height: 1.2;
        }
        .early-access-subtitle {
            font-size: 1rem;
            color: #5f6368;
            margin: 0 0 24px 0;
            line-height: 1.5;
        }
        .early-access-features {
            text-align: left;
            margin: 0 0 28px 0;
            padding: 0;
            list-style: none;
        }
        .early-access-features li {
            padding: 8px 0;
            font-size: 0.9rem;
            color: #3c4043;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .early-access-features li::before {
            content: '';
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }
        .early-access-form {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        .early-access-form input[type="text"] {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .early-access-form input[type="text"]:focus {
            border-color: var(--accent-blue);
        }
        .early-access-form button {
            padding: 14px 28px;
            background: var(--accent-blue);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .early-access-form button:hover {
            background: #1557b0;
        }
        .early-access-form button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .early-access-privacy {
            font-size: 0.75rem;
            color: #5f6368;
            line-height: 1.5;
        }
        .early-access-privacy a {
            color: var(--accent-blue);
        }
        .early-access-success {
            padding: 20px 0;
        }
        .early-access-success-icon {
            width: 56px;
            height: 56px;
            background: #e6f4ea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: #137333;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .early-access-success p {
            color: #137333;
            font-size: 1rem;
        }
        @media (max-width: 500px) {
            .early-access-content {
                padding: 28px 20px;
            }
            .early-access-form {
                flex-direction: column;
            }
            .early-access-form button {
                width: 100%;
            }
        }

        /* =============================================
           AUTH MODAL & TRADING PANEL STYLES
           ============================================= */
        
        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .auth-modal.visible {
            display: flex;
        }
        .auth-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .auth-content {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 420px;
            width: 90%;
            padding: 32px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.5);
        }
        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }
        .auth-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0 0 24px 0;
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .auth-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .auth-input-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .auth-input {
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .auth-input:focus {
            border-color: var(--accent-blue);
        }
        .auth-input::placeholder {
            color: var(--text-muted);
        }
        .auth-submit {
            padding: 14px;
            background: var(--accent-blue);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 8px;
        }
        .auth-submit:hover {
            background: #1557b0;
        }
        .auth-submit:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        .auth-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--accent-red);
            border-radius: 6px;
            padding: 12px;
            color: var(--accent-red);
            font-size: 13px;
            display: none;
        }
        .auth-error.visible {
            display: block;
        }
        .auth-bonus {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--accent-green);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            margin-top: 16px;
        }
        .auth-bonus-amount {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-green);
        }
        .auth-bonus-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .auth-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        .auth-close:hover {
            color: var(--text-primary);
        }

        /* User Menu (logged in state) */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-balance {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        .user-balance-label {
            color: var(--text-muted);
            font-size: 10px;
            margin-right: 6px;
        }
        .user-balance-amount {
            color: var(--accent-green);
            font-weight: 600;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
        }
        .login-btn {
            padding: 8px 16px;
            background: var(--accent-blue);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .login-btn:hover {
            background: #1557b0;
        }

        /* Trading Panel (replaces Order Book lock) */
        .trading-panel {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .trade-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }
        .trade-type-toggle {
            display: flex;
            gap: 4px;
        }
        .trade-type-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trade-type-btn.buy {
            background: transparent;
            color: var(--accent-green);
            border-color: var(--accent-green);
        }
        .trade-type-btn.buy.active {
            background: var(--accent-green);
            color: white;
        }
        .trade-type-btn.sell {
            background: transparent;
            color: var(--accent-red);
            border-color: var(--accent-red);
        }
        .trade-type-btn.sell.active {
            background: var(--accent-red);
            color: white;
        }
        /* Modern Select Dropdown */
        .trade-select {
            padding: 12px 36px 12px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            outline: none;
            cursor: pointer;
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .trade-select:hover {
            border-color: var(--border-light);
        }
        .trade-select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        .trade-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 10px;
        }
        .trade-input-row {
            display: flex;
            gap: 8px;
        }
        .trade-input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .trade-input-group label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trade-input {
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .trade-input::-webkit-outer-spin-button,
        .trade-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .trade-input:hover {
            border-color: var(--border-light);
        }
        .trade-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        .trade-summary {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 12px;
        }
        .trade-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .trade-summary-label {
            color: var(--text-muted);
        }
        .trade-summary-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        .trade-execute-btn {
            padding: 14px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trade-execute-btn.buy {
            background: var(--accent-green);
            color: white;
        }
        .trade-execute-btn.buy:hover {
            background: #0d9668;
        }
        .trade-execute-btn.sell {
            background: var(--accent-red);
            color: white;
        }
        .trade-execute-btn.sell:hover {
            background: #dc2626;
        }
        .trade-execute-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        .trade-execute-btn.signin-prompt {
            background: var(--accent-blue);
            cursor: pointer;
        }
        .trade-execute-btn.signin-prompt:hover {
            background: #1557b0;
        }

        /* Portfolio Section */
        .portfolio-section {
            padding: 16px;
        }
        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .portfolio-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
        }
        .portfolio-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        .position-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .position-item:last-child {
            border-bottom: none;
        }
        .position-tea {
            font-weight: 600;
            font-size: 13px;
        }
        .position-qty {
            font-size: 11px;
            color: var(--text-muted);
        }
        .position-value {
            text-align: right;
        }
        .position-current {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }
        .position-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        /* Leaderboard Tab */
        .leaderboard-section {
            padding: 16px;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .leaderboard-rank {
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }
        .leaderboard-rank.gold { background: #f59e0b; color: #000; }
        .leaderboard-rank.silver { background: #9ca3af; color: #000; }
        .leaderboard-rank.bronze { background: #cd7f32; color: #000; }
        .leaderboard-name {
            flex: 1;
            font-size: 13px;
        }
        .leaderboard-return {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
        }

        /* Trade Success Toast */
        .trade-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 10001;
            display: none;
            animation: slideIn 0.3s ease;
        }
        .trade-toast.visible {
            display: block;
        }
        .trade-toast.error {
            border-color: var(--accent-red);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .toast-message {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Early Access Modal -->
    <div class="early-access-modal" id="early-access-modal">
        <div class="early-access-backdrop"></div>
        <div class="early-access-content">
            <span class="early-access-badge">Early Access</span>
            <h2 class="early-access-title">TeaTrade Exchange</h2>
            <p class="early-access-subtitle">The world's first real-time tea market terminal. Get priority access to auction data, price indices, and institutional-grade analytics.</p>
            <ul class="early-access-features">
                <li>Live auction data from Mombasa, Kolkata, Colombo & more</li>
                <li>Real-time price indices by grade, origin & buyer</li>
                <li>Historical trade analytics & trend forecasting</li>
                <li>Buyer & seller intelligence reports</li>
            </ul>
            <form class="early-access-form" id="early-access-form" onsubmit="submitEarlyAccess(event)">
                <input type="text" id="early-access-email" name="email_address" placeholder="Enter your email address">
                <button type="submit" id="early-access-btn">Get Early Access</button>
            </form>
            <p class="early-access-privacy">Your email is stored securely and used only to notify you when TeaTrade Exchange launches. We never share your data. <a href="/privacy.html" target="_blank">Privacy Policy</a></p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-backdrop" onclick="closeAuthModal()"></div>
        <div class="auth-content">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            <div class="auth-tabs">
                <button class="auth-tab active" id="tab-signup" onclick="switchAuthTab('signup')">Sign Up</button>
                <button class="auth-tab" id="tab-login" onclick="switchAuthTab('login')">Log In</button>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form-container">
                <h3 class="auth-title">Join the Paper Trading League</h3>
                <p class="auth-subtitle">Compete to become the world's best tea trader. Top traders win real tea prizes!</p>
                <div class="auth-error" id="signup-error"></div>
                <form class="auth-form" id="signup-form" onsubmit="handleSignup(event)">
                    <div class="auth-input-group">
                        <label>Username</label>
                        <input type="text" class="auth-input" id="signup-username" placeholder="tea_trader_123" required minlength="3" maxlength="20">
                    </div>
                    <div class="auth-input-group">
                        <label>Email</label>
                        <input type="email" class="auth-input" id="signup-email" placeholder="you@example.com" required>
                    </div>
                    <div class="auth-input-group">
                        <label>Password</label>
                        <input type="password" class="auth-input" id="signup-password" placeholder="Min 6 characters" required minlength="6">
                    </div>
                    <button type="submit" class="auth-submit" id="signup-btn">Create Account & Start Trading</button>
                </form>
                <div class="auth-bonus">
                    <div class="auth-bonus-amount">$10,000</div>
                    <div class="auth-bonus-label">Virtual Cash to Start Trading</div>
                </div>
            </div>
            
            <!-- Login Form -->
            <div id="login-form-container" style="display: none;">
                <h3 class="auth-title">Welcome Back</h3>
                <p class="auth-subtitle">Log in to continue trading and climb the leaderboard.</p>
                <div class="auth-error" id="login-error"></div>
                <form class="auth-form" id="login-form" onsubmit="handleLogin(event)">
                    <div class="auth-input-group">
                        <label>Email</label>
                        <input type="email" class="auth-input" id="login-email" placeholder="you@example.com" required>
                    </div>
                    <div class="auth-input-group">
                        <label>Password</label>
                        <input type="password" class="auth-input" id="login-password" placeholder="Your password" required>
                    </div>
                    <button type="submit" class="auth-submit" id="login-btn">Log In</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Trade Toast Notification -->
    <div class="trade-toast" id="trade-toast">
        <div class="toast-title" id="toast-title">Trade Executed!</div>
        <div class="toast-message" id="toast-message"></div>
    </div>

    <!-- Pairs Trade Modal -->
    <div class="pairs-modal-overlay" id="pairs-modal">
        <div class="pairs-modal">
            <div class="pairs-modal-header">
                <div class="pairs-modal-title" id="pairs-modal-title">Trade Pair</div>
                <button class="pairs-modal-close" onclick="closePairsModal()">&times;</button>
            </div>
            <div class="pairs-modal-pair">
                <div class="pair-display" id="modal-pair-display">
                    <span class="base">DRJ</span>/<span class="quote">ASM</span>
                </div>
                <div class="ratio-display" id="modal-ratio-display">Ratio: 5.76</div>
            </div>
            <div class="leverage-selector">
                <button class="leverage-btn active" data-leverage="1" onclick="setLeverage(1)">1x</button>
                <button class="leverage-btn" data-leverage="2" onclick="setLeverage(2)">2x</button>
                <button class="leverage-btn" data-leverage="5" onclick="setLeverage(5)">5x</button>
                <button class="leverage-btn" data-leverage="10" onclick="setLeverage(10)">10x</button>
            </div>
            <div class="pairs-input-group">
                <label>Position Size (USD)</label>
                <input type="number" id="pairs-amount" value="100" min="10" step="10" oninput="updatePairsSummary()">
            </div>
            <div class="pairs-summary">
                <div class="pairs-summary-row">
                    <span class="label">Position Size</span>
                    <span class="value" id="summary-size">$100.00</span>
                </div>
                <div class="pairs-summary-row">
                    <span class="label">Leverage</span>
                    <span class="value" id="summary-leverage">1x</span>
                </div>
                <div class="pairs-summary-row exposure">
                    <span class="label">Total Exposure</span>
                    <span class="value" id="summary-exposure">$100.00</span>
                </div>
                <div class="pairs-summary-row">
                    <span class="label">Entry Ratio</span>
                    <span class="value" id="summary-ratio">5.76</span>
                </div>
            </div>
            <div class="pairs-modal-actions">
                <button class="cancel-btn" onclick="closePairsModal()">Cancel</button>
                <button class="confirm-btn" id="pairs-confirm-btn" onclick="executePairTrade()">Confirm Trade</button>
            </div>
        </div>
    </div>

    <!-- Quick Quote Modal -->
    <div class="quick-quote-modal-overlay" id="quick-quote-modal">
        <div class="quick-quote-modal">
            <div class="quick-quote-header">
                <div class="quick-quote-title">
                    <span class="quick-quote-symbol" id="qq-symbol">BP1</span>
                    <span class="quick-quote-name" id="qq-name">Kenya BP1</span>
                </div>
                <div class="quick-quote-price-info">
                    <span class="quick-quote-current-price up" id="qq-price">$3.42</span>
                    <span class="quick-quote-change up" id="qq-change">+2.4%</span>
                </div>
                <button class="quick-quote-close" onclick="closeQuickQuoteModal()">&times;</button>
            </div>
            <div class="quick-quote-body">
                <div class="quick-quote-chart-area">
                    <div class="quick-quote-chart">
                        <canvas id="qq-chart"></canvas>
                        <div class="qq-crosshair" id="qq-crosshair">
                            <div class="qq-crosshair-v"></div>
                            <div class="qq-crosshair-h"></div>
                        </div>
                        <div class="qq-tooltip" id="qq-tooltip"></div>
                    </div>
                    <div class="quick-quote-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-value" id="qq-high">$3.56</div>
                            <div class="quick-stat-label">24h High</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-value" id="qq-low">$3.28</div>
                            <div class="quick-stat-label">24h Low</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-value" id="qq-volume">24.5K</div>
                            <div class="quick-stat-label">Volume</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-value" id="qq-avg">$3.41</div>
                            <div class="quick-stat-label">Avg Price</div>
                        </div>
                    </div>
                </div>
                <div class="quick-quote-trade-panel">
                    <div class="quick-trade-type-toggle">
                        <button class="quick-trade-type-btn buy active" id="qq-btn-buy" onclick="setQuickTradeType('BUY')">BUY</button>
                        <button class="quick-trade-type-btn sell" id="qq-btn-sell" onclick="setQuickTradeType('SELL')">SELL</button>
                    </div>
                    <div class="quick-trade-input-group">
                        <label>Quantity (kg)</label>
                        <input type="number" class="quick-trade-input" id="qq-qty" value="100" min="1" oninput="updateQuickTradeSummary()">
                    </div>
                    <div class="quick-trade-input-group">
                        <label>Price ($/kg)</label>
                        <input type="number" class="quick-trade-input" id="qq-trade-price" readonly>
                    </div>
                    <div class="quick-trade-summary">
                        <div class="quick-trade-summary-row">
                            <span>Order Value</span>
                            <span id="qq-order-value">$342.00</span>
                        </div>
                        <div class="quick-trade-summary-row">
                            <span>Your Balance</span>
                            <span id="qq-balance">$10,000.00</span>
                        </div>
                        <div class="quick-trade-summary-row">
                            <span>After Trade</span>
                            <span id="qq-after-trade">$9,658.00</span>
                        </div>
                    </div>
                    <button class="quick-trade-execute buy" id="qq-execute-btn" onclick="executeQuickTrade()">BUY 100 kg</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Alert Modal -->
    <div class="pairs-modal-overlay" id="price-alert-modal">
        <div class="pairs-modal" style="max-width: 340px;">
            <div class="pairs-modal-header">
                <div class="pairs-modal-title" id="alert-modal-title">Set Price Alert</div>
                <button class="pairs-modal-close" onclick="closePriceAlertModal()">&times;</button>
            </div>
            <div class="pairs-modal-pair">
                <div class="pair-display" style="gap: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span id="alert-symbol" style="font-size: 18px; font-weight: 600;">DRJ</span>
                </div>
                <div class="ratio-display" id="alert-current-price">Current: $3.45</div>
            </div>
            <div class="sltp-section" style="margin: 16px 0;">
                <div class="sltp-group">
                    <label class="sltp-label"><span class="dot sl"></span>Alert Below</label>
                    <input type="number" class="sltp-input" id="alert-below" placeholder="e.g. 3.20" step="0.01">
                </div>
                <div class="sltp-group">
                    <label class="sltp-label"><span class="dot tp"></span>Alert Above</label>
                    <input type="number" class="sltp-input" id="alert-above" placeholder="e.g. 3.80" step="0.01">
                </div>
            </div>
            <div class="pairs-modal-actions">
                <button class="cancel-btn" onclick="deletePriceAlert()" id="alert-delete-btn" style="display: none;">Delete Alert</button>
                <button class="confirm-btn" onclick="savePriceAlert()">Save Alert</button>
            </div>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
        </button>
        <div class="logo">
            <div class="logo-icon">TT</div>
            <div class="logo-text">TeaTrade <span>Exchange</span></div>
        </div>
        <div class="command-line-container">
            <span class="command-line-icon">âŒ˜</span>
            <input type="text" class="command-line" id="command-line" placeholder="Type command... (BP1, NEWS, BUY 50)" autocomplete="off">
            <div class="command-suggestions" id="command-suggestions"></div>
        </div>
        <nav class="nav-links">
            <a href="#" class="active">Markets</a>
            <a href="#">Auctions</a>
            <a href="#">Analytics</a>
            <a href="#">Grades</a>
            <a href="#">Buyers</a>
            <a href="#">Sellers</a>
            <a href="#">Reports</a>
        </nav>
        <div class="user-section">
            <div class="market-status" id="market-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Mombasa Live</span>
            </div>
            <!-- Logged out state -->
            <div id="logged-out-ui">
                <button class="login-btn" onclick="openAuthModal()">Sign Up / Log In</button>
            </div>
            <!-- Logged in state -->
            <div id="logged-in-ui" class="user-menu" style="display: none;">
                <div class="user-balance">
                    <span class="user-balance-label">BALANCE</span>
                    <span class="user-balance-amount" id="user-balance">$10,000.00</span>
                </div>
                <div class="user-avatar" id="user-avatar" onclick="handleLogout()" title="Click to logout">TT</div>
            </div>
        </div>
    </div>

    <!-- Ticker Strip -->
    <div class="ticker-strip">
        <div class="ticker-track">
            <div class="ticker-item">
                <span class="ticker-symbol">BP1.KE</span>
                <span class="ticker-price">$3.42/kg</span>
                <span class="ticker-change up">+2.4%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">PF1.KE</span>
                <span class="ticker-price">$2.98/kg</span>
                <span class="ticker-change down">-0.8%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">FBOP.IN</span>
                <span class="ticker-price">â‚¹285/kg</span>
                <span class="ticker-change up">+1.2%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">BOP.LK</span>
                <span class="ticker-price">LKR 1,245</span>
                <span class="ticker-change up">+3.1%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">OP.MWI</span>
                <span class="ticker-price">$2.15/kg</span>
                <span class="ticker-change down">-1.4%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">DUST.KE</span>
                <span class="ticker-price">$2.67/kg</span>
                <span class="ticker-change up">+0.6%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">TGFOP.IN</span>
                <span class="ticker-price">â‚¹412/kg</span>
                <span class="ticker-change up">+4.2%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">PEKOE.LK</span>
                <span class="ticker-price">LKR 980</span>
                <span class="ticker-change down">-0.3%</span>
            </div>
            <!-- Duplicate for seamless loop -->
            <div class="ticker-item">
                <span class="ticker-symbol">BP1.KE</span>
                <span class="ticker-price">$3.42/kg</span>
                <span class="ticker-change up">+2.4%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">PF1.KE</span>
                <span class="ticker-price">$2.98/kg</span>
                <span class="ticker-change down">-0.8%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">FBOP.IN</span>
                <span class="ticker-price">â‚¹285/kg</span>
                <span class="ticker-change up">+1.2%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">BOP.LK</span>
                <span class="ticker-price">LKR 1,245</span>
                <span class="ticker-change up">+3.1%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">OP.MWI</span>
                <span class="ticker-price">$2.15/kg</span>
                <span class="ticker-change down">-1.4%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">DUST.KE</span>
                <span class="ticker-price">$2.67/kg</span>
                <span class="ticker-change up">+0.6%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">TGFOP.IN</span>
                <span class="ticker-price">â‚¹412/kg</span>
                <span class="ticker-change up">+4.2%</span>
            </div>
            <div class="ticker-item">
                <span class="ticker-symbol">PEKOE.LK</span>
                <span class="ticker-price">LKR 980</span>
                <span class="ticker-change down">-0.3%</span>
            </div>
        </div>
    </div>

    <!-- Market Summary Cards -->
    <div class="market-cards">
        <div class="market-card" id="market-card-0" onclick="swapChartIndex(0)">
            <div class="market-card-label">Mombasa Auction Index</div>
            <div class="market-card-value" id="card-value-0">$2.87</div>
            <div class="market-card-change up" id="card-change-0">â–² +1.8%</div>
        </div>
        <div class="market-card" id="market-card-1" onclick="swapChartIndex(1)">
            <div class="market-card-label">Kolkata Tea Index</div>
            <div class="market-card-value" id="card-value-1">â‚¹267.45</div>
            <div class="market-card-change up" id="card-change-1">â–² +3.2%</div>
        </div>
        <div class="market-card" id="market-card-2" onclick="swapChartIndex(2)">
            <div class="market-card-label">Colombo Index</div>
            <div class="market-card-value" id="card-value-2">$3.24</div>
            <div class="market-card-change down" id="card-change-2">â–¼ -1.8%</div>
        </div>
        <div class="market-card" id="market-card-3" onclick="swapChartIndex(3)">
            <div class="market-card-label">Global Tea Futures</div>
            <div class="market-card-value" id="card-value-3">$3,847</div>
            <div class="market-card-change up" id="card-change-3">â–² +0.7%</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Left Sidebar -->
        <div class="sidebar" id="mobile-sidebar">
            <!-- Mobile sidebar header (hidden on desktop) -->
            <div class="mobile-sidebar-header">
                <span style="font-weight: 600; color: var(--text-primary);">Menu</span>
                <button class="mobile-close-btn" onclick="closeMobileMenu()" aria-label="Close menu">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Watchlist</div>
                <div class="watchlist-tabs">
                    <button class="watchlist-tab active" onclick="switchWatchlistTab('teas')">Teas</button>
                    <button class="watchlist-tab" onclick="switchWatchlistTab('macro')">Macro</button>
                </div>
                <div id="watchlist-teas">
                <div class="watchlist-item">
                    <div>
                        <div class="watchlist-name">Darjeeling FTGFOP1</div>
                        <div class="watchlist-grade">First Flush â€¢ Goomtee</div>
                    </div>
                    <div class="watchlist-price">
                        <div class="watchlist-value">â‚¹1,845</div>
                        <div class="watchlist-change up">+8.2%</div>
                    </div>
                </div>
                <div class="watchlist-item">
                    <div>
                        <div class="watchlist-name">Assam CTC BP</div>
                        <div class="watchlist-grade">Dikom Estate</div>
                    </div>
                    <div class="watchlist-price">
                        <div class="watchlist-value">â‚¹298</div>
                        <div class="watchlist-change down">-1.4%</div>
                    </div>
                </div>
                <div class="watchlist-item">
                    <div>
                        <div class="watchlist-name">Kenyan BOPF</div>
                        <div class="watchlist-grade">Kericho Highlands</div>
                    </div>
                    <div class="watchlist-price">
                        <div class="watchlist-value">$3.12</div>
                        <div class="watchlist-change up">+2.8%</div>
                    </div>
                </div>
                <div class="watchlist-item">
                    <div>
                        <div class="watchlist-name">Ceylon OP1</div>
                        <div class="watchlist-grade">Nuwara Eliya</div>
                    </div>
                    <div class="watchlist-price">
                        <div class="watchlist-value">LKR 1,420</div>
                        <div class="watchlist-change up">+4.1%</div>
                    </div>
                </div>
                </div>
                <div id="watchlist-macro" style="display: none;">
                    <div class="macro-item">
                        <div class="macro-info">
                            <div class="macro-icon currency">ðŸ’±</div>
                            <div>
                                <div class="macro-name">USD/KES</div>
                                <div class="macro-subtext">Kenyan Shilling</div>
                            </div>
                        </div>
                        <div class="macro-value">
                            <div class="macro-price" id="macro-usdkes">129.45</div>
                            <div class="macro-change up" id="macro-usdkes-change">â–² +0.32%</div>
                            <div class="macro-impact bearish">Bearish Tea</div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-info">
                            <div class="macro-icon oil">ðŸ›¢ï¸</div>
                            <div>
                                <div class="macro-name">Brent Crude</div>
                                <div class="macro-subtext">Shipping costs</div>
                            </div>
                        </div>
                        <div class="macro-value">
                            <div class="macro-price" id="macro-oil">$82.40</div>
                            <div class="macro-change down" id="macro-oil-change">â–¼ -1.2%</div>
                            <div class="macro-impact bullish">Bullish Tea</div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-info">
                            <div class="macro-icon shipping">ðŸš¢</div>
                            <div>
                                <div class="macro-name">BDI Index</div>
                                <div class="macro-subtext">Baltic Dry Index</div>
                            </div>
                        </div>
                        <div class="macro-value">
                            <div class="macro-price" id="macro-bdi">1,842</div>
                            <div class="macro-change up" id="macro-bdi-change">â–² +2.8%</div>
                            <div class="macro-impact bearish">Bearish Tea</div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-info">
                            <div class="macro-icon weather">ðŸŒ§ï¸</div>
                            <div>
                                <div class="macro-name">Kericho Rain</div>
                                <div class="macro-subtext">Kenya highlands</div>
                            </div>
                        </div>
                        <div class="macro-value">
                            <div class="macro-price" id="macro-rain">+24mm</div>
                            <div class="macro-change up" id="macro-rain-change">Above avg</div>
                            <div class="macro-impact bearish">Bearish Price</div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-info">
                            <div class="macro-icon weather">â˜€ï¸</div>
                            <div>
                                <div class="macro-name">Assam Weather</div>
                                <div class="macro-subtext">India region</div>
                            </div>
                        </div>
                        <div class="macro-value">
                            <div class="macro-price" id="macro-assam">-12mm</div>
                            <div class="macro-change down" id="macro-assam-change">Below avg</div>
                            <div class="macro-impact bullish">Bullish Price</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Top Movers</div>
                <div class="movers-grid">
                    <div class="mover-card">
                        <div class="mover-label">Top Gainer</div>
                        <div class="mover-name">SFTGFOP1</div>
                        <div class="mover-value up">+12.4%</div>
                    </div>
                    <div class="mover-card">
                        <div class="mover-label">Top Loser</div>
                        <div class="mover-name">Fannings</div>
                        <div class="mover-value down">-4.2%</div>
                    </div>
                    <div class="mover-card">
                        <div class="mover-label">Most Volume</div>
                        <div class="mover-name">BP1</div>
                        <div class="mover-value">2.1M kg</div>
                    </div>
                    <div class="mover-card">
                        <div class="mover-label">Highest Bid</div>
                        <div class="mover-name">Silver Tips</div>
                        <div class="mover-value up">$128/kg</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Auction Centers</div>
                <div class="watchlist-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                    <div style="display: flex; justify-content: space-between; width: 100%;">
                        <span class="watchlist-name">Mombasa</span>
                        <span class="up" style="font-size: 12px;">â— LIVE</span>
                    </div>
                    <div class="volume-bar" style="width: 100%;"><div class="volume-fill" style="width: 85%;"></div></div>
                </div>
                <div class="watchlist-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                    <div style="display: flex; justify-content: space-between; width: 100%;">
                        <span class="watchlist-name">Kolkata</span>
                        <span style="color: var(--text-muted); font-size: 12px;">Opens 09:30</span>
                    </div>
                    <div class="volume-bar" style="width: 100%;"><div class="volume-fill" style="width: 0%;"></div></div>
                </div>
                <div class="watchlist-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                    <div style="display: flex; justify-content: space-between; width: 100%;">
                        <span class="watchlist-name">Colombo</span>
                        <span style="color: var(--accent-orange); font-size: 12px;">â— Pre-Market</span>
                    </div>
                    <div class="volume-bar" style="width: 100%;"><div class="volume-fill" style="width: 20%;"></div></div>
                </div>
            </div>

            <!-- Upcoming Auctions (moved from right panel) -->
            <div class="sidebar-section">
                <div class="sidebar-title">Upcoming Auctions</div>
                <div class="calendar-item">
                    <div class="calendar-date">
                        <div class="calendar-day">12</div>
                        <div class="calendar-month">Feb</div>
                    </div>
                    <div class="calendar-info">
                        <div class="calendar-name">Mombasa Sale 06</div>
                        <div class="calendar-center">Kenya Tea Exchange</div>
                    </div>
                    <span class="calendar-status live">LIVE</span>
                </div>
                <div class="calendar-item">
                    <div class="calendar-date">
                        <div class="calendar-day">13</div>
                        <div class="calendar-month">Feb</div>
                    </div>
                    <div class="calendar-info">
                        <div class="calendar-name">Kolkata Auction 08</div>
                        <div class="calendar-center">Calcutta Tea Traders</div>
                    </div>
                    <span class="calendar-status upcoming">09:30 IST</span>
                </div>
                <div class="calendar-item">
                    <div class="calendar-date">
                        <div class="calendar-day">14</div>
                        <div class="calendar-month">Feb</div>
                    </div>
                    <div class="calendar-info">
                        <div class="calendar-name">Colombo Weekly</div>
                        <div class="calendar-center">Ceylon Tea Board</div>
                    </div>
                    <span class="calendar-status upcoming">10:00 LKT</span>
                </div>
            </div>
            
            <!-- IB Chat Section -->
            <div class="sidebar-section chat-section">
                <div class="chat-header">
                    <div class="chat-title">
                        TT Messenger
                        <span class="chat-online" id="chat-online-count">0 online</span>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be populated dynamically -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Type a message... (@user for DM)">
                    <button class="chat-send" id="chat-send-btn" onclick="sendChatMessage()">Send</button>
                    <button class="chat-blast" title="BLAST" onclick="sendBlastMessage()"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Center Content -->
        <div class="center-content">
            <!-- Chart Section -->
            <div class="chart-section" id="chart-section">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">
                            <h2 id="main-chart-title">Kenyan Tea Price Index</h2>
                            <span class="chart-badge">Live</span>
                        </div>
                        <div class="chart-stats">
                            <div class="chart-stat">
                                <div class="chart-stat-value up" id="main-chart-price">$3.42</div>
                                <div class="chart-stat-label">Last Trade Price (USD/kg)</div>
                            </div>
                            <div class="chart-stat">
                                <div class="chart-stat-value" style="font-size: 20px;" id="main-chart-change">+$0.08 (+2.4%)</div>
                                <div class="chart-stat-label">Change Today</div>
                            </div>
                            <div class="chart-stat">
                                <div class="chart-stat-value" style="font-size: 20px;" id="main-chart-volume">8.2M</div>
                                <div class="chart-stat-label">Volume (kg)</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-controls">
                        <button class="maximize-btn" onclick="toggleMaximize('chart-section')" title="Maximize">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                            </svg>
                        </button>
                        <div class="timeframe-dropdown">
                            <button class="timeframe-btn" id="timeframe-btn" onclick="toggleTimeframeMenu()">
                                <span id="timeframe-label">1W</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M6 9l6 6 6-6"/></svg>
                            </button>
                            <div class="timeframe-menu" id="timeframe-menu">
                                <div class="timeframe-item" onclick="setTimeframe('1D')">1D</div>
                                <div class="timeframe-item active" onclick="setTimeframe('1W')">1W</div>
                                <div class="timeframe-item" onclick="setTimeframe('1M')">1M</div>
                                <div class="timeframe-item" onclick="setTimeframe('3M')">3M</div>
                                <div class="timeframe-item" onclick="setTimeframe('1Y')">1Y</div>
                                <div class="timeframe-item" onclick="setTimeframe('ALL')">ALL</div>
                            </div>
                        </div>
                        <div class="chart-type-toggle">
                            <button class="chart-type-btn active" id="btn-line" onclick="setChartType('line')" title="Line Chart">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17l6-6 4 4 8-8"/></svg>
                            </button>
                            <button class="chart-type-btn" id="btn-candle" onclick="setChartType('candle')" title="Candlestick">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="8" width="4" height="8"/><line x1="7" y1="4" x2="7" y2="8"/><line x1="7" y1="16" x2="7" y2="20"/><rect x="15" y="6" width="4" height="10" fill="currentColor"/><line x1="17" y1="2" x2="17" y2="6"/><line x1="17" y1="16" x2="17" y2="22"/></svg>
                            </button>
                        </div>
                        <div class="studies-dropdown">
                            <button class="studies-btn" id="studies-btn" onclick="toggleStudiesMenu()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/></svg>
                                Studies
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M6 9l6 6 6-6"/></svg>
                            </button>
                            <div class="studies-menu" id="studies-menu">
                                <div class="studies-item" onclick="toggleStudy('sma10')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #facc15;"></span>
                                        SMA (10)
                                    </div>
                                    <div class="studies-toggle" id="toggle-sma10"></div>
                                </div>
                                <div class="studies-item" onclick="toggleStudy('sma20')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #f59e0b;"></span>
                                        SMA (20)
                                    </div>
                                    <div class="studies-toggle" id="toggle-sma20"></div>
                                </div>
                                <div class="studies-item" onclick="toggleStudy('sma50')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #8b5cf6;"></span>
                                        SMA (50)
                                    </div>
                                    <div class="studies-toggle" id="toggle-sma50"></div>
                                </div>
                                <div class="studies-divider"></div>
                                <div class="studies-item" onclick="toggleStudy('ema10')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #34d399;"></span>
                                        EMA (10)
                                    </div>
                                    <div class="studies-toggle" id="toggle-ema10"></div>
                                </div>
                                <div class="studies-item" onclick="toggleStudy('ema20')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #10b981;"></span>
                                        EMA (20)
                                    </div>
                                    <div class="studies-toggle" id="toggle-ema20"></div>
                                </div>
                                <div class="studies-divider"></div>
                                <div class="studies-item" onclick="toggleStudy('bollinger')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #60a5fa;"></span>
                                        Bollinger Bands
                                    </div>
                                    <div class="studies-toggle" id="toggle-bollinger"></div>
                                </div>
                                <div class="studies-divider"></div>
                                <div class="studies-item" onclick="toggleStudy('rsi')">
                                    <div class="studies-item-label">
                                        <span class="studies-color" style="background: #ec4899;"></span>
                                        RSI (14)
                                    </div>
                                    <div class="studies-toggle" id="toggle-rsi"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container" id="chart-container">
                    <canvas id="priceChart" class="chart-canvas"></canvas>
                    <div class="chart-tooltip" id="chart-tooltip"></div>
                    <div class="chart-crosshair" id="chart-crosshair">
                        <div class="crosshair-v"></div>
                        <div class="crosshair-h"></div>
                    </div>
                </div>
                
                <!-- RSI Sub-Chart -->
                <div class="rsi-chart-container" id="rsi-chart-container" style="display: none;">
                    <div class="rsi-header">
                        <span class="rsi-label">RSI (14)</span>
                        <span class="rsi-value" id="rsi-value">â€”</span>
                    </div>
                    <canvas id="rsiChart" class="rsi-canvas"></canvas>
                    <div class="rsi-crosshair" id="rsi-crosshair">
                        <div class="crosshair-v"></div>
                        <div class="crosshair-h"></div>
                    </div>
                    <div class="rsi-tooltip" id="rsi-tooltip"></div>
                </div>
                
                <!-- Market Depth Heatmap -->
                <div class="market-depth-container" id="market-depth-container">
                    <div class="market-depth-header">
                        <span class="market-depth-title">Market Depth</span>
                        <span class="market-depth-ratio" id="depth-ratio">Bid/Ask: 1.12</span>
                    </div>
                    <div class="market-depth-bar">
                        <div class="depth-bids" id="depth-bids" style="width: 52%;">
                            <span class="depth-label">BIDS 52%</span>
                        </div>
                        <div class="depth-asks" id="depth-asks" style="width: 48%;">
                            <span class="depth-label">ASKS 48%</span>
                        </div>
                    </div>
                    <div class="market-depth-levels">
                        <span id="depth-bid-volume">Vol: 12,450 kg</span>
                        <span id="depth-mid-price">Mid: $4.82</span>
                        <span id="depth-ask-volume">Vol: 11,200 kg</span>
                    </div>
                </div>
            </div>

            <!-- Flash Quote Board -->
            <div class="quote-board-section">
                <div class="quote-board" id="quote-board">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Auction Data Table -->
            <div class="auction-section">
                <div class="section-header">
                    <div class="section-title">Live Auction Results â€” Mombasa Sale 06/2026</div>
                    <div class="section-filters">
                        <div class="market-toggle">
                            <button class="toggle-btn active" id="toggle-singles" onclick="setMarketView('singles')">Singles</button>
                            <button class="toggle-btn" id="toggle-pairs" onclick="setMarketView('pairs')">Pairs</button>
                        </div>
                        <div class="grade-filters" id="grade-filters">
                            <button class="filter-btn active">All Grades</button>
                            <button class="filter-btn">Orthodox</button>
                            <button class="filter-btn">CTC</button>
                        </div>
                    </div>
                </div>
                <!-- Singles Table -->
                <div id="singles-view">
                <div class="auction-table-wrapper">
                <table class="data-table" id="auction-table">
                    <thead>
                        <tr>
                            <th>Lot #</th>
                            <th>Grade</th>
                            <th>Estate / Factory</th>
                            <th>Origin</th>
                            <th>Qty (kg)</th>
                            <th>Bid $/kg</th>
                            <th>Change</th>
                            <th>Buyer</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="auction-table-body">
                        <!-- Populated dynamically from database -->
                    </tbody>
                </table>
                </div>
                </div>
                <!-- Pairs Table -->
                <div id="pairs-view" style="display: none;">
                <div class="pairs-table-wrapper">
                <table class="data-table" id="pairs-table">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Base Price</th>
                            <th>Quote Price</th>
                            <th>Ratio</th>
                            <th>Change</th>
                            <th>Spread</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pairs-table-body">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
                </div>
                </div>
            </div>
        
            <!-- Order History Section -->
            <div class="order-history-section">
                <div class="order-history-header">
                    <div class="order-history-title">
                        Your Confirmed Orders
                        <span class="order-count" id="order-count">0</span>
                    </div>
                    <div class="order-filter-buttons">
                        <button class="filter-btn" id="filter-open" onclick="setOrdersFilter('open')">Open</button>
                        <button class="filter-btn active" id="filter-all" onclick="setOrdersFilter('all')">All</button>
                    </div>
                </div>
                <div class="order-table-wrapper">
                <table class="order-table" id="orders-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="time" onclick="sortOrdersTable('time')">Time</th>
                            <th>Order ID</th>
                            <th class="sortable" data-sort="tea" onclick="sortOrdersTable('tea')">Tea</th>
                            <th>Side</th>
                            <th class="sortable" data-sort="qty" onclick="sortOrdersTable('qty')">Qty (kg)</th>
                            <th class="sortable" data-sort="entry" onclick="sortOrdersTable('entry')">Entry</th>
                            <th class="sortable" data-sort="total" onclick="sortOrdersTable('total')">Total</th>
                            <th class="sortable" data-sort="pnl" onclick="sortOrdersTable('pnl')">P/L</th>
                            <th class="sortable" data-sort="status" onclick="sortOrdersTable('status')">Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                No orders yet. Start trading!
                            </td>
                        </tr>
                    </tbody>
                    <tfoot id="orders-tfoot" style="display: none;">
                        <tr>
                            <td colspan="4" style="text-align: right; color: var(--text-muted);">OPEN POSITIONS TOTAL</td>
                            <td></td>
                            <td></td>
                            <td id="tfoot-total" class="order-price">$0.00</td>
                            <td id="tfoot-pnl">$0.00</td>
                            <td id="tfoot-count"><span style="color: var(--text-muted);">0 open</span></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Trading Panel -->
            <div class="panel-section trading-panel">
                <div class="panel-title">
                    Trade
                    <span class="live-badge">PAPER</span>
                </div>
                <div class="trade-form" id="trade-form">
                    <div class="trade-type-toggle">
                        <button type="button" class="trade-type-btn buy active" id="btn-trade-buy" onclick="setTradeType('BUY')">BUY</button>
                        <button type="button" class="trade-type-btn sell" id="btn-trade-sell" onclick="setTradeType('SELL')">SELL</button>
                    </div>
                    <select class="trade-select" id="trade-tea-select" onchange="updateTradeSummary()">
                        <option value="">Select Tea...</option>
                    </select>
                    <div class="trade-input-row">
                        <div class="trade-input-group">
                            <label>Quantity (kg)</label>
                            <input type="number" class="trade-input" id="trade-qty" placeholder="100" min="1" step="1" oninput="updateTradeSummary()">
                        </div>
                        <div class="trade-input-group">
                            <label>Price ($/kg)</label>
                            <input type="number" class="trade-input" id="trade-price" placeholder="3.42" step="0.001" readonly>
                        </div>
                    </div>
                    <div class="trade-summary">
                        <div class="trade-summary-row">
                            <span class="trade-summary-label">Order Value</span>
                            <span class="trade-summary-value" id="trade-value">$0.00</span>
                        </div>
                        <div class="trade-summary-row">
                            <span class="trade-summary-label">Your Balance</span>
                            <span class="trade-summary-value" id="trade-balance">$10,000.00</span>
                        </div>
                    </div>
                    <div class="sltp-section">
                        <div class="sltp-group">
                            <label class="sltp-label"><span class="dot sl"></span>Stop Loss</label>
                            <div class="sltp-input-wrapper">
                                <input type="number" class="sltp-input" id="trade-sl" placeholder="3.20" step="0.01">
                                <div class="sltp-arrows">
                                    <button type="button" class="sltp-arrow" onclick="adjustSlTp('trade-sl', 0.01)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg>
                                    </button>
                                    <button type="button" class="sltp-arrow" onclick="adjustSlTp('trade-sl', -0.01)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="sltp-group">
                            <label class="sltp-label"><span class="dot tp"></span>Take Profit</label>
                            <div class="sltp-input-wrapper">
                                <input type="number" class="sltp-input" id="trade-tp" placeholder="3.80" step="0.01">
                                <div class="sltp-arrows">
                                    <button type="button" class="sltp-arrow" onclick="adjustSlTp('trade-tp', 0.01)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg>
                                    </button>
                                    <button type="button" class="sltp-arrow" onclick="adjustSlTp('trade-tp', -0.01)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="trade-execute-btn buy" id="trade-execute-btn" onclick="executeTrade()">
                        Sign in to Trade
                    </button>
                </div>
            </div>

            <!-- Portfolio Section -->
            <div class="panel-section portfolio-section" id="portfolio-section" style="display: none;">
                <div class="panel-title">Your Portfolio</div>
                <div class="portfolio-tabs">
                    <button class="portfolio-tab active" onclick="switchPortfolioTab('positions')">Positions</button>
                    <button class="portfolio-tab" onclick="switchPortfolioTab('history')">History</button>
                </div>
                <div id="portfolio-positions" class="trade-log-container active">
                    <div class="portfolio-header">
                        <div>
                            <div class="portfolio-value" id="portfolio-value">$10,000.00</div>
                            <div class="portfolio-pnl up" id="portfolio-pnl">+$0.00 (0.00%)</div>
                        </div>
                    </div>
                    <div id="positions-list">
                        <div style="color: var(--text-muted); font-size: 12px; padding: 20px 0; text-align: center;">
                            No positions yet. Start trading!
                        </div>
                    </div>
                </div>
                <div id="portfolio-history" class="trade-log-container">
                    <div class="trade-log-stats">
                        <div class="trade-stat">
                            <div class="trade-stat-value up" id="stat-total-pnl">+$0.00</div>
                            <div class="trade-stat-label">Total P&L</div>
                        </div>
                        <div class="trade-stat">
                            <div class="trade-stat-value" id="stat-win-rate">0%</div>
                            <div class="trade-stat-label">Win Rate</div>
                        </div>
                        <div class="trade-stat">
                            <div class="trade-stat-value" id="stat-trades">0</div>
                            <div class="trade-stat-label">Total Trades</div>
                        </div>
                        <div class="trade-stat">
                            <div class="trade-stat-value" id="stat-avg-hold">â€”</div>
                            <div class="trade-stat-label">Avg Hold</div>
                        </div>
                    </div>
                    <table class="trade-log-table">
                        <thead>
                            <tr>
                                <th>Tea</th>
                                <th>Type</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>Hold</th>
                            </tr>
                        </thead>
                        <tbody id="trade-log-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">No closed trades yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="panel-section leaderboard-section">
                <div class="panel-title">
                    Leaderboard
                    <span style="font-size: 10px; color: var(--accent-orange);">FEB 2026</span>
                </div>
                <div id="leaderboard-list">
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank gold">1</div>
                        <div class="leaderboard-name">tea_magnate</div>
                        <div class="leaderboard-return up">+24.5%</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank silver">2</div>
                        <div class="leaderboard-name">ceylon_king</div>
                        <div class="leaderboard-return up">+18.2%</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank bronze">3</div>
                        <div class="leaderboard-name">mombasa_trader</div>
                        <div class="leaderboard-return up">+15.7%</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">4</div>
                        <div class="leaderboard-name">darjeeling_pro</div>
                        <div class="leaderboard-return up">+12.1%</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">5</div>
                        <div class="leaderboard-name">assam_bull</div>
                        <div class="leaderboard-return up">+9.8%</div>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">
                    Market News
                    <span class="live-badge">LIVE</span>
                </div>
                <div class="news-feed">
                    <div class="news-item">
                        <div class="news-time">14:32 UTC</div>
                        <div class="news-headline">
                            <span class="news-tag kenya">KENYA</span>
                            Mombasa auction sees record volume as BP1 grades surge 4.2%
                        </div>
                    </div>
                    <div class="news-item">
                        <div class="news-time">14:18 UTC</div>
                        <div class="news-headline">
                            <span class="news-tag india">INDIA</span>
                            Darjeeling first flush arrives early; quality reports exceptional
                        </div>
                    </div>
                    <div class="news-item">
                        <div class="news-time">13:45 UTC</div>
                        <div class="news-headline">
                            <span class="news-tag sri-lanka">SRI LANKA</span>
                            Ceylon tea exports up 8% YoY as European demand strengthens
                        </div>
                    </div>
                    <div class="news-item">
                        <div class="news-time">12:20 UTC</div>
                        <div class="news-headline">
                            <span class="news-tag china">CHINA</span>
                            Yunnan Pu-erh vintage releases fetch premium at Kunming fair
                        </div>
                    </div>
                    <div class="news-item">
                        <div class="news-time">11:05 UTC</div>
                        <div class="news-headline">
                            <span class="news-tag kenya">KENYA</span>
                            Weather outlook favorable for Q1 harvest across Rift Valley
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Book / Depth of Market -->
            <div class="panel-section order-book-section">
                <div class="panel-title">
                    Order Book (Mombasa BP1)
                    <span class="live-badge">LIVE</span>
                </div>
                
                <div class="order-book-container">
                    <div class="ob-row ob-header">
                        <span>Price (USD)</span>
                        <span>Qty (Tons)</span>
                        <span>Total</span>
                    </div>

                    <!-- Asks (Sellers) -->
                    <div class="ob-row">
                        <span class="ob-price-down">3.48</span>
                        <span>12.5</span>
                        <span>45.2</span>
                        <div class="depth-bar ask-bar" style="width: 20%"></div>
                    </div>
                    <div class="ob-row">
                        <span class="ob-price-down">3.47</span>
                        <span>45.0</span>
                        <span>32.7</span>
                        <div class="depth-bar ask-bar" style="width: 60%"></div>
                    </div>
                    <div class="ob-row">
                        <span class="ob-price-down">3.46</span>
                        <span>22.1</span>
                        <span>22.1</span>
                        <div class="depth-bar ask-bar" style="width: 35%"></div>
                    </div>

                    <!-- Spread -->
                    <div class="ob-spread">
                        <span class="ob-spread-label">Spread: 0.02 (0.58%)</span>
                        <div class="ob-spread-price">$3.44</div>
                    </div>

                    <!-- Bids (Buyers) -->
                    <div class="ob-row">
                        <span class="ob-price-up">3.44</span>
                        <span>150.0</span>
                        <span>150.0</span>
                        <div class="depth-bar bid-bar" style="width: 90%"></div>
                    </div>
                    <div class="ob-row">
                        <span class="ob-price-up">3.43</span>
                        <span>80.5</span>
                        <span>230.5</span>
                        <div class="depth-bar bid-bar" style="width: 50%"></div>
                    </div>
                    <div class="ob-row">
                        <span class="ob-price-up">3.42</span>
                        <span>40.2</span>
                        <span>270.7</span>
                        <div class="depth-bar bid-bar" style="width: 30%"></div>
                    </div>
                    <div class="ob-row">
                        <span class="ob-price-up">3.41</span>
                        <span>65.8</span>
                        <span>336.5</span>
                        <div class="depth-bar bid-bar" style="width: 45%"></div>
                    </div>
                    <div class="ob-row">
                        <span class="ob-price-up">3.40</span>
                        <span>28.3</span>
                        <span>364.8</span>
                        <div class="depth-bar bid-bar" style="width: 22%"></div>
                    </div>

                    <!-- Lock Overlay -->
                    <div class="ob-blur-overlay">
                        <div class="ob-lock-content">
                            <div class="ob-lock-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <h4>Institutional Data</h4>
                            <p>Real-time bid/ask depth limited to Exchange Partners</p>
                            <button class="ob-btn-access" onclick="document.getElementById('early-access-modal').style.display='flex'">Request Access</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">Top Buyers This Week</div>
                <div style="font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span>1. Unilever</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">2.4M kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span>2. Tata Global</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">1.8M kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span>3. Finlays</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">1.2M kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span>4. Van Rees</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">980K kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span>5. Ekaterra</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">850K kg</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
        <div class="bottom-stat">
            <span>Last Update: <span style="color: var(--text-primary);">14:32:08 UTC</span></span>
            <span>Session: <span style="color: var(--accent-green);">Active</span></span>
            <span>Latency: <span style="color: var(--text-primary);">24ms</span></span>
        </div>
        <div class="bottom-stat">
            <span>Markets: <span style="color: var(--text-primary);">5 Open</span></span>
            <span>Lots Today: <span style="color: var(--text-primary);">847</span></span>
            <span>Â© 2026 TeaTrade Exchange</span>
        </div>
    </div>

    <script>
        // =============================================
        // SUPABASE INITIALIZATION - MUST BE FIRST
        // =============================================
        const SUPABASE_URL = 'https://uznxzyuknigzlxecjgtb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6bnh6eXVrbmlnemx4ZWNqZ3RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5Mzc5ODUsImV4cCI6MjA4NjUxMzk4NX0.BVOTqZ9kn2KCrNeF5675PNmMi9oJN3F6OoUnTtbpuIg';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global State
        let currentUser = null;
        let userProfile = null;
        let teas = [];
        let positions = [];
        
        // Chart state
        let currentTimeframe = '1W';
        let chartType = 'line'; // 'line' or 'candle'
        let chartData = [];
        let teaHistoricalData = {}; // Stores price history per tea symbol
        
        // Market indices data structure - tracks current data at each position
        let mainChartData = { name: 'Kenyan Tea Price Index', symbol: 'KENYAN', basePrice: 3.42, change: 2.4, currency: '$', volume: '8.2M' };
        let cardData = [
            { name: 'Mombasa Auction Index', symbol: 'MOMBASA', basePrice: 2.87, change: 1.8, currency: '$', volume: '6.8M' },
            { name: 'Kolkata Tea Index', symbol: 'KOLKATA', basePrice: 267.45, change: 3.2, currency: 'â‚¹', volume: '4.2M' },
            { name: 'Colombo Index', symbol: 'COLOMBO', basePrice: 3.24, change: -1.8, currency: '$', volume: '5.1M' },
            { name: 'Global Tea Futures', symbol: 'FUTURES', basePrice: 3847, change: 0.7, currency: '$', volume: '12.4M' }
        ];
        let indexHistoricalData = {}; // Stores historical data for each index by symbol
        
        // Generate historical data for an index
        function generateIndexHistory(index) {
            if (!index || indexHistoricalData[index.symbol]) return indexHistoricalData[index.symbol] || [];
            
            const currentPrice = index.basePrice;
            const change = index.change;
            const volatility = Math.abs(change) / 100 + 0.015;
            
            const data = [];
            const points = 720;
            const now = new Date();
            
            let price = currentPrice * (1 - change / 100); // Start from yesterday's close
            for (let i = points - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setHours(date.getHours() - i);
                
                const trendBias = i < 24 ? (change / 100) / 24 : 0;
                const noise = (Math.random() - 0.5) * volatility * currentPrice;
                
                const open = price;
                price = Math.max(currentPrice * 0.85, Math.min(currentPrice * 1.15, price + noise + trendBias * currentPrice));
                const close = i === 0 ? currentPrice : price;
                const high = Math.max(open, close) * (1 + Math.random() * 0.008);
                const low = Math.min(open, close) * (1 - Math.random() * 0.008);
                const volume = Math.round(50000 + Math.random() * 200000);
                
                data.push({
                    date: date,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: volume,
                    change: ((close - open) / open * 100)
                });
            }
            
            indexHistoricalData[index.symbol] = data;
            return data;
        }
        
        // Swap chart with a market card index
        function swapChartIndex(cardIndex) {
            const clickedCardData = cardData[cardIndex];
            if (!clickedCardData) return;
            
            // Store current main chart data
            const previousMainData = { ...mainChartData };
            
            // Animate out
            const chartSection = document.getElementById('chart-section');
            chartSection.style.opacity = '0.7';
            chartSection.style.transform = 'scale(0.98)';
            
            setTimeout(() => {
                // Update main chart with clicked card's data
                mainChartData = { ...clickedCardData };
                document.getElementById('main-chart-title').textContent = mainChartData.name;
                const priceEl = document.getElementById('main-chart-price');
                priceEl.textContent = formatIndexPrice(mainChartData.basePrice, mainChartData.currency);
                priceEl.className = 'chart-stat-value ' + (mainChartData.change >= 0 ? 'up' : 'down');
                
                const changeVal = mainChartData.change >= 0 ? '+' : '';
                document.getElementById('main-chart-change').textContent = `${changeVal}${mainChartData.change.toFixed(1)}%`;
                document.getElementById('main-chart-volume').textContent = mainChartData.volume;
                
                // Update the clicked card with the previous main chart data
                cardData[cardIndex] = previousMainData;
                document.querySelector(`#market-card-${cardIndex} .market-card-label`).textContent = previousMainData.name;
                document.getElementById(`card-value-${cardIndex}`).textContent = formatIndexPrice(previousMainData.basePrice, previousMainData.currency);
                const cardChangeEl = document.getElementById(`card-change-${cardIndex}`);
                cardChangeEl.textContent = (previousMainData.change >= 0 ? 'â–² +' : 'â–¼ ') + Math.abs(previousMainData.change).toFixed(1) + '%';
                cardChangeEl.className = 'market-card-change ' + (previousMainData.change >= 0 ? 'up' : 'down');
                
                // Regenerate chart with new index data
                cachedTimeframe = null;
                chartData = [];
                drawChart();
                
                // Animate back in
                chartSection.style.opacity = '1';
                chartSection.style.transform = 'scale(1)';
            }, 150);
        }
        
        function formatIndexPrice(price, currency) {
            if (price >= 1000) {
                return currency + price.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
            return currency + price.toFixed(2);
        }
        
        // Generate and cache historical data for a specific tea
        function generateTeaHistory(tea) {
            if (!tea || !tea.symbol) return [];
            
            const symbol = tea.symbol;
            if (teaHistoricalData[symbol]) return teaHistoricalData[symbol];
            
            const currentPrice = tea.current_price || 3.20;
            const change24h = tea.price_change_24h || 0;
            const volatility = Math.abs(change24h) / 100 + 0.02; // More volatile teas have bigger swings
            
            // Generate realistic historical data points (30 days of hourly data = 720 points)
            const data = [];
            const points = 720;
            const now = new Date();
            
            // Work backwards from current price
            let price = currentPrice;
            for (let i = points - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setHours(date.getHours() - i);
                
                // Add some trend based on the 24h change
                const trendBias = i < 24 ? (change24h / 100) / 24 : 0;
                const noise = (Math.random() - 0.5) * volatility * currentPrice;
                
                const open = price;
                price = Math.max(currentPrice * 0.8, Math.min(currentPrice * 1.2, price + noise + trendBias * currentPrice));
                const close = i === 0 ? currentPrice : price; // Last point = current price
                const high = Math.max(open, close) * (1 + Math.random() * 0.01);
                const low = Math.min(open, close) * (1 - Math.random() * 0.01);
                const volume = Math.round(50000 + Math.random() * 200000);
                
                data.push({
                    date: date,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: volume,
                    change: ((close - open) / open * 100)
                });
            }
            
            teaHistoricalData[symbol] = data;
            return data;
        }
        let chartMetrics = {};
        let cachedTimeframe = null; // Track which timeframe data was generated for
        const leftMargin = 50;
        const rightMargin = 20;
        const bottomMargin = 25;
        
        // Studies state
        let activeStudies = {
            sma10: false,
            sma20: false,
            sma50: false,
            ema10: false,
            ema20: false,
            bollinger: false,
            rsi: false
        };
        
        const studyColors = {
            sma10: '#facc15',
            sma20: '#f59e0b',
            sma50: '#8b5cf6',
            ema10: '#34d399',
            ema20: '#10b981',
            bollinger: '#60a5fa',
            rsi: '#ec4899'
        };
        
        // Price alerts
        let priceAlerts = {};
        
        // Stop Loss / Take Profit pending orders
        // Structure: { teaId: { sl: number|null, tp: number|null, side: 'BUY'|'SELL', qty: number } }
        let pendingSlTpOrders = {};
        
        const canvas = document.getElementById('priceChart');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('chart-tooltip');
        const chartContainer = document.getElementById('chart-container');
        const crosshair = document.getElementById('chart-crosshair');
        
        // Timeframe configurations - need enough data points for indicators
        const timeframeConfig = {
            '1D': { points: 96, labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'], labelFormat: 'time', baseDate: new Date() },
            '1W': { points: 56, labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], labelFormat: 'day', baseDate: new Date() },
            '1M': { points: 60, labels: ['W1', 'W2', 'W3', 'W4'], labelFormat: 'week', baseDate: new Date() },
            '3M': { points: 90, labels: ['Jan', 'Feb', 'Mar'], labelFormat: 'month', baseDate: new Date() },
            '1Y': { points: 120, labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], labelFormat: 'month', baseDate: new Date() },
            'ALL': { points: 180, labels: ['2021', '2022', '2023', '2024', '2025', '2026'], labelFormat: 'year', baseDate: new Date() }
        };
        
        function toggleTimeframeMenu() {
            const menu = document.getElementById('timeframe-menu');
            menu.classList.toggle('visible');
        }
        
        function setTimeframe(tf) {
            currentTimeframe = tf;
            
            // Update dropdown label
            document.getElementById('timeframe-label').textContent = tf;
            
            // Update active state in menu
            document.querySelectorAll('.timeframe-item').forEach(item => {
                item.classList.toggle('active', item.textContent === tf);
            });
            
            // Close menu
            document.getElementById('timeframe-menu').classList.remove('visible');
            
            drawChart();
        }
        
        // Close timeframe menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.timeframe-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('timeframe-menu').classList.remove('visible');
            }
        });
        
        function setChartType(type) {
            chartType = type;
            document.getElementById('btn-line').classList.toggle('active', type === 'line');
            document.getElementById('btn-candle').classList.toggle('active', type === 'candle');
            drawChart();
        }
        
        function generateChartData(timeframe) {
            const config = timeframeConfig[timeframe];
            if (!config) return generateDefaultChartData({ points: 50 }, timeframe || '1W');
            
            // Check if displaying the default Kenyan index (no tea selected)
            const select = document.getElementById('trade-tea-select');
            const selectedSymbol = select?.value;
            const selectedTea = teas && teas.find(t => t.symbol === selectedSymbol);
            
            // If we have a selected tea with history, use it
            if (selectedTea) {
                const fullHistory = generateTeaHistory(selectedTea);
                return sampleHistoricalData(fullHistory, timeframe, config);
            }
            
            // Use the current main chart index data
            const fullHistory = generateIndexHistory(mainChartData);
            return sampleHistoricalData(fullHistory, timeframe, config);
        }
        
        function sampleHistoricalData(fullHistory, timeframe, config) {
            if (!fullHistory || fullHistory.length === 0) {
                return generateDefaultChartData(config, timeframe);
            }
            
            let sampledData = [];
            if (timeframe === '1D') {
                sampledData = fullHistory.slice(-24); // Last 24 hours
            } else if (timeframe === '1W') {
                // Sample every 4 hours for a week
                const startIndex = Math.max(0, fullHistory.length - 168);
                for (let i = startIndex; i < fullHistory.length; i += 4) {
                    sampledData.push(fullHistory[i]);
                }
            } else if (timeframe === '1M') {
                // Sample every 24 hours for a month
                for (let i = 0; i < fullHistory.length; i += 24) {
                    sampledData.push(fullHistory[i]);
                }
            } else {
                sampledData = fullHistory.slice(-config.points);
            }
            
            return sampledData.length > 0 ? sampledData : generateDefaultChartData(config, timeframe);
        }
        
        function generateDefaultChartData(config, timeframe) {
            const data = [];
            let price = 3.20;
            let volume = 800000;
            const now = new Date();
            
            for (let i = 0; i < config.points; i++) {
                const open = price;
                const change = (Math.random() - 0.48) * 0.06;
                price = Math.max(3.05, Math.min(3.55, price + change));
                const close = price;
                const high = Math.max(open, close) + Math.random() * 0.03;
                const low = Math.min(open, close) - Math.random() * 0.03;
                volume = Math.max(500000, volume + (Math.random() - 0.5) * 200000);
                
                // Generate timestamp based on timeframe
                let date = new Date(now);
                if (timeframe === '1D') date.setHours(date.getHours() - (config.points - i));
                else if (timeframe === '1W') date.setDate(date.getDate() - (config.points - i));
                else if (timeframe === '1M') date.setDate(date.getDate() - (config.points - i));
                else if (timeframe === '3M') date.setDate(date.getDate() - (config.points - i) * 7);
                else if (timeframe === '1Y') date.setMonth(date.getMonth() - (config.points - i));
                else date.setMonth(date.getMonth() - (config.points - i));
                
                data.push({
                    date: date,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: Math.round(volume),
                    change: ((close - open) / open * 100)
                });
            }
            return data;
        }
        
        function formatDate(date, timeframe) {
            if (timeframe === '1D') {
                return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            } else if (timeframe === '1W' || timeframe === '1M') {
                return date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            } else {
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            }
        }
        
        function formatVolume(vol) {
            if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
            if (vol >= 1000) return (vol / 1000).toFixed(0) + 'K';
            return vol.toString();
        }
        
        // =============================================
        // TECHNICAL INDICATOR CALCULATIONS
        // =============================================
        
        function calculateSMA(data, period) {
            const sma = [];
            let firstValue = null;
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    sma.push(null); // Will backfill later
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j].close;
                    }
                    const val = sum / period;
                    if (firstValue === null) firstValue = val;
                    sma.push(val);
                }
            }
            
            // Backfill nulls with first calculated value
            for (let i = 0; i < sma.length; i++) {
                if (sma[i] === null && firstValue !== null) {
                    sma[i] = firstValue;
                } else {
                    break;
                }
            }
            
            return sma;
        }
        
        function calculateEMA(data, period) {
            const ema = [];
            const multiplier = 2 / (period + 1);
            let firstValue = null;
            
            // Start with SMA for first EMA value
            let sum = 0;
            for (let i = 0; i < period && i < data.length; i++) {
                sum += data[i].close;
            }
            let prevEma = sum / Math.min(period, data.length);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    ema.push(null);
                } else if (i === period - 1) {
                    if (firstValue === null) firstValue = prevEma;
                    ema.push(prevEma);
                } else {
                    const currentEma = (data[i].close - prevEma) * multiplier + prevEma;
                    ema.push(currentEma);
                    prevEma = currentEma;
                }
            }
            
            // Backfill nulls with first calculated value
            for (let i = 0; i < ema.length; i++) {
                if (ema[i] === null && firstValue !== null) {
                    ema[i] = firstValue;
                } else {
                    break;
                }
            }
            
            return ema;
        }
        
        function calculateBollingerBands(data, period = 20, stdDev = 2) {
            const sma = calculateSMA(data, period);
            const upper = [];
            const lower = [];
            let firstUpper = null;
            let firstLower = null;
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    upper.push(null);
                    lower.push(null);
                } else {
                    // Calculate standard deviation
                    let sumSquares = 0;
                    for (let j = 0; j < period; j++) {
                        sumSquares += Math.pow(data[i - j].close - sma[i], 2);
                    }
                    const std = Math.sqrt(sumSquares / period);
                    const u = sma[i] + stdDev * std;
                    const l = sma[i] - stdDev * std;
                    if (firstUpper === null) {
                        firstUpper = u;
                        firstLower = l;
                    }
                    upper.push(u);
                    lower.push(l);
                }
            }
            
            // Backfill nulls
            for (let i = 0; i < upper.length; i++) {
                if (upper[i] === null && firstUpper !== null) {
                    upper[i] = firstUpper;
                    lower[i] = firstLower;
                } else {
                    break;
                }
            }
            
            return { middle: sma, upper, lower };
        }
        
        function calculateRSI(data, period = 14) {
            const rsi = [];
            let gains = [];
            let losses = [];
            let firstValue = null;
            
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    rsi.push(null);
                    continue;
                }
                
                const change = data[i].close - data[i - 1].close;
                const gain = change > 0 ? change : 0;
                const loss = change < 0 ? Math.abs(change) : 0;
                
                gains.push(gain);
                losses.push(loss);
                
                if (i < period) {
                    rsi.push(null);
                } else if (i === period) {
                    const avgGain = gains.reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.reduce((a, b) => a + b, 0) / period;
                    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                    const val = 100 - (100 / (1 + rs));
                    if (firstValue === null) firstValue = val;
                    rsi.push(val);
                } else {
                    // Smoothed averages
                    const prevRsi = rsi[rsi.length - 1];
                    const prevAvgGain = gains.slice(-period - 1, -1).reduce((a, b) => a + b, 0) / period;
                    const prevAvgLoss = losses.slice(-period - 1, -1).reduce((a, b) => a + b, 0) / period;
                    const avgGain = (prevAvgGain * (period - 1) + gain) / period;
                    const avgLoss = (prevAvgLoss * (period - 1) + loss) / period;
                    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                    rsi.push(100 - (100 / (1 + rs)));
                }
            }
            
            // Backfill nulls with first calculated value
            for (let i = 0; i < rsi.length; i++) {
                if (rsi[i] === null && firstValue !== null) {
                    rsi[i] = firstValue;
                } else if (rsi[i] !== null) {
                    break;
                }
            }
            
            return rsi;
        }
        
        function toggleStudiesMenu() {
            const menu = document.getElementById('studies-menu');
            menu.classList.toggle('visible');
        }
        
        function toggleStudy(study) {
            activeStudies[study] = !activeStudies[study];
            const toggle = document.getElementById('toggle-' + study);
            toggle.classList.toggle('active', activeStudies[study]);
            
            // Update button appearance
            const hasActive = Object.values(activeStudies).some(v => v);
            document.getElementById('studies-btn').classList.toggle('has-active', hasActive);
            
            // Show/hide RSI panel
            if (study === 'rsi') {
                const rsiContainer = document.getElementById('rsi-chart-container');
                rsiContainer.style.display = activeStudies.rsi ? 'block' : 'none';
            }
            
            drawChart();
            
            // Draw RSI if active
            if (activeStudies.rsi) {
                drawRSIChart();
            }
        }
        
        // Close studies menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.studies-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('studies-menu').classList.remove('visible');
            }
        });
        
        // =============================================
        // PRICE ALERT SYSTEM
        // =============================================
        
        let currentAlertSymbol = null;
        
        function openPriceAlertModal(symbol, currentPrice) {
            currentAlertSymbol = symbol;
            const modal = document.getElementById('price-alert-modal');
            const existing = priceAlerts[symbol];
            
            document.getElementById('alert-symbol').textContent = symbol;
            document.getElementById('alert-current-price').textContent = `Current: $${currentPrice.toFixed(2)}`;
            document.getElementById('alert-below').value = existing?.below || '';
            document.getElementById('alert-above').value = existing?.above || '';
            document.getElementById('alert-delete-btn').style.display = existing ? 'block' : 'none';
            
            modal.classList.add('active');
        }
        
        function closePriceAlertModal() {
            document.getElementById('price-alert-modal').classList.remove('active');
            currentAlertSymbol = null;
        }
        
        function savePriceAlert() {
            if (!currentAlertSymbol) return;
            
            const below = document.getElementById('alert-below').value ? parseFloat(document.getElementById('alert-below').value) : null;
            const above = document.getElementById('alert-above').value ? parseFloat(document.getElementById('alert-above').value) : null;
            
            if (!below && !above) {
                delete priceAlerts[currentAlertSymbol];
                showToast('Alert Removed', `Price alert for ${currentAlertSymbol} cleared`);
            } else {
                priceAlerts[currentAlertSymbol] = { below, above };
                const alertText = [];
                if (below) alertText.push(`Below $${below.toFixed(2)}`);
                if (above) alertText.push(`Above $${above.toFixed(2)}`);
                showToast('Alert Set!', `${currentAlertSymbol}: ${alertText.join(' | ')}`);
                
                // Request notification permission
                requestNotificationPermission();
            }
            
            closePriceAlertModal();
            updateAuctionTable();
        }
        
        function deletePriceAlert() {
            if (!currentAlertSymbol) return;
            delete priceAlerts[currentAlertSymbol];
            showToast('Alert Deleted', `Price alert for ${currentAlertSymbol} removed`);
            closePriceAlertModal();
            updateAuctionTable();
        }
        
        async function checkPriceAlerts() {
            for (const symbol of Object.keys(priceAlerts)) {
                const alert = priceAlerts[symbol];
                
                // Find the tea (might be actual symbol or display symbol)
                const displayData = teaDisplayData[symbol];
                const priceSymbol = displayData?.priceFrom || symbol;
                const tea = teas.find(t => t.symbol === priceSymbol);
                
                if (!tea) continue;
                
                const currentPrice = tea.current_price;
                let triggered = false;
                let triggerText = '';
                
                if (alert.below && currentPrice <= alert.below) {
                    triggered = true;
                    triggerText = `${symbol} dropped below $${alert.below.toFixed(2)}`;
                } else if (alert.above && currentPrice >= alert.above) {
                    triggered = true;
                    triggerText = `${symbol} rose above $${alert.above.toFixed(2)}`;
                }
                
                if (triggered) {
                    // Remove the alert (one-time trigger)
                    delete priceAlerts[symbol];
                    
                    // Show toast notification
                    showToast('ðŸ”” Price Alert!', `${triggerText} - Now at $${currentPrice.toFixed(2)}`);
                    
                    // Try browser notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('TeaTrade Price Alert', {
                            body: triggerText,
                            icon: '/favicon.ico'
                        });
                    }
                    
                    updateAuctionTable();
                }
            }
        }
        
        // Request notification permission on first alert
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            drawChart();
        }
        
        function drawChart() {
            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            const config = timeframeConfig[currentTimeframe];
            
            if (!config || !w || !h) return;
            
            ctx.clearRect(0, 0, w, h);
            
            // Generate data only when timeframe changes
            if (cachedTimeframe !== currentTimeframe || chartData.length === 0) {
                chartData = generateChartData(currentTimeframe);
                cachedTimeframe = currentTimeframe;
            }
            
            // Guard against empty data
            if (!chartData || chartData.length === 0) {
                chartData = generateDefaultChartData(config, currentTimeframe);
            }
            
            // Final check - if still no data, return
            if (!chartData || chartData.length === 0) return;
            
            const prices = chartData.map(d => d.close);
            if (prices.length === 0) return;
            
            const minPrice = Math.min(...chartData.map(d => d.low)) - 0.03;
            const maxPrice = Math.max(...chartData.map(d => d.high)) + 0.03;
            const priceRange = maxPrice - minPrice;
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            const highPrice = Math.max(...prices);
            const lowPrice = Math.min(...prices);
            const currentPrice = prices[prices.length - 1];
            const openPrice = chartData[0].open;
            const totalChange = ((currentPrice - openPrice) / openPrice * 100);
            
            chartMetrics = { minPrice, maxPrice, priceRange, avgPrice, highPrice, lowPrice, currentPrice, openPrice, totalChange };
            
            const chartWidth = w - leftMargin - rightMargin;
            const chartHeight = h - bottomMargin - (h * 0.1);
            
            // Draw grid lines and Y-axis labels
            ctx.strokeStyle = '#1a2332';
            ctx.lineWidth = 1;
            ctx.font = '10px JetBrains Mono, monospace';
            ctx.fillStyle = '#6b7280';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 5; i++) {
                const y = h * 0.1 + chartHeight * (i / 5);
                const priceLabel = (maxPrice - (priceRange * (i / 5))).toFixed(2);
                
                ctx.beginPath();
                ctx.moveTo(leftMargin, y);
                ctx.lineTo(w - rightMargin, y);
                ctx.stroke();
                
                ctx.fillText('$' + priceLabel, leftMargin - 8, y + 3);
            }
            
            // Draw X-axis labels
            ctx.textAlign = 'center';
            ctx.fillStyle = '#6b7280';
            const labels = config.labels;
            labels.forEach((label, i) => {
                const x = leftMargin + (i / (labels.length - 1)) * chartWidth;
                ctx.fillText(label, x, h - 8);
            });
            
            // Draw average line (dashed)
            const avgY = h * 0.1 + (1 - (avgPrice - minPrice) / priceRange) * chartHeight;
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(leftMargin, avgY);
            ctx.lineTo(w - rightMargin, avgY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            const lastX = leftMargin + chartWidth;
            const lastY = h * 0.1 + (1 - (currentPrice - minPrice) / priceRange) * chartHeight;
            
            if (chartType === 'candle') {
                // Draw candlesticks
                const candleWidth = Math.max(4, Math.min(20, (chartWidth / chartData.length) * 0.7));
                const candleGap = (chartWidth / chartData.length);
                
                chartData.forEach((d, i) => {
                    const x = leftMargin + (i / (chartData.length - 1)) * chartWidth;
                    const openY = h * 0.1 + (1 - (d.open - minPrice) / priceRange) * chartHeight;
                    const closeY = h * 0.1 + (1 - (d.close - minPrice) / priceRange) * chartHeight;
                    const highY = h * 0.1 + (1 - (d.high - minPrice) / priceRange) * chartHeight;
                    const lowY = h * 0.1 + (1 - (d.low - minPrice) / priceRange) * chartHeight;
                    
                    const isUp = d.close >= d.open;
                    const color = isUp ? '#10b981' : '#ef4444';
                    
                    // Draw wick (high-low line)
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x, highY);
                    ctx.lineTo(x, lowY);
                    ctx.stroke();
                    
                    // Draw candle body
                    const bodyTop = Math.min(openY, closeY);
                    const bodyHeight = Math.max(1, Math.abs(closeY - openY));
                    
                    if (isUp) {
                        ctx.fillStyle = color;
                        ctx.fillRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);
                    } else {
                        ctx.fillStyle = color;
                        ctx.fillRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);
                    }
                    
                    // Body border for definition
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);
                });
            } else {
                // Draw line chart
                ctx.beginPath();
                ctx.strokeStyle = '#1a73e8';
                ctx.lineWidth = 2;
                
                prices.forEach((p, i) => {
                    const x = leftMargin + (i / (prices.length - 1)) * chartWidth;
                    const y = h * 0.1 + (1 - (p - minPrice) / priceRange) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                
                // Draw area fill
                ctx.lineTo(lastX, h * 0.1 + chartHeight);
                ctx.lineTo(leftMargin, h * 0.1 + chartHeight);
                ctx.closePath();
                ctx.fillStyle = 'rgba(26, 115, 232, 0.15)';
                ctx.fill();
            }
            
            // =============================================
            // DRAW TECHNICAL INDICATORS
            // =============================================
            
            function drawIndicatorLine(values, color, lineWidth = 2) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                let started = false;
                
                values.forEach((val, i) => {
                    if (val === null) return;
                    const x = leftMargin + (i / (values.length - 1)) * chartWidth;
                    const y = h * 0.1 + (1 - (val - minPrice) / priceRange) * chartHeight;
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
            }
            
            // SMA 10
            if (activeStudies.sma10) {
                const sma10 = calculateSMA(chartData, 10);
                drawIndicatorLine(sma10, studyColors.sma10, 1.5);
            }
            
            // SMA 20
            if (activeStudies.sma20) {
                const sma20 = calculateSMA(chartData, 20);
                drawIndicatorLine(sma20, studyColors.sma20, 1.5);
            }
            
            // SMA 50
            if (activeStudies.sma50) {
                const sma50 = calculateSMA(chartData, 50);
                drawIndicatorLine(sma50, studyColors.sma50, 1.5);
            }
            
            // EMA 10
            if (activeStudies.ema10) {
                const ema10 = calculateEMA(chartData, 10);
                drawIndicatorLine(ema10, studyColors.ema10, 1.5);
            }
            
            // EMA 20
            if (activeStudies.ema20) {
                const ema20 = calculateEMA(chartData, 20);
                drawIndicatorLine(ema20, studyColors.ema20, 1.5);
            }
            
            // Bollinger Bands
            if (activeStudies.bollinger) {
                const bb = calculateBollingerBands(chartData, 20, 2);
                
                // Draw upper band
                drawIndicatorLine(bb.upper, studyColors.bollinger, 1);
                
                // Draw lower band
                drawIndicatorLine(bb.lower, studyColors.bollinger, 1);
                
                // Draw middle band (SMA)
                ctx.setLineDash([4, 4]);
                drawIndicatorLine(bb.middle, studyColors.bollinger, 1);
                ctx.setLineDash([]);
                
                // Fill between bands
                ctx.beginPath();
                let started = false;
                bb.upper.forEach((val, i) => {
                    if (val === null) return;
                    const x = leftMargin + (i / (bb.upper.length - 1)) * chartWidth;
                    const y = h * 0.1 + (1 - (val - minPrice) / priceRange) * chartHeight;
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                for (let i = bb.lower.length - 1; i >= 0; i--) {
                    if (bb.lower[i] === null) continue;
                    const x = leftMargin + (i / (bb.lower.length - 1)) * chartWidth;
                    const y = h * 0.1 + (1 - (bb.lower[i] - minPrice) / priceRange) * chartHeight;
                    ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(96, 165, 250, 0.1)';
                ctx.fill();
            }
            
            // High/Low markers (line chart only)
            if (chartType === 'line') {
                const highIndex = prices.indexOf(highPrice);
                const highX = leftMargin + (highIndex / (prices.length - 1)) * chartWidth;
                const highY = h * 0.1 + (1 - (highPrice - minPrice) / priceRange) * chartHeight;
                ctx.fillStyle = '#10b981';
                ctx.beginPath();
                ctx.arc(highX, highY, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = '9px JetBrains Mono, monospace';
                ctx.fillStyle = '#10b981';
                ctx.textAlign = 'center';
                ctx.fillText('H $' + highPrice.toFixed(2), highX, highY - 10);
                
                const lowIndex = prices.indexOf(lowPrice);
                const lowX = leftMargin + (lowIndex / (prices.length - 1)) * chartWidth;
                const lowY = h * 0.1 + (1 - (lowPrice - minPrice) / priceRange) * chartHeight;
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(lowX, lowY, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#ef4444';
                ctx.fillText('L $' + lowPrice.toFixed(2), lowX, lowY + 16);
                
                // Current price marker
                ctx.fillStyle = '#1a73e8';
                ctx.beginPath();
                ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }
            
            // Average label
            ctx.font = '9px JetBrains Mono, monospace';
            ctx.fillStyle = '#f59e0b';
            ctx.textAlign = 'left';
            ctx.fillText('AVG $' + avgPrice.toFixed(2), leftMargin + 5, avgY - 5);
            
            // =============================================
            // DRAW ORDER POSITION LINES (Trading212 style)
            // =============================================
            drawOrderAnnotations(ctx, w, h, chartWidth, chartHeight, minPrice, maxPrice, priceRange, currentPrice);
            
            // Draw RSI if active
            if (activeStudies.rsi) {
                drawRSIChart();
            }
        }
        
        // Draw order position annotations on chart
        function drawOrderAnnotations(ctx, w, h, chartWidth, chartHeight, minPrice, maxPrice, priceRange, currentPrice) {
            if (!positions || positions.length === 0) return;
            
            // Get the currently selected tea from trade form
            const select = document.getElementById('trade-tea-select');
            const selectedTeaId = select?.value ? parseInt(select.value) : null;
            
            positions.forEach(position => {
                // Only show positions for the currently selected tea (or all if none selected)
                if (selectedTeaId && position.tea_id !== selectedTeaId) return;
                
                const entryPrice = position.avg_entry_price;
                if (!entryPrice || entryPrice < minPrice || entryPrice > maxPrice) return;
                
                // Get current price for this tea
                const tea = teas.find(t => t.id === position.tea_id);
                if (!tea) return;
                
                const teaCurrentPrice = tea.current_price;
                
                // Calculate P/L
                const pnl = (teaCurrentPrice - entryPrice) * position.quantity;
                const pnlPercent = ((teaCurrentPrice - entryPrice) / entryPrice * 100);
                const isProfit = pnl >= 0;
                
                // Calculate Y position
                const entryY = h * 0.1 + (1 - (entryPrice - minPrice) / priceRange) * chartHeight;
                
                // Draw dotted line
                ctx.strokeStyle = isProfit ? '#10b981' : '#ef4444';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(leftMargin, entryY);
                ctx.lineTo(w - rightMargin, entryY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw entry marker (small triangle on left)
                ctx.fillStyle = isProfit ? '#10b981' : '#ef4444';
                ctx.beginPath();
                ctx.moveTo(leftMargin - 6, entryY);
                ctx.lineTo(leftMargin, entryY - 4);
                ctx.lineTo(leftMargin, entryY + 4);
                ctx.closePath();
                ctx.fill();
                
                // Draw P/L label on right side
                const pnlText = `${isProfit ? '+' : ''}$${pnl.toFixed(2)} (${isProfit ? '+' : ''}${pnlPercent.toFixed(1)}%)`;
                ctx.font = 'bold 10px JetBrains Mono, monospace';
                ctx.fillStyle = isProfit ? '#10b981' : '#ef4444';
                ctx.textAlign = 'right';
                
                // Background for P/L label
                const textWidth = ctx.measureText(pnlText).width;
                ctx.fillStyle = 'rgba(13, 17, 23, 0.85)';
                ctx.fillRect(w - rightMargin - textWidth - 12, entryY - 16, textWidth + 8, 14);
                
                // P/L text
                ctx.fillStyle = isProfit ? '#10b981' : '#ef4444';
                ctx.fillText(pnlText, w - rightMargin - 8, entryY - 6);
                
                // Entry price label on left
                ctx.font = '9px JetBrains Mono, monospace';
                ctx.textAlign = 'left';
                ctx.fillStyle = isProfit ? '#10b981' : '#ef4444';
                ctx.fillText('ENTRY $' + entryPrice.toFixed(2), leftMargin + 5, entryY - 6);
            });
        }
        
        // =============================================
        // RSI SUB-CHART
        // =============================================
        
        function drawRSIChart() {
            const rsiCanvas = document.getElementById('rsiChart');
            if (!rsiCanvas) return;
            
            const rsiCtx = rsiCanvas.getContext('2d');
            
            // Set canvas size
            rsiCanvas.width = rsiCanvas.offsetWidth * window.devicePixelRatio;
            rsiCanvas.height = rsiCanvas.offsetHeight * window.devicePixelRatio;
            rsiCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            const w = rsiCanvas.offsetWidth;
            const h = rsiCanvas.offsetHeight;
            const chartWidth = w - leftMargin - rightMargin;
            const topPadding = 20;
            const bottomPadding = 5;
            const chartHeight = h - topPadding - bottomPadding;
            
            // Clear
            rsiCtx.clearRect(0, 0, w, h);
            
            // Calculate RSI
            const rsiData = calculateRSI(chartData, 14);
            
            // Update RSI value display
            const currentRSI = rsiData[rsiData.length - 1];
            const rsiValueEl = document.getElementById('rsi-value');
            if (currentRSI !== null) {
                let rsiColor = '#fff';
                if (currentRSI >= 70) rsiColor = '#ef4444';
                else if (currentRSI <= 30) rsiColor = '#10b981';
                rsiValueEl.textContent = currentRSI.toFixed(1);
                rsiValueEl.style.color = rsiColor;
            }
            
            // Draw background bands
            // Overbought zone (70-100)
            rsiCtx.fillStyle = 'rgba(239, 68, 68, 0.1)';
            rsiCtx.fillRect(leftMargin, topPadding, chartWidth, chartHeight * 0.3);
            
            // Oversold zone (0-30)
            rsiCtx.fillStyle = 'rgba(16, 185, 129, 0.1)';
            rsiCtx.fillRect(leftMargin, topPadding + chartHeight * 0.7, chartWidth, chartHeight * 0.3);
            
            // Draw horizontal reference lines
            rsiCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            rsiCtx.lineWidth = 1;
            
            // 70 line (overbought)
            const y70 = topPadding + chartHeight * 0.3;
            rsiCtx.beginPath();
            rsiCtx.setLineDash([4, 4]);
            rsiCtx.moveTo(leftMargin, y70);
            rsiCtx.lineTo(w - rightMargin, y70);
            rsiCtx.stroke();
            
            // 50 line (middle)
            const y50 = topPadding + chartHeight * 0.5;
            rsiCtx.beginPath();
            rsiCtx.moveTo(leftMargin, y50);
            rsiCtx.lineTo(w - rightMargin, y50);
            rsiCtx.stroke();
            
            // 30 line (oversold)
            const y30 = topPadding + chartHeight * 0.7;
            rsiCtx.beginPath();
            rsiCtx.moveTo(leftMargin, y30);
            rsiCtx.lineTo(w - rightMargin, y30);
            rsiCtx.stroke();
            
            rsiCtx.setLineDash([]);
            
            // Draw Y-axis labels
            rsiCtx.font = '9px JetBrains Mono, monospace';
            rsiCtx.fillStyle = '#6b7280';
            rsiCtx.textAlign = 'right';
            rsiCtx.fillText('70', leftMargin - 5, y70 + 3);
            rsiCtx.fillText('50', leftMargin - 5, y50 + 3);
            rsiCtx.fillText('30', leftMargin - 5, y30 + 3);
            
            // Draw RSI line
            rsiCtx.beginPath();
            rsiCtx.strokeStyle = studyColors.rsi;
            rsiCtx.lineWidth = 1.5;
            
            let started = false;
            rsiData.forEach((val, i) => {
                if (val === null) return;
                
                const x = leftMargin + (i / (rsiData.length - 1)) * chartWidth;
                const y = topPadding + (1 - val / 100) * chartHeight;
                
                if (!started) {
                    rsiCtx.moveTo(x, y);
                    started = true;
                } else {
                    rsiCtx.lineTo(x, y);
                }
            });
            rsiCtx.stroke();
            
            // Draw fill under line
            if (started) {
                rsiCtx.lineTo(w - rightMargin, topPadding + chartHeight);
                rsiCtx.lineTo(leftMargin, topPadding + chartHeight);
                rsiCtx.closePath();
                rsiCtx.fillStyle = 'rgba(236, 72, 153, 0.1)';
                rsiCtx.fill();
            }
        }
        
        // RSI Chart hover functionality
        let rsiData = []; // Store RSI data for hover
        
        function setupRSIHover() {
            const rsiCanvas = document.getElementById('rsiChart');
            const rsiContainer = document.getElementById('rsi-chart-container');
            const rsiTooltip = document.getElementById('rsi-tooltip');
            const rsiCrosshair = document.getElementById('rsi-crosshair');
            
            if (!rsiCanvas || !rsiContainer) return;
            
            rsiCanvas.addEventListener('mousemove', function(e) {
                if (!activeStudies.rsi) return;
                
                const rect = rsiCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const w = rsiCanvas.offsetWidth;
                const h = rsiCanvas.offsetHeight;
                const chartWidth = w - leftMargin - rightMargin;
                const topPadding = 20;
                const bottomPadding = 5;
                const chartHeight = h - topPadding - bottomPadding;
                
                // Check if mouse is in chart area
                if (x < leftMargin || x > w - rightMargin || y < topPadding || y > topPadding + chartHeight) {
                    rsiTooltip.classList.remove('visible');
                    rsiCrosshair.style.display = 'none';
                    return;
                }
                
                // Calculate RSI data if needed
                const currentRsiData = calculateRSI(chartData, 14);
                
                // Find data point
                const relX = x - leftMargin;
                const index = Math.round((relX / chartWidth) * (chartData.length - 1));
                const dataPoint = chartData[Math.max(0, Math.min(index, chartData.length - 1))];
                const rsiValue = currentRsiData[Math.max(0, Math.min(index, currentRsiData.length - 1))];
                
                if (!dataPoint || rsiValue === null) {
                    rsiTooltip.classList.remove('visible');
                    rsiCrosshair.style.display = 'none';
                    return;
                }
                
                // Show crosshair
                rsiCrosshair.style.display = 'block';
                rsiCrosshair.querySelector('.crosshair-v').style.left = x + 'px';
                rsiCrosshair.querySelector('.crosshair-h').style.top = y + 'px';
                
                // Determine RSI condition
                let rsiCondition = '';
                let rsiColor = '#fff';
                if (rsiValue >= 70) {
                    rsiCondition = 'Overbought';
                    rsiColor = '#ef4444';
                } else if (rsiValue <= 30) {
                    rsiCondition = 'Oversold';
                    rsiColor = '#10b981';
                } else {
                    rsiCondition = 'Neutral';
                    rsiColor = '#9ca3af';
                }
                
                // Build tooltip
                rsiTooltip.innerHTML = `
                    <div style="color: ${rsiColor}; font-weight: 600;">RSI: ${rsiValue.toFixed(1)}</div>
                    <div style="color: ${rsiColor}; font-size: 9px;">${rsiCondition}</div>
                `;
                
                // Position tooltip
                let tooltipX = x + 15;
                let tooltipY = y - 30;
                
                if (tooltipX + 100 > w) tooltipX = x - 100;
                if (tooltipY < 0) tooltipY = y + 20;
                
                rsiTooltip.style.left = tooltipX + 'px';
                rsiTooltip.style.top = tooltipY + 'px';
                rsiTooltip.classList.add('visible');
            });
            
            rsiCanvas.addEventListener('mouseleave', function() {
                rsiTooltip.classList.remove('visible');
                rsiCrosshair.style.display = 'none';
            });
        }
        
        // Initialize RSI hover after DOM is ready
        document.addEventListener('DOMContentLoaded', setupRSIHover);
        
        // Hover functionality
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            const chartWidth = w - leftMargin - rightMargin;
            const chartHeight = h - bottomMargin - (h * 0.1);
            
            // Check if mouse is in chart area
            if (x < leftMargin || x > w - rightMargin || y < h * 0.1 || y > h * 0.1 + chartHeight) {
                tooltip.classList.remove('visible');
                crosshair.style.display = 'none';
                return;
            }
            
            // Find data point
            const relX = x - leftMargin;
            const index = Math.round((relX / chartWidth) * (chartData.length - 1));
            const dataPoint = chartData[Math.max(0, Math.min(index, chartData.length - 1))];
            
            if (!dataPoint) return;
            
            // Show crosshair
            crosshair.style.display = 'block';
            crosshair.querySelector('.crosshair-v').style.left = x + 'px';
            crosshair.querySelector('.crosshair-h').style.top = y + 'px';
            
            // Build tooltip content (Bloomberg style)
            const changeClass = dataPoint.change >= 0 ? 'up' : 'down';
            const changeSign = dataPoint.change >= 0 ? '+' : '';
            
            tooltip.innerHTML = `
                <div class="tooltip-date">${formatDate(dataPoint.date, currentTimeframe)}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Open</span>
                    <span class="tooltip-value">$${dataPoint.open.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">High</span>
                    <span class="tooltip-value up">$${dataPoint.high.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Low</span>
                    <span class="tooltip-value down">$${dataPoint.low.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Close</span>
                    <span class="tooltip-value">$${dataPoint.close.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Change</span>
                    <span class="tooltip-value ${changeClass}">${changeSign}${dataPoint.change.toFixed(2)}%</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Volume</span>
                    <span class="tooltip-value">${formatVolume(dataPoint.volume)} kg</span>
                </div>
            `;
            
            // Position tooltip
            let tooltipX = x + 15;
            let tooltipY = y - 10;
            
            // Keep tooltip in bounds
            if (tooltipX + 180 > w) tooltipX = x - 175;
            if (tooltipY + 160 > h) tooltipY = y - 150;
            if (tooltipY < 0) tooltipY = 10;
            
            tooltip.style.left = tooltipX + 'px';
            tooltip.style.top = tooltipY + 'px';
            tooltip.classList.add('visible');
        });
        
        canvas.addEventListener('mouseleave', function() {
            tooltip.classList.remove('visible');
            crosshair.style.display = 'none';
        });
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Early Access form submission - sends to Kit
        function submitEarlyAccess(e) {
            e.preventDefault();
            const email = document.getElementById('early-access-email').value;
            const form = document.getElementById('early-access-form');
            const btn = document.getElementById('early-access-btn');
            
            // Secret passphrase to view site
            if (email.toLowerCase().trim() === 'betty the best auctioneer') {
                document.getElementById('early-access-modal').style.display = 'none';
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            const formData = new FormData();
            formData.append('email_address', email);
            
            fetch('https://app.kit.com/forms/9066752/subscriptions', {
                method: 'POST',
                body: formData,
                mode: 'no-cors'
            })
            .then(() => {
                form.innerHTML = `
                    <div class="early-access-success">
                        <div class="early-access-success-icon">&#10003;</div>
                        <p>You're on the list! We'll notify you at <strong>${email}</strong> when TeaTrade Exchange launches.</p>
                    </div>
                `;
            })
            .catch(() => {
                btn.disabled = false;
                btn.textContent = 'Get Early Access';
                alert('Something went wrong. Please try again.');
            });
        }

        // Dynamic Market Status based on Mombasa/Kenya time (EAT = UTC+3)
        function updateMarketStatus() {
            const now = new Date();
            // Get Kenya time (UTC+3)
            const kenyaOffset = 3 * 60; // minutes
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const kenyaTime = new Date(utc + (kenyaOffset * 60000));
            
            const hour = kenyaTime.getHours();
            const day = kenyaTime.getDay(); // 0 = Sunday, 6 = Saturday
            
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            // Mombasa Tea Auction: Tuesday sales, but market hours roughly 9am-5pm EAT weekdays
            const isWeekday = day >= 1 && day <= 5;
            const isMarketHours = hour >= 9 && hour < 17;
            
            if (isWeekday && isMarketHours) {
                statusDot.classList.remove('closed');
                statusText.textContent = 'Mombasa OPEN';
            } else {
                statusDot.classList.add('closed');
                const nextOpen = isWeekday ? '09:00 EAT' : 'Monday 09:00 EAT';
                statusText.textContent = 'CLOSED';
            }
        }
        
        updateMarketStatus();
        setInterval(updateMarketStatus, 60000); // Update every minute

        // =============================================
        // TEATRADE EXCHANGE - PAPER TRADING SYSTEM
        // =============================================

        let tradeType = 'BUY';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthState();
            await loadTeas();
            await loadTeaPairs();
            await loadLeaderboard();
            await loadUserTrades();
            initPriceVolatility(); // Start random price updates
        });

        // =============================================
        // AUTH FUNCTIONS
        // =============================================

        async function checkAuthState() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    currentUser = user;
                    await loadUserProfile();
                    updateUIForLoggedInUser();
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        function openAuthModal() {
            document.getElementById('auth-modal').classList.add('visible');
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('visible');
            // Clear errors
            document.getElementById('signup-error').classList.remove('visible');
            document.getElementById('login-error').classList.remove('visible');
        }

        function switchAuthTab(tab) {
            document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('signup-form-container').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('login-form-container').style.display = tab === 'login' ? 'block' : 'none';
        }

        async function handleSignup(e) {
            e.preventDefault();
            const btn = document.getElementById('signup-btn');
            const errorDiv = document.getElementById('signup-error');
            
            const username = document.getElementById('signup-username').value.trim().toLowerCase();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;

            // Validate username
            if (!/^[a-z0-9_]+$/.test(username)) {
                errorDiv.textContent = 'Username can only contain letters, numbers, and underscores';
                errorDiv.classList.add('visible');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating Account...';
            errorDiv.classList.remove('visible');

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            username: username,
                            display_name: username
                        }
                    }
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserProfile();
                updateUIForLoggedInUser();
                closeAuthModal();
                showToast('Welcome to TeaTrade!', `You have $10,000 virtual cash to start trading.`);

            } catch (error) {
                console.error('Signup error:', error);
                errorDiv.textContent = error.message || 'Signup failed. Please try again.';
                errorDiv.classList.add('visible');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account & Start Trading';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('login-error');
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            btn.disabled = true;
            btn.textContent = 'Logging in...';
            errorDiv.classList.remove('visible');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserProfile();
                updateUIForLoggedInUser();
                closeAuthModal();
                showToast('Welcome back!', `Good to see you, ${userProfile?.username || 'trader'}!`);

            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'Login failed. Please check your credentials.';
                errorDiv.classList.add('visible');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Log In';
            }
        }

        async function handleLogout() {
            if (!confirm('Are you sure you want to log out?')) return;
            
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                userProfile = null;
                positions = [];
                updateUIForLoggedOutUser();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                userProfile = data;
                await loadPositions();
            } catch (error) {
                console.error('Profile load error:', error);
            }
        }

        function updateUIForLoggedInUser() {
            document.getElementById('logged-out-ui').style.display = 'none';
            document.getElementById('logged-in-ui').style.display = 'flex';
            document.getElementById('portfolio-section').style.display = 'block';

            // Update balance display
            const balance = userProfile?.cash_balance || 10000;
            document.getElementById('user-balance').textContent = '$' + balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('trade-balance').textContent = '$' + balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Update avatar
            const initials = (userProfile?.username || 'TT').substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;

            // Update trade button
            updateTradeButton();
            
            // Update portfolio
            updatePortfolioDisplay();
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('logged-out-ui').style.display = 'block';
            document.getElementById('logged-in-ui').style.display = 'none';
            document.getElementById('portfolio-section').style.display = 'none';
            
            document.getElementById('trade-balance').textContent = '$10,000.00';
            const tradeBtn = document.getElementById('trade-execute-btn');
            tradeBtn.textContent = 'Sign in to Trade';
            tradeBtn.disabled = false;
            tradeBtn.classList.add('signin-prompt');
        }

        // =============================================
        // TRADING FUNCTIONS
        // =============================================

        // Tea display data mapping (symbol -> auction display info with fixed buyer/status)
        // soldPrice: final price when sold, soldTime: timestamp for ordering
        const teaDisplayData = {
            // BIDDING lots - live price updates (10 from DB + additional display-only)
            'CHN-YUN': { grade: 'YUN', estate: 'Yunnan Gold', origin: 'China', lot: 24601, qty: 12400, buyer: 'â€”', status: 'BIDDING' },
            'IND-ASM': { grade: 'ASM', estate: 'Assam Orthodox', origin: 'India', lot: 24602, qty: 8200, buyer: 'â€”', status: 'BIDDING' },
            'IND-DRJ': { grade: 'DRJ', estate: 'Darjeeling First Flush', origin: 'India', lot: 24603, qty: 15600, buyer: 'â€”', status: 'BIDDING' },
            'KEN-BP1': { grade: 'BP1', estate: 'Kenya BP1', origin: 'Kenya', lot: 24604, qty: 22000, buyer: 'â€”', status: 'BIDDING' },
            'KEN-DUST': { grade: 'DUST', estate: 'Kenya Dust', origin: 'Kenya', lot: 24605, qty: 5400, buyer: 'â€”', status: 'BIDDING' },
            'KEN-PF1': { grade: 'PF1', estate: 'Kenya PF1', origin: 'Kenya', lot: 24606, qty: 18900, buyer: 'â€”', status: 'BIDDING' },
            'MLW-BP1': { grade: 'BP1', estate: 'Malawi BP1', origin: 'Malawi', lot: 24607, qty: 9800, buyer: 'â€”', status: 'BIDDING' },
            'RWA-OP': { grade: 'OP', estate: 'Rwanda OP', origin: 'Rwanda', lot: 24608, qty: 6200, buyer: 'â€”', status: 'BIDDING' },
            'SRI-BOP': { grade: 'BOP', estate: 'Ceylon BOP', origin: 'Sri Lanka', lot: 24609, qty: 14500, buyer: 'â€”', status: 'BIDDING' },
            'SRI-PEK': { grade: 'PEK', estate: 'Ceylon Pekoe', origin: 'Sri Lanka', lot: 24610, qty: 8700, buyer: 'â€”', status: 'BIDDING' },
            // Additional lots using same DB prices with different lot numbers
            'CHN-YUN-2': { grade: 'YUN', estate: 'Yunnan Special Reserve', origin: 'China', lot: 24611, qty: 6300, buyer: 'â€”', status: 'BIDDING', priceFrom: 'CHN-YUN' },
            'IND-DRJ-2': { grade: 'DRJ', estate: 'Darjeeling Second Flush', origin: 'India', lot: 24612, qty: 11200, buyer: 'â€”', status: 'BIDDING', priceFrom: 'IND-DRJ' },
            'KEN-BP1-2': { grade: 'BP1', estate: 'Kenya Premium BP1', origin: 'Kenya', lot: 24613, qty: 19500, buyer: 'â€”', status: 'BIDDING', priceFrom: 'KEN-BP1' },
            'IND-ASM-2': { grade: 'ASM', estate: 'Assam Golden Tips', origin: 'India', lot: 24614, qty: 4800, buyer: 'â€”', status: 'BIDDING', priceFrom: 'IND-ASM' },
            'SRI-PEK-2': { grade: 'PEK', estate: 'Ceylon Highland Pekoe', origin: 'Sri Lanka', lot: 24615, qty: 9200, buyer: 'â€”', status: 'BIDDING', priceFrom: 'SRI-PEK' },
            'KEN-PF1-2': { grade: 'PF1', estate: 'Kenya Estate PF1', origin: 'Kenya', lot: 24616, qty: 16400, buyer: 'â€”', status: 'BIDDING', priceFrom: 'KEN-PF1' },
            'MLW-BP1-2': { grade: 'BP1', estate: 'Malawi Estate BP1', origin: 'Malawi', lot: 24617, qty: 7600, buyer: 'â€”', status: 'BIDDING', priceFrom: 'MLW-BP1' },
            // SOLD lots at the bottom
            'SRI-BOP-SOLD': { grade: 'BOP', estate: 'Ceylon Vintage BOP', origin: 'Sri Lanka', lot: 24500, qty: 7800, buyer: 'Tata Global', status: 'SOLD', soldPrice: 4.65, soldTime: 3, priceFrom: 'SRI-BOP' },
            'KEN-BP1-SOLD': { grade: 'BP1', estate: 'Kenya Select BP1', origin: 'Kenya', lot: 24501, qty: 11200, buyer: 'Unilever Tea', status: 'SOLD', soldPrice: 2.94, soldTime: 2, priceFrom: 'KEN-BP1' },
            'IND-DRJ-SOLD': { grade: 'DRJ', estate: 'Darjeeling Reserve', origin: 'India', lot: 24502, qty: 5400, buyer: 'Harrods Ltd', status: 'SOLD', soldPrice: 8.72, soldTime: 1, priceFrom: 'IND-DRJ' }
        };

        async function loadTeas() {
            try {
                const { data, error } = await supabaseClient
                    .from('teas')
                    .select('*')
                    .order('symbol');

                if (error) throw error;
                teas = data;
                populateTeaSelect();
                updateAuctionTable(); // Update live auction results
                updatePairsTable(); // Update pairs with new ratios
                updatePortfolioDisplay(); // Refresh portfolio with new prices
                updateQuoteBoard(); // Update flash quote board
            } catch (error) {
                console.error('Failed to load teas:', error);
            }
        }

        // Track previous auction prices for flash detection (only for BIDDING lots)
        let previousAuctionPrices = {};

        function updateAuctionTable() {
            const tbody = document.getElementById('auction-table-body');
            if (!tbody || !teas.length) return;

            // Build tea lookup map
            const teaMap = {};
            teas.forEach(tea => teaMap[tea.symbol] = tea);

            // Build auction items from display data
            const auctionItems = Object.entries(teaDisplayData).map(([symbol, displayData]) => {
                // Get price source - either this symbol or priceFrom reference
                const priceSymbol = displayData.priceFrom || symbol;
                const tea = teaMap[priceSymbol] || { 
                    symbol: priceSymbol, 
                    current_price: displayData.soldPrice || 0, 
                    previous_price: displayData.soldPrice || 0 
                };
                return { symbol, tea, displayData };
            });

            // Sort: BIDDING first, then PENDING, then SOLD (by soldTime desc)
            const statusOrder = { 'BIDDING': 0, 'PENDING': 1, 'SOLD': 2 };
            auctionItems.sort((a, b) => {
                const statusDiff = statusOrder[a.displayData.status] - statusOrder[b.displayData.status];
                if (statusDiff !== 0) return statusDiff;
                // Within SOLD, sort by soldTime descending (most recent first)
                if (a.displayData.status === 'SOLD') {
                    return (b.displayData.soldTime || 0) - (a.displayData.soldTime || 0);
                }
                return 0;
            });

            // Detect price changes only for BIDDING lots
            const changedTeas = {};
            auctionItems.forEach(({ symbol, tea, displayData }) => {
                if (displayData.status === 'BIDDING') {
                    const trackKey = symbol; // Track by display symbol, not DB symbol
                    if (previousAuctionPrices[trackKey] !== undefined && 
                        previousAuctionPrices[trackKey] !== tea.current_price) {
                        changedTeas[symbol] = tea.current_price > previousAuctionPrices[trackKey] ? 'up' : 'down';
                    }
                    previousAuctionPrices[trackKey] = tea.current_price;
                }
            });

            tbody.innerHTML = auctionItems.map(({ symbol, tea, displayData }) => {
                const status = displayData.status;
                const buyer = displayData.buyer;

                // Determine price to display
                let displayPrice;
                let changeStr;
                let changeClass = '';
                let flashClass = '';

                if (status === 'SOLD') {
                    // Fixed sold price, no change
                    displayPrice = displayData.soldPrice || tea.current_price;
                    changeStr = 'â€”';
                } else if (status === 'PENDING') {
                    // Fixed price, no change (not being bid on yet)
                    displayPrice = tea.current_price;
                    changeStr = 'â€”';
                } else {
                    // BIDDING - live price with changes
                    displayPrice = tea.current_price;
                    const change = tea.previous_price 
                        ? ((tea.current_price - tea.previous_price) / tea.previous_price * 100)
                        : 0;
                    changeStr = change !== 0 ? `${change >= 0 ? '+' : ''}${change.toFixed(1)}%` : 'â€”';
                    changeClass = change > 0 ? 'up' : change < 0 ? 'down' : '';
                    flashClass = changedTeas[symbol] ? `flash-${changedTeas[symbol]}` : '';
                }

                let statusColor;
                if (status === 'SOLD') {
                    statusColor = 'var(--accent-green)';
                } else if (status === 'BIDDING') {
                    statusColor = 'var(--accent-orange)';
                } else {
                    statusColor = 'var(--text-muted)';
                }

                return `
                    <tr>
                        <td style="font-family: 'JetBrains Mono', monospace;">#${displayData.lot}</td>
                        <td><span class="grade-badge">${displayData.grade}</span></td>
                        <td>${displayData.estate}</td>
                        <td class="auction-center">${displayData.origin}</td>
                        <td>${displayData.qty.toLocaleString()}</td>
                        <td class="price-cell ${changeClass} ${flashClass}" data-tea="${symbol}">
                            <span>$${displayPrice.toFixed(2)}</span>
                            <button class="price-alert-btn ${priceAlerts[symbol] ? 'has-alert' : ''}" onclick="event.stopPropagation(); openPriceAlertModal('${symbol}', ${displayPrice})" title="Set price alert">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                            </button>
                        </td>
                        <td class="${changeClass}">${changeStr}</td>
                        <td>${buyer}</td>
                        <td><span style="color: ${statusColor};">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Random price volatility system
        async function triggerPriceUpdate() {
            try {
                const { error } = await supabaseClient.rpc('update_tea_prices');
                if (error) throw error;
                console.log('Prices updated');
                await loadTeas(); // Reload prices after update
                await loadUserTrades(); // Refresh P/L on orders
                
                // Check SL/TP triggers
                if (currentUser) {
                    await checkSlTpOrders();
                }
                
                // Check price alerts
                await checkPriceAlerts();
            } catch (error) {
                console.error('Failed to update prices:', error);
            }
        }
        
        // Check and execute Stop Loss / Take Profit orders
        async function checkSlTpOrders() {
            for (const teaId of Object.keys(pendingSlTpOrders)) {
                const order = pendingSlTpOrders[teaId];
                const tea = teas.find(t => t.id === parseInt(teaId));
                if (!tea) continue;
                
                const currentPrice = tea.current_price;
                let triggered = false;
                let triggerType = '';
                
                // For a BUY position:
                // - Stop Loss triggers when price falls below SL (sell to limit loss)
                // - Take Profit triggers when price rises above TP (sell to lock in profit)
                if (order.side === 'BUY') {
                    if (order.sl && currentPrice <= order.sl) {
                        triggered = true;
                        triggerType = 'Stop Loss';
                    } else if (order.tp && currentPrice >= order.tp) {
                        triggered = true;
                        triggerType = 'Take Profit';
                    }
                }
                
                if (triggered) {
                    // Execute the closing trade
                    await executeSlTpClose(parseInt(teaId), order, currentPrice, triggerType);
                }
            }
        }
        
        // Execute SL/TP close order
        async function executeSlTpClose(teaId, order, currentPrice, triggerType) {
            const tea = teas.find(t => t.id === teaId);
            if (!tea) return;
            
            const position = positions.find(p => p.tea_id === teaId);
            if (!position) {
                // Position no longer exists, remove pending order
                delete pendingSlTpOrders[teaId];
                return;
            }
            
            // Close the position at current price
            const qty = Math.min(order.qty, position.quantity);
            const total = currentPrice * qty;
            
            try {
                // Update cash balance
                const newBalance = userProfile.cash_balance + total;
                const { error: balanceError } = await supabaseClient
                    .from('profiles')
                    .update({ cash_balance: newBalance })
                    .eq('id', currentUser.id);
                if (balanceError) throw balanceError;
                
                // Update position
                const newQty = position.quantity - qty;
                if (newQty <= 0) {
                    const { error: posError } = await supabaseClient
                        .from('positions')
                        .delete()
                        .eq('id', position.id);
                    if (posError) throw posError;
                } else {
                    const { error: posError } = await supabaseClient
                        .from('positions')
                        .update({ 
                            quantity: newQty,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', position.id);
                    if (posError) throw posError;
                }
                
                // Record trade
                const { error: tradeError } = await supabaseClient
                    .from('trades')
                    .insert({
                        user_id: currentUser.id,
                        tea_id: teaId,
                        side: 'SELL',
                        quantity: qty,
                        price: currentPrice,
                        total_value: total
                    });
                if (tradeError) throw tradeError;
                
                // Calculate P/L
                const pnl = (currentPrice - order.entryPrice) * qty;
                const pnlText = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
                
                // Remove pending order
                delete pendingSlTpOrders[teaId];
                
                // Update UI
                userProfile.cash_balance = newBalance;
                await loadPositions();
                updateUIForLoggedInUser();
                
                // Show notification
                showToast(`${triggerType} Triggered!`, `${order.symbol} closed at $${currentPrice.toFixed(2)} (${pnlText})`);
                
            } catch (error) {
                console.error('SL/TP execution error:', error);
                showToast('SL/TP Error', error.message, true);
            }
        }

        // Check if prices need updating and set up periodic updates
        async function initPriceVolatility() {
            // Trigger first price update immediately for testing
            await triggerPriceUpdate();

            // Set up random intervals for price updates (2-5 seconds for testing)
            schedulePriceUpdate();
        }

        function schedulePriceUpdate() {
            // Random interval between 2 and 5 seconds (for testing)
            const interval = Math.floor(Math.random() * 3000) + 2000; // 2-5 seconds
            setTimeout(async () => {
                await triggerPriceUpdate();
                schedulePriceUpdate(); // Schedule next update
            }, interval);
        }

        // Track if user is actively interacting with trade form
        let isTradeFormActive = false;
        
        // Set up focus tracking on trade form inputs
        document.addEventListener('DOMContentLoaded', () => {
            const tradeFormInputs = ['trade-tea-select', 'trade-qty', 'trade-price', 'sl-input', 'tp-input'];
            tradeFormInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('focus', () => { isTradeFormActive = true; });
                    el.addEventListener('blur', () => { 
                        // Small delay to allow for tab navigation between fields
                        setTimeout(() => {
                            const activeEl = document.activeElement;
                            if (!tradeFormInputs.includes(activeEl?.id)) {
                                isTradeFormActive = false;
                            }
                        }, 100);
                    });
                }
            });
        });

        function populateTeaSelect() {
            const select = document.getElementById('trade-tea-select');
            
            // Preserve current selection
            const currentValue = select.value;
            const currentQty = document.getElementById('trade-qty')?.value;
            
            // Skip full rebuild if user is actively using the form
            if (isTradeFormActive && currentValue) {
                // Just update the prices in existing options without rebuilding
                teas.forEach(tea => {
                    const option = select.querySelector(`option[value="${tea.id}"]`);
                    if (option) {
                        const change = tea.previous_price ? ((tea.current_price - tea.previous_price) / tea.previous_price * 100).toFixed(1) : '0.0';
                        const changeSign = change >= 0 ? '+' : '';
                        option.textContent = `${tea.symbol} - $${tea.current_price.toFixed(2)} (${changeSign}${change}%)`;
                        option.dataset.price = tea.current_price;
                    }
                });
                // Update the trade summary with new price
                updateTradeSummary();
                return;
            }
            
            select.innerHTML = '<option value="">Select Tea...</option>';
            
            teas.forEach(tea => {
                const change = tea.previous_price ? ((tea.current_price - tea.previous_price) / tea.previous_price * 100).toFixed(1) : '0.0';
                const changeSign = change >= 0 ? '+' : '';
                const option = document.createElement('option');
                option.value = tea.id;
                option.textContent = `${tea.symbol} - $${tea.current_price.toFixed(2)} (${changeSign}${change}%)`;
                option.dataset.price = tea.current_price;
                select.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (currentValue) {
                select.value = currentValue;
                // Only restore qty if we had a selection
                if (currentQty && document.getElementById('trade-qty')) {
                    document.getElementById('trade-qty').value = currentQty;
                }
                updateTradeSummary();
            }
        }

        function setTradeType(type) {
            tradeType = type;
            document.getElementById('btn-trade-buy').classList.toggle('active', type === 'BUY');
            document.getElementById('btn-trade-sell').classList.toggle('active', type === 'SELL');
            
            const btn = document.getElementById('trade-execute-btn');
            btn.classList.remove('buy', 'sell');
            btn.classList.add(type.toLowerCase());
            
            updateTradeButton();
        }
        
        function adjustSlTp(inputId, delta) {
            const input = document.getElementById(inputId);
            const currentVal = parseFloat(input.value) || 0;
            const newVal = Math.max(0, currentVal + delta);
            input.value = newVal.toFixed(2);
        }

        function updateTradeSummary() {
            const select = document.getElementById('trade-tea-select');
            const qtyInput = document.getElementById('trade-qty');
            const priceInput = document.getElementById('trade-price');
            const valueEl = document.getElementById('trade-value');
            
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption?.dataset?.price ? parseFloat(selectedOption.dataset.price) : 0;
            const qty = parseFloat(qtyInput.value) || 0;
            
            priceInput.value = price > 0 ? price.toFixed(3) : '';
            const total = price * qty;
            valueEl.textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            updateTradeButton();
        }

        function updateTradeButton() {
            const btn = document.getElementById('trade-execute-btn');
            const select = document.getElementById('trade-tea-select');
            const qty = parseFloat(document.getElementById('trade-qty').value) || 0;
            const price = parseFloat(document.getElementById('trade-price').value) || 0;
            const total = price * qty;

            if (!currentUser) {
                btn.textContent = 'Sign in to Trade';
                btn.disabled = false; // Keep enabled so it opens auth modal
                btn.classList.add('signin-prompt');
                return;
            }
            
            btn.classList.remove('signin-prompt');

            if (!select.value) {
                btn.textContent = 'Select a Tea';
                btn.disabled = true;
                return;
            }

            if (qty <= 0) {
                btn.textContent = 'Enter Quantity';
                btn.disabled = true;
                return;
            }

            if (tradeType === 'BUY') {
                if (total > (userProfile?.cash_balance || 0)) {
                    btn.textContent = 'Insufficient Balance';
                    btn.disabled = true;
                    return;
                }
                btn.textContent = `BUY ${qty.toLocaleString()} kg for $${total.toFixed(2)}`;
            } else {
                // Check if user has enough to sell
                const teaId = parseInt(select.value);
                const position = positions.find(p => p.tea_id === teaId);
                if (!position || position.quantity < qty) {
                    btn.textContent = 'Insufficient Holdings';
                    btn.disabled = true;
                    return;
                }
                btn.textContent = `SELL ${qty.toLocaleString()} kg for $${total.toFixed(2)}`;
            }
            btn.disabled = false;
        }

        async function executeTrade() {
            if (!currentUser) {
                openAuthModal();
                return;
            }

            const btn = document.getElementById('trade-execute-btn');
            const select = document.getElementById('trade-tea-select');
            const teaId = parseInt(select.value);
            const qty = parseFloat(document.getElementById('trade-qty').value);
            const price = parseFloat(document.getElementById('trade-price').value);
            const total = price * qty;
            
            // Get SL/TP values
            const slInput = document.getElementById('trade-sl');
            const tpInput = document.getElementById('trade-tp');
            const stopLoss = slInput.value ? parseFloat(slInput.value) : null;
            const takeProfit = tpInput.value ? parseFloat(tpInput.value) : null;

            const tea = teas.find(t => t.id === teaId);
            if (!tea) return;

            btn.disabled = true;
            btn.textContent = 'Executing...';

            try {
                if (tradeType === 'BUY') {
                    // Check balance
                    if (total > userProfile.cash_balance) {
                        throw new Error('Insufficient balance');
                    }

                    // Update cash balance
                    const newBalance = userProfile.cash_balance - total;
                    const { error: balanceError } = await supabaseClient
                        .from('profiles')
                        .update({ cash_balance: newBalance })
                        .eq('id', currentUser.id);
                    if (balanceError) throw balanceError;

                    // Update or create position
                    const existingPosition = positions.find(p => p.tea_id === teaId);
                    if (existingPosition) {
                        // Calculate new average price
                        const totalQty = existingPosition.quantity + qty;
                        const newAvgPrice = ((existingPosition.avg_entry_price * existingPosition.quantity) + (price * qty)) / totalQty;
                        
                        const { error: posError } = await supabaseClient
                            .from('positions')
                            .update({ 
                                quantity: totalQty, 
                                avg_entry_price: newAvgPrice,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingPosition.id);
                        if (posError) throw posError;
                    } else {
                        const { error: posError } = await supabaseClient
                            .from('positions')
                            .insert({
                                user_id: currentUser.id,
                                tea_id: teaId,
                                quantity: qty,
                                avg_entry_price: price
                            });
                        if (posError) throw posError;
                    }

                    // Record trade
                    const { error: tradeError } = await supabaseClient
                        .from('trades')
                        .insert({
                            user_id: currentUser.id,
                            tea_id: teaId,
                            side: 'BUY',
                            quantity: qty,
                            price: price,
                            total_value: total
                        });
                    if (tradeError) throw tradeError;

                    userProfile.cash_balance = newBalance;
                    showToast('Trade Executed!', `Bought ${qty.toLocaleString()} kg of ${tea.symbol} at $${price.toFixed(2)}/kg`);
                    
                    // Register SL/TP orders if set
                    if (stopLoss || takeProfit) {
                        pendingSlTpOrders[teaId] = {
                            sl: stopLoss,
                            tp: takeProfit,
                            side: 'BUY', // Original trade side
                            qty: qty,
                            symbol: tea.symbol,
                            entryPrice: price
                        };
                        if (stopLoss && takeProfit) {
                            showToast('SL/TP Set', `SL: $${stopLoss.toFixed(2)} | TP: $${takeProfit.toFixed(2)}`);
                        } else if (stopLoss) {
                            showToast('Stop Loss Set', `Will close at $${stopLoss.toFixed(2)}`);
                        } else {
                            showToast('Take Profit Set', `Will close at $${takeProfit.toFixed(2)}`);
                        }
                    }

                } else {
                    // SELL
                    const existingPosition = positions.find(p => p.tea_id === teaId);
                    if (!existingPosition || existingPosition.quantity < qty) {
                        throw new Error('Insufficient holdings');
                    }

                    // Update cash balance
                    const newBalance = userProfile.cash_balance + total;
                    const { error: balanceError } = await supabaseClient
                        .from('profiles')
                        .update({ cash_balance: newBalance })
                        .eq('id', currentUser.id);
                    if (balanceError) throw balanceError;

                    // Update position
                    const newQty = existingPosition.quantity - qty;
                    if (newQty <= 0) {
                        const { error: posError } = await supabaseClient
                            .from('positions')
                            .delete()
                            .eq('id', existingPosition.id);
                        if (posError) throw posError;
                    } else {
                        const { error: posError } = await supabaseClient
                            .from('positions')
                            .update({ 
                                quantity: newQty,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingPosition.id);
                        if (posError) throw posError;
                    }

                    // Record trade
                    const { error: tradeError } = await supabaseClient
                        .from('trades')
                        .insert({
                            user_id: currentUser.id,
                            tea_id: teaId,
                            side: 'SELL',
                            quantity: qty,
                            price: price,
                            total_value: total
                        });
                    if (tradeError) throw tradeError;

                    userProfile.cash_balance = newBalance;
                    const pnl = (price - existingPosition.avg_entry_price) * qty;
                    const pnlText = pnl >= 0 ? `Profit: +$${pnl.toFixed(2)}` : `Loss: -$${Math.abs(pnl).toFixed(2)}`;
                    showToast('Trade Executed!', `Sold ${qty.toLocaleString()} kg of ${tea.symbol}. ${pnlText}`);
                }

                // Refresh data
                await loadPositions();
                await loadUserTrades();
                updateUIForLoggedInUser();
                
                // Reset form
                document.getElementById('trade-qty').value = '';
                document.getElementById('trade-sl').value = '';
                document.getElementById('trade-tp').value = '';
                updateTradeSummary();

            } catch (error) {
                console.error('Trade error:', error);
                showToast('Trade Failed', error.message, true);
            }

            updateTradeButton();
        }

        async function closePosition(teaId, quantity, teaSymbol) {
            if (!currentUser) {
                openAuthModal();
                return;
            }

            const tea = teas.find(t => t.id === teaId);
            if (!tea) {
                showToast('Error', 'Tea not found', true);
                return;
            }

            // Find the user's position
            const position = positions.find(p => p.tea_id === teaId);
            if (!position || position.quantity < quantity) {
                showToast('Error', 'Position not found or insufficient quantity', true);
                return;
            }

            const price = tea.current_price;
            const total = price * quantity;

            try {
                // Update cash balance
                const newBalance = userProfile.cash_balance + total;
                const { error: balanceError } = await supabaseClient
                    .from('profiles')
                    .update({ cash_balance: newBalance })
                    .eq('id', currentUser.id);
                if (balanceError) throw balanceError;

                // Update or delete position
                const newQty = position.quantity - quantity;
                if (newQty <= 0) {
                    const { error: posError } = await supabaseClient
                        .from('positions')
                        .delete()
                        .eq('id', position.id);
                    if (posError) throw posError;
                } else {
                    const { error: posError } = await supabaseClient
                        .from('positions')
                        .update({ 
                            quantity: newQty,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', position.id);
                    if (posError) throw posError;
                }

                // Record the closing trade
                const { error: tradeError } = await supabaseClient
                    .from('trades')
                    .insert({
                        user_id: currentUser.id,
                        tea_id: teaId,
                        side: 'SELL',
                        quantity: quantity,
                        price: price,
                        total_value: total
                    });
                if (tradeError) throw tradeError;

                userProfile.cash_balance = newBalance;
                const pnl = (price - position.avg_entry_price) * quantity;
                const pnlText = pnl >= 0 ? `Profit: +$${pnl.toFixed(2)}` : `Loss: -$${Math.abs(pnl).toFixed(2)}`;
                showToast('Position Closed!', `Sold ${quantity.toLocaleString()} kg of ${teaSymbol}. ${pnlText}`);

                // Record to trade history log
                recordClosedTrade({
                    ...position,
                    symbol: teaSymbol,
                    quantity: quantity,
                    type: 'long'
                }, price);

                // Refresh data
                await loadPositions();
                await loadUserTrades();
                updateUIForLoggedInUser();

            } catch (error) {
                console.error('Close position error:', error);
                showToast('Error', error.message, true);
            }
        }

        async function closePairPosition(tradeId) {
            if (!currentUser) {
                openAuthModal();
                return;
            }

            try {
                // Get the original trade
                const { data: trade, error: fetchError } = await supabaseClient
                    .from('trades')
                    .select('*')
                    .eq('id', tradeId)
                    .single();
                
                if (fetchError) throw fetchError;
                if (!trade || !trade.is_pair_trade) {
                    showToast('Error', 'Pair trade not found', true);
                    return;
                }

                // Find the pair
                const pair = teaPairs.find(p => p.id === trade.pair_id);
                if (!pair) {
                    showToast('Error', 'Pair not found', true);
                    return;
                }

                // Calculate current ratio and P/L
                const teaMap = {};
                teas.forEach(t => teaMap[t.symbol] = t);
                const baseTea = teaMap[pair.base_symbol];
                const quoteTea = teaMap[pair.quote_symbol];

                if (!baseTea || !quoteTea) {
                    showToast('Error', 'Could not get current prices', true);
                    return;
                }

                const currentRatio = baseTea.current_price / quoteTea.current_price;
                const entryRatio = trade.price;
                const ratioChange = (currentRatio - entryRatio) / entryRatio;
                const direction = trade.side === 'BUY' ? 1 : -1; // LONG = BUY, SHORT = SELL
                const leverage = trade.leverage || 1;
                const margin = trade.quantity;
                const pnl = margin * ratioChange * leverage * direction;

                // Return margin + P/L to user
                const returnAmount = margin + pnl;
                const newBalance = userProfile.cash_balance + returnAmount;

                const { error: balanceError } = await supabaseClient
                    .from('profiles')
                    .update({ cash_balance: newBalance })
                    .eq('id', currentUser.id);
                if (balanceError) throw balanceError;

                // Record the closing trade
                const { error: closeError } = await supabaseClient
                    .from('trades')
                    .insert({
                        user_id: currentUser.id,
                        tea_id: trade.tea_id,
                        side: trade.side === 'BUY' ? 'SELL' : 'BUY', // Opposite side to close
                        quantity: margin,
                        price: currentRatio,
                        total_value: returnAmount,
                        pair_id: trade.pair_id,
                        leverage: leverage,
                        is_pair_trade: true
                    });
                if (closeError) throw closeError;

                userProfile.cash_balance = newBalance;

                const baseShort = pair.base_symbol.split('-')[1] || pair.base_symbol;
                const quoteShort = pair.quote_symbol.split('-')[1] || pair.quote_symbol;
                const pnlText = pnl >= 0 ? `Profit: +$${pnl.toFixed(2)}` : `Loss: -$${Math.abs(pnl).toFixed(2)}`;
                const posType = trade.side === 'BUY' ? 'LONG' : 'SHORT';
                
                showToast('Pair Position Closed!', `Closed ${posType} ${baseShort}/${quoteShort} ${leverage}x. ${pnlText}`);

                // Record to trade history log
                recordClosedTrade({
                    symbol: `${baseShort}/${quoteShort}`,
                    type: trade.side === 'BUY' ? 'long' : 'short',
                    quantity: margin,
                    avg_price: entryRatio,
                    created_at: trade.created_at
                }, currentRatio);

                // Refresh data
                await loadUserTrades();
                updateUIForLoggedInUser();

            } catch (error) {
                console.error('Close pair position error:', error);
                showToast('Error', error.message, true);
            }
        }

        // =============================================
        // PORTFOLIO FUNCTIONS
        // =============================================

        async function loadPositions() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('positions')
                    .select('*, teas(*)')
                    .eq('user_id', currentUser.id);

                if (error) throw error;
                positions = data || [];
                updatePortfolioDisplay();
            } catch (error) {
                console.error('Failed to load positions:', error);
            }
        }

        function updatePortfolioDisplay() {
            const listEl = document.getElementById('positions-list');
            const valueEl = document.getElementById('portfolio-value');
            const pnlEl = document.getElementById('portfolio-pnl');

            if (positions.length === 0) {
                listEl.innerHTML = `
                    <div style="color: var(--text-muted); font-size: 12px; padding: 20px 0; text-align: center;">
                        No positions yet. Start trading!
                    </div>
                `;
                const totalValue = userProfile?.cash_balance || 10000;
                valueEl.textContent = '$' + totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const pnl = totalValue - 10000;
                const pnlPct = (pnl / 10000 * 100).toFixed(2);
                pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPct}%)`;
                pnlEl.className = 'portfolio-pnl ' + (pnl >= 0 ? 'up' : 'down');
                return;
            }

            let holdingsValue = 0;
            let html = '';

            positions.forEach(pos => {
                const tea = pos.teas || teas.find(t => t.id === pos.tea_id);
                if (!tea) return;

                const currentValue = pos.quantity * tea.current_price;
                const costBasis = pos.quantity * pos.avg_entry_price;
                const pnl = currentValue - costBasis;
                const pnlPct = (pnl / costBasis * 100).toFixed(1);
                holdingsValue += currentValue;

                html += `
                    <div class="position-item">
                        <div>
                            <div class="position-tea">${tea.symbol}</div>
                            <div class="position-qty">${pos.quantity.toLocaleString()} kg @ $${pos.avg_entry_price.toFixed(2)}</div>
                        </div>
                        <div class="position-value">
                            <div class="position-current">$${currentValue.toFixed(2)}</div>
                            <div class="position-pnl ${pnl >= 0 ? 'up' : 'down'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPct}%)</div>
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;

            const totalValue = (userProfile?.cash_balance || 0) + holdingsValue;
            valueEl.textContent = '$' + totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const totalPnl = totalValue - 10000;
            const totalPnlPct = (totalPnl / 10000 * 100).toFixed(2);
            pnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)} (${totalPnlPct}%)`;
            pnlEl.className = 'portfolio-pnl ' + (totalPnl >= 0 ? 'up' : 'down');
        }

        // =============================================
        // ORDER HISTORY FUNCTIONS
        // =============================================

        let ordersSortColumn = 'time';
        let ordersSortDirection = 'desc';
        let currentTradesData = [];
        let ordersFilter = 'all'; // 'all' or 'open'

        function setOrdersFilter(filter) {
            ordersFilter = filter;
            // Update button states
            document.getElementById('filter-all').classList.toggle('active', filter === 'all');
            document.getElementById('filter-open').classList.toggle('active', filter === 'open');
            // Re-display with filter
            displayUserTrades(currentTradesData);
        }

        function sortOrdersTable(column) {
            // Toggle direction if same column, otherwise default desc
            if (ordersSortColumn === column) {
                ordersSortDirection = ordersSortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                ordersSortColumn = column;
                ordersSortDirection = 'desc';
            }

            // Update header indicators
            document.querySelectorAll('#orders-table th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === column) {
                    th.classList.add(ordersSortDirection);
                }
            });

            // Re-display with new sort
            displayUserTrades(currentTradesData);
        }

        async function loadUserTrades() {
            if (!currentUser) {
                displayUserTrades([]);
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('trades')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('id', { ascending: false })
                    .limit(20);

                if (error) throw error;
                currentTradesData = data || [];
                displayUserTrades(currentTradesData);
            } catch (error) {
                console.error('Failed to load trades:', error);
            }
        }

        function displayUserTrades(trades) {
            const tbody = document.getElementById('orders-tbody');
            const countEl = document.getElementById('order-count');
            
            if (!tbody) return;

            // Separate BUY and SELL trades
            const buyTrades = trades.filter(t => t.side === 'BUY');
            const sellTrades = trades.filter(t => t.side === 'SELL');

            // Match SELL trades to BUY trades (closing trades)
            const closedBuyIds = new Set();
            const closingInfo = {}; // buyTradeId -> { sellPrice, sellTime }

            // For each SELL, find the most recent BUY of the same tea that hasn't been closed
            sellTrades.forEach(sell => {
                const matchingBuy = buyTrades.find(buy => 
                    buy.tea_id === sell.tea_id && 
                    buy.quantity === sell.quantity &&
                    !closedBuyIds.has(buy.id) &&
                    buy.id < sell.id // SELL must come after BUY
                );
                if (matchingBuy) {
                    closedBuyIds.add(matchingBuy.id);
                    closingInfo[matchingBuy.id] = {
                        sellPrice: sell.price,
                        sellTime: sell.created_at
                    };
                }
            });

            // Filter based on current filter setting
            let displayTrades = buyTrades;
            if (ordersFilter === 'open') {
                displayTrades = buyTrades.filter(t => !closedBuyIds.has(t.id));
            }
            countEl.textContent = displayTrades.length;

            if (displayTrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: var(--text-muted); padding: 20px;">
                            ${ordersFilter === 'open' ? 'No open positions.' : 'No orders yet. Start trading!'}
                        </td>
                    </tr>
                `;
                return;
            }

            // Build processed trade data for sorting
            let processedTrades = displayTrades.map(trade => {
                const time = trade.created_at 
                    ? new Date(trade.created_at)
                    : new Date(0);
                const timeStr = trade.created_at 
                    ? time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                    : '--:--';
                const orderId = '#' + String(trade.id).substring(0, 5).toUpperCase();
                const tea = teas.find(t => t.id === trade.tea_id);
                
                const isClosed = closedBuyIds.has(trade.id);
                const closing = closingInfo[trade.id];
                
                // Handle pair trades differently
                const isPairTrade = trade.is_pair_trade || false;
                const leverage = trade.leverage || 1;
                let teaSymbol, total, pnl, pnlPct;
                
                if (isPairTrade && trade.pair_id) {
                    // Find the pair
                    const pair = teaPairs.find(p => p.id === trade.pair_id);
                    if (pair) {
                        const baseShort = pair.base_symbol.split('-')[1] || pair.base_symbol;
                        const quoteShort = pair.quote_symbol.split('-')[1] || pair.quote_symbol;
                        teaSymbol = `${baseShort}/${quoteShort} ${leverage}x`;
                        
                        // For pairs: quantity = margin, price = entry ratio
                        total = trade.quantity; // Margin amount
                        const entryRatio = trade.price;
                        
                        // Get current ratio
                        const teaMap = {};
                        teas.forEach(t => teaMap[t.symbol] = t);
                        const baseTea = teaMap[pair.base_symbol];
                        const quoteTea = teaMap[pair.quote_symbol];
                        
                        if (baseTea && quoteTea && quoteTea.current_price > 0) {
                            const currentRatio = baseTea.current_price / quoteTea.current_price;
                            const ratioChange = (currentRatio - entryRatio) / entryRatio;
                            // LONG profits when ratio goes up, SHORT profits when ratio goes down
                            const direction = trade.side === 'BUY' ? 1 : -1;
                            pnl = total * ratioChange * leverage * direction;
                            pnlPct = ratioChange * 100 * leverage * direction;
                        } else {
                            pnl = 0;
                            pnlPct = 0;
                        }
                    } else {
                        teaSymbol = 'PAIR';
                        total = trade.quantity;
                        pnl = 0;
                        pnlPct = 0;
                    }
                } else {
                    // Regular single tea trade
                    teaSymbol = tea?.symbol || 'Unknown';
                    total = trade.quantity * trade.price;
                    
                    if (isClosed && closing) {
                        pnl = (closing.sellPrice - trade.price) * trade.quantity;
                        pnlPct = ((closing.sellPrice - trade.price) / trade.price * 100);
                    } else if (tea) {
                        pnl = (tea.current_price - trade.price) * trade.quantity;
                        pnlPct = ((tea.current_price - trade.price) / trade.price * 100);
                    } else {
                        pnl = 0;
                        pnlPct = 0;
                    }
                }
                
                const status = isClosed ? 'CLOSED' : 'OPEN';
                
                return {
                    trade,
                    time,
                    timeStr,
                    orderId,
                    tea,
                    teaSymbol,
                    total,
                    isClosed,
                    closing,
                    pnl,
                    pnlPct,
                    status,
                    isPairTrade,
                    leverage
                };
            });

            // Sort based on current sort settings
            processedTrades.sort((a, b) => {
                let comparison = 0;
                switch (ordersSortColumn) {
                    case 'time':
                        comparison = a.time.getTime() - b.time.getTime();
                        break;
                    case 'tea':
                        comparison = a.teaSymbol.localeCompare(b.teaSymbol);
                        break;
                    case 'qty':
                        comparison = a.trade.quantity - b.trade.quantity;
                        break;
                    case 'entry':
                        comparison = a.trade.price - b.trade.price;
                        break;
                    case 'total':
                        comparison = a.total - b.total;
                        break;
                    case 'pnl':
                        comparison = a.pnl - b.pnl;
                        break;
                    case 'status':
                        comparison = a.status.localeCompare(b.status);
                        break;
                    default:
                        comparison = a.time.getTime() - b.time.getTime();
                }
                return ordersSortDirection === 'desc' ? -comparison : comparison;
            });

            let html = '';
            let openCount = 0;
            let openTotalValue = 0;
            let openTotalPnl = 0;

            processedTrades.forEach(({ trade, timeStr, orderId, tea, teaSymbol, total, isClosed, pnl, pnlPct, status, isPairTrade, leverage }) => {
                const pnlClass = pnl >= 0 ? 'up' : 'down';
                const pnlSign = pnl >= 0 ? '+' : '';
                const statusClass = isClosed ? 'closed' : 'filled';
                
                // Different close action for pairs vs singles
                let actionBtn;
                if (isClosed) {
                    actionBtn = `<span style="color: var(--text-muted);">\u2014</span>`;
                } else if (isPairTrade) {
                    actionBtn = `<button class="close-position-btn" onclick="closePairPosition('${trade.id}')">Close</button>`;
                } else {
                    actionBtn = `<button class="close-position-btn" onclick="closePosition(${trade.tea_id}, ${trade.quantity}, '${teaSymbol}')">Close</button>`;
                }

                if (!isClosed) {
                    openCount++;
                    openTotalValue += total;
                    openTotalPnl += pnl;
                }

                // Different display for pair trades
                let sideLabel, sideClass, entryDisplay, qtyDisplay;
                if (isPairTrade) {
                    const isLong = trade.side === 'BUY';
                    sideLabel = isLong ? 'LONG' : 'SHORT';
                    sideClass = isLong ? 'buy-side' : 'sell-side';
                    entryDisplay = trade.price.toFixed(4); // Ratio with 4 decimals
                    qtyDisplay = '$' + trade.quantity.toLocaleString(); // Margin amount
                } else {
                    sideLabel = 'BUY';
                    sideClass = 'buy-side';
                    entryDisplay = '$' + trade.price.toFixed(2);
                    qtyDisplay = trade.quantity.toLocaleString();
                }

                html += `
                    <tr>
                        <td>${timeStr}</td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${orderId}</td>
                        <td>${teaSymbol}</td>
                        <td><span class="order-side ${sideClass}">${sideLabel}</span></td>
                        <td class="order-qty">${qtyDisplay}</td>
                        <td class="order-price">${entryDisplay}</td>
                        <td class="order-price">$${parseFloat(total.toFixed(2)).toLocaleString()}</td>
                        <td class="${pnlClass}">${pnlSign}$${pnl.toFixed(2)} (${pnlPct.toFixed(1)}%)</td>
                        <td><span class="order-status ${statusClass}">${status}</span></td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });

            // Update totals in tfoot
            const tfoot = document.getElementById('orders-tfoot');
            const tfootTotal = document.getElementById('tfoot-total');
            const tfootPnl = document.getElementById('tfoot-pnl');
            const tfootCount = document.getElementById('tfoot-count');

            if (openCount > 0) {
                tfoot.style.display = '';
                const openPnlClass = openTotalPnl >= 0 ? 'up' : 'down';
                const openPnlSign = openTotalPnl >= 0 ? '+' : '';
                const openPnlPct = openTotalValue > 0 ? (openTotalPnl / openTotalValue * 100) : 0;
                
                tfootTotal.textContent = '$' + openTotalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                tfootPnl.innerHTML = `<span class="${openPnlClass}">${openPnlSign}$${openTotalPnl.toFixed(2)} (${openPnlPct.toFixed(1)}%)</span>`;
                tfootCount.innerHTML = `<span style="color: var(--text-muted);">${openCount} open</span>`;
            } else {
                tfoot.style.display = 'none';
            }

            tbody.innerHTML = html;
        }

        // =============================================
        // MARKET DEPTH & MACRO FUNCTIONS
        // =============================================

        let marketDepthBids = 52;
        let tradeHistory = [];

        function updateMarketDepth() {
            // Simulate market depth shifting
            const shift = (Math.random() - 0.5) * 4;
            marketDepthBids = Math.max(35, Math.min(65, marketDepthBids + shift));
            const asks = 100 - marketDepthBids;
            
            const bidsEl = document.getElementById('depth-bids');
            const asksEl = document.getElementById('depth-asks');
            const ratioEl = document.getElementById('depth-ratio');
            
            if (bidsEl && asksEl) {
                bidsEl.style.width = `${marketDepthBids}%`;
                bidsEl.querySelector('.depth-label').textContent = `BIDS ${Math.round(marketDepthBids)}%`;
                asksEl.style.width = `${asks}%`;
                asksEl.querySelector('.depth-label').textContent = `ASKS ${Math.round(asks)}%`;
                
                const ratio = (marketDepthBids / asks).toFixed(2);
                ratioEl.textContent = `Bid/Ask: ${ratio}`;
                
                // Update volumes
                const bidVol = Math.round(8000 + marketDepthBids * 100 + Math.random() * 2000);
                const askVol = Math.round(8000 + asks * 100 + Math.random() * 2000);
                document.getElementById('depth-bid-volume').textContent = `Vol: ${bidVol.toLocaleString()} kg`;
                document.getElementById('depth-ask-volume').textContent = `Vol: ${askVol.toLocaleString()} kg`;
                
                // Update mid price based on selected tea
                const select = document.getElementById('trade-tea-select');
                const selectedTea = teas.find(t => t.symbol === select?.value);
                const midPrice = (selectedTea?.current_price || 4.82).toFixed(2);
                document.getElementById('depth-mid-price').textContent = `Mid: $${midPrice}`;
            }
        }

        function switchWatchlistTab(tab) {
            document.querySelectorAll('.watchlist-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('watchlist-teas').style.display = tab === 'teas' ? 'block' : 'none';
            document.getElementById('watchlist-macro').style.display = tab === 'macro' ? 'block' : 'none';
        }

        function updateMacroIndicators() {
            // Simulate small changes
            const usdkes = 129.45 + (Math.random() - 0.5) * 0.3;
            const oil = 82.40 + (Math.random() - 0.5) * 0.5;
            const bdi = 1842 + Math.round((Math.random() - 0.5) * 20);
            
            const usdkesEl = document.getElementById('macro-usdkes');
            const oilEl = document.getElementById('macro-oil');
            const bdiEl = document.getElementById('macro-bdi');
            
            if (usdkesEl) usdkesEl.textContent = usdkes.toFixed(2);
            if (oilEl) oilEl.textContent = `$${oil.toFixed(2)}`;
            if (bdiEl) bdiEl.textContent = bdi.toLocaleString();
        }

        function switchPortfolioTab(tab) {
            document.querySelectorAll('.portfolio-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const positionsEl = document.getElementById('portfolio-positions');
            const historyEl = document.getElementById('portfolio-history');
            
            if (positionsEl && historyEl) {
                positionsEl.classList.toggle('active', tab === 'positions');
                historyEl.classList.toggle('active', tab === 'history');
            }
            
            if (tab === 'history') {
                updateTradeLogDisplay();
            }
        }

        function recordClosedTrade(position, exitPrice) {
            const entryPrice = position.avg_price;
            const pnl = position.type === 'long' 
                ? (exitPrice - entryPrice) * position.quantity
                : (entryPrice - exitPrice) * position.quantity;
            const pnlPercent = ((exitPrice - entryPrice) / entryPrice * 100) * (position.type === 'long' ? 1 : -1);
            
            const now = new Date();
            const entryDate = new Date(position.created_at || now);
            const duration = now - entryDate;
            
            const trade = {
                id: Date.now(),
                symbol: position.teas?.symbol || position.symbol,
                type: position.type,
                quantity: position.quantity,
                entryPrice: entryPrice,
                exitPrice: exitPrice,
                pnl: pnl,
                pnlPercent: pnlPercent,
                duration: duration,
                fees: Math.abs(pnl * 0.002), // 0.2% fee simulation
                closedAt: now
            };
            
            tradeHistory.push(trade);
            localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));
            updateTradeLogDisplay();
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m`;
            return `${seconds}s`;
        }

        function updateTradeLogDisplay() {
            const tbody = document.getElementById('trade-log-body');
            const statPnl = document.getElementById('stat-total-pnl');
            const statWinRate = document.getElementById('stat-win-rate');
            const statTrades = document.getElementById('stat-trades');
            const statAvgHold = document.getElementById('stat-avg-hold');
            
            if (!tbody) return;
            
            // Build closed trades from currentTradesData (Supabase)
            const closedTrades = [];
            
            if (currentTradesData && currentTradesData.length > 0) {
                const buyTrades = currentTradesData.filter(t => t.side === 'BUY');
                const sellTrades = currentTradesData.filter(t => t.side === 'SELL');
                const closedBuyIds = new Set();
                
                // Match SELL trades to BUY trades
                sellTrades.forEach(sell => {
                    const matchingBuy = buyTrades.find(buy => 
                        buy.tea_id === sell.tea_id && 
                        !closedBuyIds.has(buy.id) &&
                        buy.id < sell.id
                    );
                    if (matchingBuy) {
                        closedBuyIds.add(matchingBuy.id);
                        
                        // Find tea symbol
                        const tea = teas.find(t => t.id === matchingBuy.tea_id);
                        const symbol = tea?.symbol || 'Unknown';
                        
                        const entryPrice = matchingBuy.price;
                        const exitPrice = sell.price;
                        const quantity = Math.min(matchingBuy.quantity, sell.quantity);
                        const pnl = (exitPrice - entryPrice) * quantity;
                        const pnlPercent = ((exitPrice - entryPrice) / entryPrice) * 100;
                        
                        const entryDate = new Date(matchingBuy.created_at);
                        const exitDate = new Date(sell.created_at);
                        const duration = exitDate - entryDate;
                        
                        closedTrades.push({
                            id: sell.id,
                            symbol: symbol,
                            type: 'long',
                            quantity: quantity,
                            entryPrice: entryPrice,
                            exitPrice: exitPrice,
                            pnl: pnl,
                            pnlPercent: pnlPercent,
                            duration: duration,
                            fees: Math.abs(pnl * 0.002),
                            closedAt: exitDate
                        });
                    }
                });
            }
            
            if (closedTrades.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">No closed trades yet</td></tr>`;
                if (statPnl) statPnl.textContent = '+$0.00';
                if (statWinRate) statWinRate.textContent = '0%';
                if (statTrades) statTrades.textContent = '0';
                if (statAvgHold) statAvgHold.textContent = 'â€”';
                return;
            }
            
            // Calculate stats
            const totalPnl = closedTrades.reduce((sum, t) => sum + t.pnl, 0);
            const wins = closedTrades.filter(t => t.pnl > 0).length;
            const winRate = (wins / closedTrades.length * 100).toFixed(0);
            const avgHold = closedTrades.reduce((sum, t) => sum + t.duration, 0) / closedTrades.length;
            
            statPnl.textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}`;
            statPnl.className = `trade-stat-value ${totalPnl >= 0 ? 'up' : 'down'}`;
            statWinRate.textContent = `${winRate}%`;
            statTrades.textContent = closedTrades.length;
            statAvgHold.textContent = formatDuration(avgHold);
            
            // Sort by most recent and render table
            closedTrades.sort((a, b) => b.closedAt - a.closedAt);
            tbody.innerHTML = closedTrades.slice(0, 20).map(t => `
                <tr>
                    <td style="font-weight: 500;">${t.symbol}</td>
                    <td><span class="trade-type-badge ${t.type}">${t.type}</span></td>
                    <td style="font-family: 'JetBrains Mono', monospace;">$${t.entryPrice.toFixed(2)}</td>
                    <td style="font-family: 'JetBrains Mono', monospace;">$${t.exitPrice.toFixed(2)}</td>
                    <td class="${t.pnl >= 0 ? 'up' : 'down'}" style="font-family: 'JetBrains Mono', monospace;">
                        ${t.pnl >= 0 ? '+' : ''}$${t.pnl.toFixed(2)}<br>
                        <span style="font-size: 8px; opacity: 0.7;">${t.pnlPercent >= 0 ? '+' : ''}${t.pnlPercent.toFixed(1)}%</span>
                    </td>
                    <td style="color: var(--text-muted); font-size: 9px;">${formatDuration(t.duration)}</td>
                </tr>
            `).join('');
        }

        // =============================================
        // COMMAND LINE FUNCTIONS
        // =============================================

        const commandAliases = {
            // Tea symbols
            'BP1': { action: 'selectTea', symbol: 'KEN-BP1', desc: 'Kenya BP1' },
            'PF1': { action: 'selectTea', symbol: 'KEN-PF1', desc: 'Kenya PF1' },
            'DUST': { action: 'selectTea', symbol: 'KEN-DUST', desc: 'Kenya Dust' },
            'YUN': { action: 'selectTea', symbol: 'CHN-YUN', desc: 'Yunnan Gold' },
            'DRJ': { action: 'selectTea', symbol: 'IND-DRJ', desc: 'Darjeeling First Flush' },
            'ASM': { action: 'selectTea', symbol: 'IND-ASM', desc: 'Assam Orthodox' },
            'BOP': { action: 'selectTea', symbol: 'SRI-BOP', desc: 'Ceylon BOP' },
            'PEK': { action: 'selectTea', symbol: 'SRI-PEK', desc: 'Ceylon Pekoe' },
            // Commands
            'NEWS': { action: 'scrollTo', target: 'news', desc: 'Jump to News' },
            'CHART': { action: 'scrollTo', target: 'chart', desc: 'Jump to Chart' },
            'ORDERS': { action: 'scrollTo', target: 'orders', desc: 'View Orders' },
            'PORTFOLIO': { action: 'showPortfolio', desc: 'Show Portfolio' },
            'HISTORY': { action: 'showHistory', desc: 'Trade History' },
            'MACRO': { action: 'showMacro', desc: 'Macro Indicators' },
            'LONG': { action: 'setTradeType', type: 'long', desc: 'Set Long Position' },
            'SHORT': { action: 'setTradeType', type: 'short', desc: 'Set Short Position' },
            'MAX': { action: 'maximizeChart', desc: 'Maximize Chart' },
            'CLEAR': { action: 'clearCommand', desc: 'Clear Input' },
        };

        function initCommandLine() {
            const input = document.getElementById('command-line');
            const suggestions = document.getElementById('command-suggestions');
            
            if (!input) return;

            input.addEventListener('input', (e) => {
                const val = e.target.value.toUpperCase().trim();
                if (val.length === 0) {
                    suggestions.classList.remove('active');
                    return;
                }
                
                // Find matching commands
                const matches = [];
                
                // Check for BUY/SELL commands
                if (val.startsWith('BUY ') || val.startsWith('SELL ')) {
                    const parts = val.split(' ');
                    const qty = parts[1] || '';
                    matches.push({
                        cmd: val,
                        desc: `${parts[0]} ${qty || '?'} lots of selected tea`
                    });
                }
                
                // Check for tea symbols and commands
                Object.keys(commandAliases).forEach(key => {
                    if (key.includes(val) || val.includes(key)) {
                        matches.push({
                            cmd: key,
                            desc: commandAliases[key].desc
                        });
                    }
                });
                
                if (matches.length > 0) {
                    suggestions.innerHTML = matches.slice(0, 6).map((m, i) => `
                        <div class="command-suggestion ${i === 0 ? 'selected' : ''}" data-cmd="${m.cmd}">
                            <span class="command-suggestion-cmd">${m.cmd}</span>
                            <span class="command-suggestion-desc">${m.desc}</span>
                        </div>
                    `).join('');
                    suggestions.classList.add('active');
                } else {
                    suggestions.classList.remove('active');
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    executeCommand(input.value);
                    input.value = '';
                    suggestions.classList.remove('active');
                } else if (e.key === 'Escape') {
                    input.value = '';
                    suggestions.classList.remove('active');
                    input.blur();
                }
            });

            // Click on suggestion
            suggestions.addEventListener('click', (e) => {
                const item = e.target.closest('.command-suggestion');
                if (item) {
                    input.value = item.dataset.cmd;
                    executeCommand(input.value);
                    input.value = '';
                    suggestions.classList.remove('active');
                }
            });

            // Global keyboard shortcut
            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement !== input) {
                    e.preventDefault();
                    input.focus();
                }
            });
        }

        function executeCommand(cmd) {
            const parts = cmd.toUpperCase().trim().split(' ');
            const command = parts[0];
            const arg = parts[1];

            // Check for BUY/SELL
            if (command === 'BUY' || command === 'SELL') {
                const qty = parseInt(arg) || 100;
                const selectedTea = document.getElementById('trade-tea-select')?.value;
                if (selectedTea) {
                    document.getElementById('trade-qty').value = qty;
                    if (command === 'BUY') {
                        setTradeType('BUY');
                    } else {
                        setTradeType('SELL');
                    }
                    updateTradeSummary();
                    showToast('Trade Ready', `${command} ${qty} kg of ${selectedTea}`);
                } else {
                    showToast('Select a tea first', 'Click on a tea in Quick Quotes', true);
                }
                return;
            }

            // Check command aliases
            const alias = commandAliases[command];
            if (alias) {
                switch (alias.action) {
                    case 'selectTea':
                        const tea = teas.find(t => t.symbol === alias.symbol);
                        if (tea) {
                            selectTeaForTrading(tea.symbol);
                            showToast('Selected', alias.desc);
                        }
                        break;
                    case 'scrollTo':
                        if (alias.target === 'chart') {
                            document.getElementById('chart-section')?.scrollIntoView({ behavior: 'smooth' });
                        } else if (alias.target === 'orders') {
                            document.getElementById('orders-section')?.scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    case 'showPortfolio':
                        document.getElementById('portfolio-section').style.display = 'block';
                        switchPortfolioTab('positions');
                        break;
                    case 'showHistory':
                        document.getElementById('portfolio-section').style.display = 'block';
                        switchPortfolioTab('history');
                        break;
                    case 'showMacro':
                        switchWatchlistTab('macro');
                        break;
                    case 'setTradeType':
                        setTradeType(alias.type);
                        break;
                    case 'maximizeChart':
                        toggleMaximize('chart-section');
                        break;
                    case 'clearCommand':
                        break;
                }
            } else {
                // Try to find tea by searching
                const foundTea = teas.find(t => 
                    t.symbol.toUpperCase().includes(command) || 
                    t.name.toUpperCase().includes(command)
                );
                if (foundTea) {
                    selectTeaForTrading(foundTea.symbol);
                    showToast('Selected', foundTea.name);
                }
            }
        }

        // =============================================
        // MOBILE MENU FUNCTIONS
        // =============================================
        
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (sidebar.classList.contains('mobile-open')) {
                closeMobileMenu();
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Close mobile menu on window resize to desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth > 1200) {
                closeMobileMenu();
            }
        });

        // =============================================
        // LIVE CHAT SYSTEM
        // =============================================
        
        let chatMessages = [];
        let chatSubscription = null;
        let onlineUsers = new Set();
        
        // Initialize chat system
        async function initChat() {
            await loadChatMessages();
            setupChatSubscription();
            setupChatInputListeners();
            updateOnlineCount();
            
            // Simulate some users being online
            setInterval(updateOnlineCount, 30000);
        }
        
        // Load recent chat messages
        async function loadChatMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(50);
                
                if (error) {
                    // Table might not exist yet - show demo messages
                    console.log('Chat table not found, using demo messages');
                    loadDemoChatMessages();
                    return;
                }
                
                chatMessages = data || [];
                renderChatMessages();
            } catch (err) {
                console.error('Error loading chat:', err);
                loadDemoChatMessages();
            }
        }
        
        // Load demo messages for when the table doesn't exist
        function loadDemoChatMessages() {
            const now = new Date();
            chatMessages = [
                { id: 1, sender_email: 'k.muthoni@ktda.co.ke', sender_name: 'K.MUTHONI', message: 'New lots arriving from Kericho highlands tomorrow. Premium quality expected.', created_at: new Date(now - 35 * 60000).toISOString(), is_private: false },
                { id: 2, sender_email: 'm.wong@ekaterra.com', sender_name: 'M.WONG', message: 'Any visibility on Ceylon OP availability next week?', created_at: new Date(now - 22 * 60000).toISOString(), is_private: false },
                { id: 3, sender_email: 'system', sender_name: 'SYSTEM', message: 'Trade alert: Lot #24608 has been matched.', created_at: new Date(now - 15 * 60000).toISOString(), is_private: false, is_system: true },
                { id: 4, sender_email: 'r.patel@tata.com', sender_name: 'R.PATEL', message: 'Confirmed 15MT Assam CTC at 285. Settlement T+2.', created_at: new Date(now - 8 * 60000).toISOString(), is_private: false },
                { id: 5, sender_email: 'j.harrison@finlays.com', sender_name: 'J.HARRISON', message: 'Looking for 20MT BP1 Mombasa. Can you source?', created_at: new Date(now - 2 * 60000).toISOString(), is_private: false }
            ];
            renderChatMessages();
        }
        
        // Set up real-time subscription
        function setupChatSubscription() {
            chatSubscription = supabaseClient
                .channel('chat_messages')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'chat_messages' },
                    (payload) => {
                        const newMessage = payload.new;
                        // Check if it's a private message for someone else
                        if (newMessage.is_private && newMessage.recipient_email !== currentUser?.email && newMessage.sender_email !== currentUser?.email) {
                            return; // Don't show private messages not meant for us
                        }
                        chatMessages.push(newMessage);
                        renderChatMessages();
                    }
                )
                .subscribe();
        }
        
        // Render chat messages
        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            const currentEmail = currentUser?.email || '';
            
            container.innerHTML = chatMessages.map(msg => {
                const isOwn = msg.sender_email === currentEmail;
                const isPrivate = msg.is_private;
                const isSystem = msg.is_system || msg.sender_name === 'SYSTEM';
                
                let msgClass = 'chat-message';
                if (isOwn) msgClass += ' own';
                if (isPrivate) msgClass += ' private';
                
                let senderClass = 'chat-sender';
                if (isSystem) senderClass += ' system';
                
                const time = formatChatTime(msg.created_at);
                const senderDisplay = isOwn ? 'YOU' : msg.sender_name || msg.sender_email?.split('@')[0].toUpperCase();
                
                let recipientTag = '';
                if (isPrivate && msg.recipient_email) {
                    const recipientName = msg.recipient_email.split('@')[0].toUpperCase();
                    recipientTag = `<span class="chat-sender dm-target">@${recipientName}</span>`;
                }
                
                return `
                    <div class="${msgClass}">
                        <div class="chat-message-header">
                            <span class="${senderClass}">${senderDisplay}${recipientTag}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                        <div class="chat-text">${escapeHtml(msg.message)}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        // Format chat timestamp
        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m ago`;
            
            // Show time if today
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Show date if older
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Set up input listeners
        function setupChatInputListeners() {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }
        
        // Send a chat message
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const message = input.value.trim();
            if (!message) return;
            
            // Check if user is logged in
            if (!currentUser) {
                showToast('Login Required', 'Please log in to send messages');
                openAuthModal();
                return;
            }
            
            // Parse for @username (private message)
            let isPrivate = false;
            let recipientEmail = null;
            let actualMessage = message;
            
            const dmMatch = message.match(/^@(\S+)\s+(.+)/);
            if (dmMatch) {
                isPrivate = true;
                const recipientHandle = dmMatch[1].toLowerCase();
                actualMessage = dmMatch[2];
                
                // Try to find recipient (for demo, just use the handle as email prefix)
                recipientEmail = recipientHandle.includes('@') ? recipientHandle : `${recipientHandle}@teatrade.exchange`;
            }
            
            // Clear input immediately for responsiveness
            input.value = '';
            
            // Get sender name
            const senderName = currentUser.email.split('@')[0].toUpperCase();
            
            try {
                const { error } = await supabaseClient
                    .from('chat_messages')
                    .insert({
                        sender_email: currentUser.email,
                        sender_name: senderName,
                        message: actualMessage,
                        is_private: isPrivate,
                        recipient_email: recipientEmail
                    });
                
                if (error) {
                    // Table might not exist - add locally for demo
                    console.log('Chat insert error (table may not exist), adding locally');
                    addLocalChatMessage(senderName, actualMessage, isPrivate, recipientEmail);
                }
            } catch (err) {
                console.error('Error sending message:', err);
                addLocalChatMessage(senderName, actualMessage, isPrivate, recipientEmail);
            }
        }
        
        // Add message locally (for demo/offline mode)
        function addLocalChatMessage(senderName, message, isPrivate, recipientEmail) {
            const newMsg = {
                id: Date.now(),
                sender_email: currentUser?.email || 'demo@user.com',
                sender_name: senderName,
                message: message,
                created_at: new Date().toISOString(),
                is_private: isPrivate,
                recipient_email: recipientEmail
            };
            chatMessages.push(newMsg);
            renderChatMessages();
        }
        
        // Send a blast message (highlighted)
        function sendBlastMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const message = input.value.trim();
            if (!message) {
                showToast('Empty Message', 'Type a message to blast');
                return;
            }
            
            if (!currentUser) {
                showToast('Login Required', 'Please log in to send blasts');
                openAuthModal();
                return;
            }
            
            // Blast is just a highlighted global message
            input.value = `ðŸ”¥ BLAST: ${message}`;
            sendChatMessage();
        }
        
        // Update online user count
        function updateOnlineCount() {
            const countEl = document.getElementById('chat-online-count');
            if (!countEl) return;
            
            // Simulate random online count (2-8)
            const count = 2 + Math.floor(Math.random() * 7);
            countEl.textContent = `${count} online`;
        }
        
        // Initialize chat when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initChat, 1000); // Delay to let auth initialize first
        });

        // =============================================
        // MAXIMIZE FUNCTIONS
        // =============================================

        let maximizedPanel = null;

        function toggleMaximize(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;

            if (panel.classList.contains('panel-maximized')) {
                // Restore
                panel.classList.remove('panel-maximized');
                document.body.style.overflow = '';
                maximizedPanel = null;
            } else {
                // Maximize
                if (maximizedPanel) {
                    maximizedPanel.classList.remove('panel-maximized');
                }
                panel.classList.add('panel-maximized');
                document.body.style.overflow = 'hidden';
                maximizedPanel = panel;
            }

            // Trigger resize for chart redraw
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
                drawChart();
            }, 100);
        }

        // Escape key to close maximized panel
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && maximizedPanel) {
                toggleMaximize(maximizedPanel.id);
            }
        });

        // =============================================
        // FLASH QUOTE BOARD FUNCTIONS
        // =============================================

        let previousQuotePrices = {};

        function initQuoteBoard() {
            updateQuoteBoard();
        }

        let selectedQuoteSymbol = null;

        function updateQuoteBoard() {
            const board = document.getElementById('quote-board');
            if (!board || !teas || teas.length === 0) return;

            // Show 10 teas for 2 complete rows of 5
            const topTeas = teas.slice(0, 10);
            
            board.innerHTML = topTeas.map(tea => {
                const symbol = tea.symbol.split('-')[1] || tea.symbol;
                const price = tea.current_price || 0;
                const change = tea.price_change_24h || 0;
                const volume = tea.volume_24h || 0;
                const isUp = change >= 0;
                const prevPrice = previousQuotePrices[tea.symbol];
                let flashClass = '';
                const selectedClass = selectedQuoteSymbol === tea.symbol ? 'selected' : '';
                
                if (prevPrice !== undefined && prevPrice !== price) {
                    flashClass = price > prevPrice ? 'flash-green' : 'flash-red';
                }
                previousQuotePrices[tea.symbol] = price;
                
                const volDisplay = volume >= 1000 ? `${Math.round(volume / 1000)}K` : volume.toString();

                return `
                    <div class="quote-card ${flashClass} ${selectedClass}" onclick="selectTeaForTrading('${tea.symbol}')">
                        <div class="quote-symbol">${symbol}</div>
                        <div class="quote-price ${isUp ? 'up' : 'down'}">$${price.toFixed(2)}</div>
                        <div class="quote-change ${isUp ? 'up' : 'down'}">${isUp ? 'â–²' : 'â–¼'} ${change >= 0 ? '+' : ''}${change.toFixed(1)}%</div>
                        <div class="quote-volume">Vol: ${volDisplay}</div>
                    </div>
                `;
            }).join('');
        }
        
        function selectTeaForTrading(symbol) {
            // Track selected symbol
            selectedQuoteSymbol = symbol;
            
            // Find the tea data
            const tea = teas.find(t => t.symbol === symbol);
            if (!tea) return;
            
            // Open the quick quote modal
            openQuickQuoteModal(tea);
        }
        
        let quickQuoteTradeType = 'BUY';
        let quickQuoteTea = null;
        
        function openQuickQuoteModal(tea) {
            quickQuoteTea = tea;
            const modal = document.getElementById('quick-quote-modal');
            if (!modal) return;
            
            const shortSymbol = tea.symbol.split('-')[1] || tea.symbol;
            const price = tea.current_price || 0;
            const change = tea.price_change_24h || 0;
            const isUp = change >= 0;
            const volume = tea.volume_24h || 0;
            
            // Populate header
            document.getElementById('qq-symbol').textContent = shortSymbol;
            document.getElementById('qq-name').textContent = tea.name;
            
            const priceEl = document.getElementById('qq-price');
            priceEl.textContent = `$${price.toFixed(2)}`;
            priceEl.className = `quick-quote-current-price ${isUp ? 'up' : 'down'}`;
            
            const changeEl = document.getElementById('qq-change');
            changeEl.textContent = `${isUp ? '+' : ''}${change.toFixed(1)}%`;
            changeEl.className = `quick-quote-change ${isUp ? 'up' : 'down'}`;
            
            // Get historical data and compute real stats
            const history = generateTeaHistory(tea);
            const last24h = history.length >= 24 ? history.slice(-24) : history;
            
            // Guard against empty data
            let high24h = price * 1.04;
            let low24h = price * 0.96;
            let avg24h = price;
            let totalVolume = 0;
            
            if (last24h.length > 0) {
                high24h = Math.max(...last24h.map(d => d.high));
                low24h = Math.min(...last24h.map(d => d.low));
                avg24h = last24h.reduce((sum, d) => sum + d.close, 0) / last24h.length;
                totalVolume = last24h.reduce((sum, d) => sum + d.volume, 0);
            }
            
            document.getElementById('qq-high').textContent = `$${high24h.toFixed(2)}`;
            document.getElementById('qq-low').textContent = `$${low24h.toFixed(2)}`;
            document.getElementById('qq-volume').textContent = totalVolume >= 1000000 ? `${Math.round(totalVolume / 1000000)}M` : totalVolume >= 1000 ? `${Math.round(totalVolume / 1000)}K` : totalVolume.toString();
            document.getElementById('qq-avg').textContent = `$${avg24h.toFixed(2)}`;
            
            // Set trade price
            document.getElementById('qq-trade-price').value = price.toFixed(2);
            document.getElementById('qq-qty').value = 100;
            
            // Update balance
            const balance = userProfile?.cash_balance || 10000;
            document.getElementById('qq-balance').textContent = `$${balance.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            
            // Reset trade type to BUY
            setQuickTradeType('BUY');
            updateQuickTradeSummary();
            
            // Show modal FIRST so canvas has dimensions
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Draw the chart AFTER modal is visible (needs a small delay for layout)
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    drawQuickQuoteChart(tea);
                });
            });
        }
        
        function closeQuickQuoteModal() {
            const modal = document.getElementById('quick-quote-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        function setQuickTradeType(type) {
            quickQuoteTradeType = type;
            
            const buyBtn = document.getElementById('qq-btn-buy');
            const sellBtn = document.getElementById('qq-btn-sell');
            const execBtn = document.getElementById('qq-execute-btn');
            
            buyBtn.classList.toggle('active', type === 'BUY');
            sellBtn.classList.toggle('active', type === 'SELL');
            
            execBtn.className = `quick-trade-execute ${type.toLowerCase()}`;
            updateQuickTradeSummary();
        }
        
        function updateQuickTradeSummary() {
            const qty = parseFloat(document.getElementById('qq-qty').value) || 0;
            const price = parseFloat(document.getElementById('qq-trade-price').value) || 0;
            const total = qty * price;
            const balance = userProfile?.cash_balance || 10000;
            const afterTrade = quickQuoteTradeType === 'BUY' ? balance - total : balance + total;
            
            document.getElementById('qq-order-value').textContent = `$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('qq-after-trade').textContent = `$${afterTrade.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            
            const execBtn = document.getElementById('qq-execute-btn');
            execBtn.textContent = `${quickQuoteTradeType} ${qty} kg`;
        }
        
        // Store Quick Quote chart metadata for crosshair
        let qqChartMeta = {
            data: [],
            padding: { top: 20, right: 70, bottom: 30, left: 60 },
            minPrice: 0,
            maxPrice: 0,
            chartWidth: 0,
            chartHeight: 0,
            w: 0,
            h: 0
        };
        
        function drawQuickQuoteChart(tea) {
            const canvas = document.getElementById('qq-chart');
            if (!canvas || !tea) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            if (rect.width <= 0 || rect.height <= 0) return;
            
            // High DPI support
            const dpr = window.devicePixelRatio || 1;
            const w = rect.width;
            const h = rect.height;
            
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            ctx.scale(dpr, dpr);
            
            const price = tea.current_price || 3.5;
            const change = tea.price_change_24h || 0;
            const isUp = change >= 0;
            
            // Get historical data for this tea (last 48 hours = 48 candles at hourly)
            const fullHistory = generateTeaHistory(tea);
            if (!fullHistory || fullHistory.length === 0) return;
            
            const historySlice = fullHistory.slice(-48); // Last 48 hours
            if (historySlice.length === 0) return;
            
            const padding = { top: 20, right: 70, bottom: 30, left: 60 };
            const chartWidth = w - padding.left - padding.right;
            const chartHeight = h - padding.top - padding.bottom;
            
            const allHighs = historySlice.map(d => d.high);
            const allLows = historySlice.map(d => d.low);
            const minPrice = Math.min(...allLows) * 0.998;
            const maxPrice = Math.max(...allHighs) * 1.002;
            
            // Store metadata for crosshair
            qqChartMeta = { data: historySlice, padding, minPrice, maxPrice, chartWidth, chartHeight, w, h };
            
            // Clear
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, w, h);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(w - padding.right, y);
                ctx.stroke();
                
                const priceLabel = maxPrice - ((maxPrice - minPrice) / 4) * i;
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.font = '10px JetBrains Mono';
                ctx.textAlign = 'right';
                ctx.fillText(`$${priceLabel.toFixed(2)}`, padding.left - 8, y + 3);
            }
            
            // Draw time labels
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.font = '9px JetBrains Mono';
            ctx.textAlign = 'center';
            const timeLabels = [0, Math.floor(historySlice.length / 4), Math.floor(historySlice.length / 2), Math.floor(3 * historySlice.length / 4), historySlice.length - 1];
            timeLabels.forEach(i => {
                if (historySlice[i]) {
                    const x = padding.left + (i / (historySlice.length - 1)) * chartWidth;
                    const date = historySlice[i].date;
                    const label = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    ctx.fillText(label, x, h - 8);
                }
            });
            
            // Draw candlesticks
            const candleWidth = Math.max(3, Math.min(10, (chartWidth / historySlice.length) * 0.7));
            
            historySlice.forEach((candle, i) => {
                const x = padding.left + (i / (historySlice.length - 1)) * chartWidth;
                const candleUp = candle.close >= candle.open;
                const color = candleUp ? '#10b981' : '#ef4444';
                
                const openY = padding.top + ((maxPrice - candle.open) / (maxPrice - minPrice)) * chartHeight;
                const closeY = padding.top + ((maxPrice - candle.close) / (maxPrice - minPrice)) * chartHeight;
                const highY = padding.top + ((maxPrice - candle.high) / (maxPrice - minPrice)) * chartHeight;
                const lowY = padding.top + ((maxPrice - candle.low) / (maxPrice - minPrice)) * chartHeight;
                
                // Wick
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Body
                const bodyTop = Math.min(openY, closeY);
                const bodyHeight = Math.max(1, Math.abs(closeY - openY));
                ctx.fillStyle = color;
                ctx.fillRect(x - candleWidth / 2, bodyTop, candleWidth, bodyHeight);
            });
            
            // Draw current price line
            const currentY = padding.top + ((maxPrice - price) / (maxPrice - minPrice)) * chartHeight;
            ctx.beginPath();
            ctx.setLineDash([4, 4]);
            ctx.moveTo(padding.left, currentY);
            ctx.lineTo(w - padding.right, currentY);
            ctx.strokeStyle = isUp ? '#10b981' : '#ef4444';
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Current price label
            ctx.fillStyle = isUp ? '#10b981' : '#ef4444';
            ctx.fillRect(w - padding.right + 2, currentY - 8, 55, 16);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 10px JetBrains Mono';
            ctx.textAlign = 'left';
            ctx.fillText(`$${price.toFixed(2)}`, w - padding.right + 6, currentY + 3);
            
            // Setup crosshair events (once)
            if (!canvas.dataset.crosshairSetup) {
                canvas.dataset.crosshairSetup = 'true';
                setupQQChartCrosshair(canvas);
            }
        }
        
        function setupQQChartCrosshair(canvas) {
            const crosshair = document.getElementById('qq-crosshair');
            const tooltip = document.getElementById('qq-tooltip');
            if (!crosshair || !tooltip) return;
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const { data, padding, minPrice, maxPrice, chartWidth, chartHeight, w, h } = qqChartMeta;
                if (!data || data.length === 0) return;
                
                // Check if within chart area
                if (x < padding.left || x > w - padding.right || y < padding.top || y > h - padding.bottom) {
                    crosshair.style.display = 'none';
                    tooltip.style.display = 'none';
                    return;
                }
                
                // Find nearest candle
                const normalizedX = (x - padding.left) / chartWidth;
                const candleIndex = Math.round(normalizedX * (data.length - 1));
                const candle = data[Math.max(0, Math.min(data.length - 1, candleIndex))];
                if (!candle) return;
                
                // Calculate candle X position
                const candleX = padding.left + (candleIndex / (data.length - 1)) * chartWidth;
                
                // Show crosshair
                crosshair.style.display = 'block';
                crosshair.querySelector('.qq-crosshair-v').style.left = candleX + 'px';
                crosshair.querySelector('.qq-crosshair-h').style.top = y + 'px';
                
                // Calculate price at cursor Y
                const priceAtY = maxPrice - ((y - padding.top) / chartHeight) * (maxPrice - minPrice);
                
                // Format tooltip
                const candleUp = candle.close >= candle.open;
                const changeAmount = candle.close - candle.open;
                const changePercent = (changeAmount / candle.open * 100).toFixed(2);
                const timeStr = candle.date.toLocaleString('en-GB', { 
                    weekday: 'short', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                tooltip.innerHTML = `
                    <div class="qq-tooltip-row">
                        <span class="qq-tooltip-label">Time</span>
                        <span class="qq-tooltip-value">${timeStr}</span>
                    </div>
                    <div class="qq-tooltip-row">
                        <span class="qq-tooltip-label">Open</span>
                        <span class="qq-tooltip-value">$${candle.open.toFixed(2)}</span>
                    </div>
                    <div class="qq-tooltip-row">
                        <span class="qq-tooltip-label">High</span>
                        <span class="qq-tooltip-value">$${candle.high.toFixed(2)}</span>
                    </div>
                    <div class="qq-tooltip-row">
                        <span class="qq-tooltip-label">Low</span>
                        <span class="qq-tooltip-value">$${candle.low.toFixed(2)}</span>
                    </div>
                    <div class="qq-tooltip-row">
                        <span class="qq-tooltip-label">Close</span>
                        <span class="qq-tooltip-value ${candleUp ? 'up' : 'down'}">$${candle.close.toFixed(2)}</span>
                    </div>
                    <div class="qq-tooltip-row">
                        <span class="qq-tooltip-label">Change</span>
                        <span class="qq-tooltip-value ${candleUp ? 'up' : 'down'}">${candleUp ? '+' : ''}${changePercent}%</span>
                    </div>
                `;
                
                // Position tooltip
                tooltip.style.display = 'block';
                let tooltipX = candleX + 15;
                let tooltipY = y - 60;
                
                // Keep tooltip in bounds
                if (tooltipX + 150 > w) tooltipX = candleX - 165;
                if (tooltipY < 10) tooltipY = y + 15;
                
                tooltip.style.left = tooltipX + 'px';
                tooltip.style.top = tooltipY + 'px';
            });
            
            canvas.addEventListener('mouseleave', () => {
                crosshair.style.display = 'none';
                tooltip.style.display = 'none';
            });
        }
        
        async function executeQuickTrade() {
            if (!currentUser) {
                closeQuickQuoteModal();
                openAuthModal();
                return;
            }
            
            if (!quickQuoteTea) return;
            
            const qty = parseFloat(document.getElementById('qq-qty').value) || 0;
            const price = quickQuoteTea.current_price;
            const total = qty * price;
            
            if (qty <= 0) {
                showToast('Invalid quantity', 'Please enter a valid quantity', true);
                return;
            }
            
            // Use existing trade logic
            const select = document.getElementById('trade-tea-select');
            if (select) {
                select.value = quickQuoteTea.symbol;
            }
            document.getElementById('trade-qty').value = qty;
            setTradeType(quickQuoteTradeType);
            
            // Execute the trade
            await executeTrade();
            
            // Close modal
            closeQuickQuoteModal();
        }
        
        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeQuickQuoteModal();
            }
        });
        
        // Close modal on overlay click
        document.getElementById('quick-quote-modal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-quote-modal-overlay')) {
                closeQuickQuoteModal();
            }
        });

        // Start market depth animation
        setInterval(updateMarketDepth, 2000);
        setInterval(updateMacroIndicators, 5000);
        setInterval(updateQuoteBoard, 3000);

        // Initialize command line
        initCommandLine();

        // =============================================
        // LEADERBOARD FUNCTIONS
        // =============================================

        async function loadLeaderboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .order('total_value', { ascending: false })
                    .limit(10);

                if (error) throw error;
                
                if (data && data.length > 0) {
                    updateLeaderboardDisplay(data);
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
        }

        function updateLeaderboardDisplay(leaders) {
            const listEl = document.getElementById('leaderboard-list');
            let html = '';

            leaders.forEach((user, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';

                const returnPct = user.return_pct || 0;
                const returnClass = returnPct >= 0 ? 'up' : 'down';
                const returnSign = returnPct >= 0 ? '+' : '';

                html += `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank ${rankClass}">${rank}</div>
                        <div class="leaderboard-name">${user.username}</div>
                        <div class="leaderboard-return ${returnClass}">${returnSign}${returnPct.toFixed(1)}%</div>
                    </div>
                `;
            });

            if (html) {
                listEl.innerHTML = html;
            }
        }

        // =============================================
        // PAIRS TRADING SYSTEM
        // =============================================

        let teaPairs = [];
        let currentPairTrade = null;
        let selectedLeverage = 1;
        let previousPairRatios = {};

        async function loadTeaPairs() {
            try {
                const { data, error } = await supabaseClient
                    .from('tea_pairs')
                    .select('*');
                
                if (error) throw error;
                teaPairs = data;
                updatePairsTable();
            } catch (error) {
                console.error('Failed to load pairs:', error);
            }
        }

        function setMarketView(view) {
            const singlesView = document.getElementById('singles-view');
            const pairsView = document.getElementById('pairs-view');
            const toggleSingles = document.getElementById('toggle-singles');
            const togglePairs = document.getElementById('toggle-pairs');
            const gradeFilters = document.getElementById('grade-filters');

            if (view === 'singles') {
                singlesView.style.display = 'block';
                pairsView.style.display = 'none';
                toggleSingles.classList.add('active');
                togglePairs.classList.remove('active');
                gradeFilters.style.display = 'flex';
            } else {
                singlesView.style.display = 'none';
                pairsView.style.display = 'block';
                toggleSingles.classList.remove('active');
                togglePairs.classList.add('active');
                gradeFilters.style.display = 'none';
                if (teaPairs.length === 0) loadTeaPairs();
                updatePairsTable();
            }
        }

        function updatePairsTable() {
            const tbody = document.getElementById('pairs-table-body');
            if (!tbody || !teaPairs.length || !teas.length) return;

            // Build tea price map
            const teaMap = {};
            teas.forEach(tea => teaMap[tea.symbol] = tea);

            const changedPairs = {};

            tbody.innerHTML = teaPairs.map(pair => {
                const baseTea = teaMap[pair.base_symbol];
                const quoteTea = teaMap[pair.quote_symbol];

                if (!baseTea || !quoteTea) return '';

                const basePrice = baseTea.current_price;
                const quotePrice = quoteTea.current_price;
                const ratio = quotePrice > 0 ? basePrice / quotePrice : 0;
                const pairKey = `${pair.base_symbol}/${pair.quote_symbol}`;

                // Calculate change from previous ratio
                let changeStr = 'â€”';
                let changeClass = '';
                let flashClass = '';

                if (previousPairRatios[pairKey] !== undefined) {
                    const prevRatio = previousPairRatios[pairKey];
                    if (prevRatio !== ratio) {
                        const changePct = ((ratio - prevRatio) / prevRatio) * 100;
                        changeStr = `${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%`;
                        changeClass = changePct > 0 ? 'up' : 'down';
                        flashClass = changePct > 0 ? 'flash-up' : 'flash-down';
                    }
                }
                previousPairRatios[pairKey] = ratio;

                // Spread (price difference)
                const spread = Math.abs(basePrice - quotePrice);

                // Format symbols for display
                const baseShort = pair.base_symbol.split('-')[1] || pair.base_symbol;
                const quoteShort = pair.quote_symbol.split('-')[1] || pair.quote_symbol;

                return `
                    <tr>
                        <td>
                            <span class="pair-symbol">
                                <span class="base">${baseShort}</span>/<span class="quote">${quoteShort}</span>
                            </span>
                        </td>
                        <td class="price-cell ${flashClass}">$${basePrice.toFixed(2)}</td>
                        <td class="price-cell">$${quotePrice.toFixed(2)}</td>
                        <td><span class="pair-ratio">${ratio.toFixed(4)}</span></td>
                        <td class="${changeClass}">${changeStr}</td>
                        <td>$${spread.toFixed(2)}</td>
                        <td>
                            <button class="trade-pair-btn long" onclick="openPairsModal('${pair.id}', 'LONG')">Long</button>
                            <button class="trade-pair-btn short" onclick="openPairsModal('${pair.id}', 'SHORT')">Short</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openPairsModal(pairId, side) {
            if (!currentUser) {
                showToast('Login Required', 'Please sign in to trade pairs', true);
                return;
            }

            const pair = teaPairs.find(p => p.id === pairId);
            if (!pair) {
                showToast('Error', 'Pair not found. Please refresh the page.', true);
                return;
            }

            const teaMap = {};
            teas.forEach(tea => teaMap[tea.symbol] = tea);

            const baseTea = teaMap[pair.base_symbol];
            const quoteTea = teaMap[pair.quote_symbol];
            if (!baseTea || !quoteTea) {
                showToast('Error', 'Tea prices not available. Please refresh.', true);
                return;
            }

            const ratio = baseTea.current_price / quoteTea.current_price;
            const baseShort = pair.base_symbol.split('-')[1] || pair.base_symbol;
            const quoteShort = pair.quote_symbol.split('-')[1] || pair.quote_symbol;

            currentPairTrade = {
                pairId,
                pair,
                side,
                baseTea,
                quoteTea,
                ratio,
                baseShort,
                quoteShort
            };

            // Update modal display
            document.getElementById('pairs-modal-title').textContent = `${side} ${baseShort}/${quoteShort}`;
            document.getElementById('modal-pair-display').innerHTML = 
                `<span class="base">${baseShort}</span>/<span class="quote">${quoteShort}</span>`;
            document.getElementById('modal-ratio-display').textContent = `Ratio: ${ratio.toFixed(4)}`;

            // Reset leverage
            setLeverage(1);

            // Style confirm button
            const confirmBtn = document.getElementById('pairs-confirm-btn');
            confirmBtn.className = `confirm-btn ${side.toLowerCase()}`;
            confirmBtn.textContent = `${side} ${baseShort}/${quoteShort}`;

            updatePairsSummary();
            document.getElementById('pairs-modal').classList.add('active');
        }

        function closePairsModal() {
            document.getElementById('pairs-modal').classList.remove('active');
            currentPairTrade = null;
        }

        function setLeverage(lev) {
            selectedLeverage = lev;
            document.querySelectorAll('.leverage-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.leverage) === lev);
            });
            updatePairsSummary();
        }

        function updatePairsSummary() {
            const amount = parseFloat(document.getElementById('pairs-amount').value) || 0;
            const exposure = amount * selectedLeverage;

            document.getElementById('summary-size').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('summary-leverage').textContent = `${selectedLeverage}x`;
            document.getElementById('summary-exposure').textContent = `$${exposure.toFixed(2)}`;
            document.getElementById('summary-ratio').textContent = currentPairTrade ? 
                currentPairTrade.ratio.toFixed(4) : 'â€”';
        }

        async function executePairTrade() {
            if (!currentPairTrade || !currentUser) {
                showToast('Error', 'Trade data not available. Please try again.', true);
                return;
            }

            if (!currentPairTrade.side) {
                showToast('Error', 'Invalid trade direction. Please reopen the trade modal.', true);
                return;
            }

            const amount = parseFloat(document.getElementById('pairs-amount').value);
            if (!amount || amount < 10) {
                showToast('Invalid Amount', 'Minimum position size is $10', true);
                return;
            }

            if (amount > userProfile.cash_balance) {
                showToast('Insufficient Funds', 'Not enough cash balance', true);
                return;
            }

            try {
                // Deduct cash (margin)
                const newBalance = userProfile.cash_balance - amount;
                const { error: balanceError } = await supabaseClient
                    .from('profiles')
                    .update({ cash_balance: newBalance })
                    .eq('id', currentUser.id);
                if (balanceError) throw balanceError;

                // Record pair trade
                const { error: tradeError } = await supabaseClient
                    .from('trades')
                    .insert({
                        user_id: currentUser.id,
                        tea_id: currentPairTrade.baseTea.id,
                        side: currentPairTrade.side === 'LONG' ? 'BUY' : 'SELL',
                        quantity: amount, // Using quantity as the margin amount
                        price: currentPairTrade.ratio,
                        total_value: amount * selectedLeverage,
                        pair_id: currentPairTrade.pairId,
                        leverage: selectedLeverage,
                        is_pair_trade: true
                    });
                if (tradeError) throw tradeError;

                userProfile.cash_balance = newBalance;
                
                // Save values before closing modal (which nulls currentPairTrade)
                const tradeInfo = {
                    side: currentPairTrade.side,
                    baseShort: currentPairTrade.baseShort,
                    quoteShort: currentPairTrade.quoteShort,
                    ratio: currentPairTrade.ratio
                };
                
                closePairsModal();
                
                const exposure = amount * selectedLeverage;
                showToast('Pair Trade Executed!', 
                    `${tradeInfo.side} ${tradeInfo.baseShort}/${tradeInfo.quoteShort} @ ${tradeInfo.ratio.toFixed(4)} with ${selectedLeverage}x leverage ($${exposure.toFixed(2)} exposure)`);

                await loadUserTrades();
                await loadPositions();
                updatePortfolioDisplay();

            } catch (error) {
                console.error('Pair trade failed:', error);
                showToast('Trade Failed', error.message, true);
            }
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================

        function showToast(title, message, isError = false) {
            const toast = document.getElementById('trade-toast');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('visible');

            setTimeout(() => {
                toast.classList.remove('visible');
            }, 4000);
        }

        // Refresh data periodically
        setInterval(async () => {
            await loadTeas();
            if (currentUser) {
                await loadPositions();
                updatePortfolioDisplay();
            }
            await loadLeaderboard();
        }, 30000); // Every 30 seconds

    </script>
</body>
</html>
